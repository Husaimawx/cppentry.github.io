---
layout:     post
title:      hbase 备份及恢复
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<p><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;"><span style="font-size:14px;line-height:25.200000762939453px;">转载地址： http://lifei0327.iteye.com/blog/1249515</span></span></p>
<p><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><br></span></p>
<p><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">1, hbase自带的备份恢复工具</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span></p>
<span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">hbase org.apache.hadoop.hbase.mapreduce.Export 'table1' /home/fred/table1 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">hbase org.apache.hadoop.hbase.mapreduce.Import 'table1' /home/fred/table1 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">导入时必须先创建表结构。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><a href="http://www.iteye.com/topic/1114721" rel="nofollow" style="color:rgb(16,138,198);font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">http://www.iteye.com/topic/1114721</a><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><div class="dp-highlighter" style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;width:679px;overflow:auto;margin-left:9px;line-height:25.200000762939453px;">
<div class="bar">
<div class="tools" style="font-weight:bold;">Java代码  <a title="收藏这段代码" style="color:rgb(16,138,198);text-decoration:underline;"><img class="star" src="http://lifei0327.iteye.com/images/icon_star.png" alt="收藏代码" style="border:0px;"></a></div>
</div>
<ol start="1" class="dp-j" style="font-size:1em;line-height:1.4em;border:1px solid rgb(209,215,220);color:rgb(43,145,175);"><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;"><span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">import</span> time    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;"><span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">import</span> datetime    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">from datetime <span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">import</span> date    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;"><span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">import</span> sys    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;"><span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">import</span> os    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">tablename=sys.argv[<span class="number" style="color:rgb(192,0,0);">1</span>]    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">backupDst=sys.argv[<span class="number" style="color:rgb(192,0,0);">2</span>]    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">today=date.today()    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;"><span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">if</span> today.day == <span class="number" style="color:rgb(192,0,0);">15</span>:    <span class="comment" style="color:rgb(0,130,0);border:0px;">//every month, we do a full backup  </span>  </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">        backupSubFolder=backupDst+today.isoformat()+<span class="string" style="color:#0000FF;">"-full"</span>    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">        cmd=<span class="string" style="color:#0000FF;">"hbase org.apache.hadoop.hbase.mapreduce.Export %s %s"</span>%(tablename,backupSubFolder)    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;"><span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">else</span>:    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">        yesterday=datetime.date.today()- datetime.timedelta(days=<span class="number" style="color:rgb(192,0,0);">1</span>)    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">        todayTimeStamp=time.mktime(today.timetuple())    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">        yesTimeStamp=time.mktime(yesterday.timetuple())    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">        backupSubFolder=backupDst+today.isoformat()    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">        cmd=<span class="string" style="color:#0000FF;">"hbase org.apache.hadoop.hbase.mapreduce.Export %s %s %s"</span>%(tablename,backupSubFolder,str(<span class="keyword" style="color:rgb(127,0,85);font-weight:bold;">int</span>(todayTimeStamp)*<span class="number" style="color:rgb(192,0,0);">1000</span>)    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">print cmd    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">    </span></li><li style="font-size:1em;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209,215,220);background-color:rgb(250,250,250);line-height:18px;">
<span style="color:#000000;">os.system(cmd)    </span></li></ol></div>
<br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">2, 把某个表(table1)从集群1迁移到集群2（两个集群互相看不见），步骤如下</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">  1、拷贝集群1的表文件到本地磁盘，拷贝之前要停掉集群1的hbase服务，否则会丢失数据 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">hadoop fs -copyToLocal /hbase/table1 /home/fred/hb_bak/table1 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">  2、对于文件操作，很简单吧，随便你怎么去拷贝来拷贝去 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">  3、如果集群2中也有对应的表文件，那么删除掉，然后拷贝  </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">hadoop fs -rmr /hbase/table1  </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">hadoop fs -copyFromLocal /home/fred/hb_bak/table1 /hbase/table1  </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">  4、到hbase的bin目录下，重置该表在.META.表中的分区信息 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">hbase org.jruby.Main add_table.rb /hbase/table1  </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">  5、重启hbase使表的重置信息生效，切忌强制停掉hbase服务，否侧损坏数据 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">另外： </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">  1、如果表的数据量过大呢？ 那么按照该表在HDFS中的文件夹数据，分批拷贝。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">  2、如果两个集群可以互相通信呢？那么更爽了，直接使用distcp对拷，是并行的。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">3, HBase Backup Options</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><a href="http://hbase.info/tag/distcp" rel="nofollow" style="color:rgb(16,138,198);font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">http://hbase.info/tag/distcp</a><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">如果你打算部署HBase，那么你一定要考虑如何备份的问题，下面是作者列举的他所知道的一些备份方式，如果有遗漏的，欢迎补充。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">Export</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">HBase提供了export的MapReduce Job(org.apache.hadoop.hbase.mapreduce.Export)可以将表导出为HDFS的顺序文件(SequenceFile)，这是由HBASE-1684贡献的工具。此工具一次只能操作一张表，导出的顺序文件可以通过Import工具导入HBase。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">Copy Table</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">在两个HBase集群之间复制数据，也可以通过Copy Table工具，这也是MapReduce实现的，一次操作一张表。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">Distcp</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">你也可以利用HDFS的Distcp工具将整个/hbase复制到另外一个HDFS集群，但如果这可能导致复制的数据不一致，所以尽量不要这么做，除非先将源集群停止服务，参考： http://search-hadoop.com/m/wkMgSjVLDb </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">Backup from Mozilla</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">由于Dictcp做集群复制存在数据不一致的问题，Mozilla的开发人员开发了一个Backup工具，具体情况请参考他们的这篇Migrating HBase in the Trenches。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">Cluster Replication</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">HBase从0.89版本开始引入集群复制功能，所以我们也可以利用此功能将数据备份到另一个集群。复制的目标集群不需要和源集群同配置，因此可以将数据通过复制备份到一个较低成本的集群中。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">Table Snapshot</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">在著名的HBase-50中就提出了Snapshot的问题，尽管在GSoC 2010期间做了大量的工作，但不知由于什么原因，一直没有合并进HBase的主流分支。Jira上已经有一个Patch，但已经较长时间无进展了。 </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">HDFS Replication</span><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"> </span><br style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;"><span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:25.200000762939453px;">HDFS中的数据是有多份拷贝的，你也可以把这多份的拷贝当作一种备份，它虽然不能防止数据损坏，但能容忍部分硬件故障。</span>
            </div>
                </div>
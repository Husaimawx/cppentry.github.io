---
layout:     post
title:      hive与hbase数据交互的详解指南
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <div class="article_content clearfix csdn-tracking-statistics" style="padding:0px;margin:0px;"><div class="htmledit_views" style="padding:0px;margin-bottom:0px;"><div class="BlogAnchor" style="padding:0px;margin:0px;"><p><span class="corner" title="点击收起目录">目录[-]</span></p><div class="AnchorContent" style="padding:0px;margin:0px;"><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_1" rel="nofollow">HBase和Hive的集成原理</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_2" rel="nofollow">1.文章来源：</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_3" rel="nofollow">2.基本介绍</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_4" rel="nofollow">3.软件版本</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_5" rel="nofollow">4.安装位置</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_6" rel="nofollow">5.整合步骤</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_7" rel="nofollow">1.在 /usr/local/hbase-0.90.4下：</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_8" rel="nofollow">2.修改hive-site.xml文件</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_9" rel="nofollow">6.测试hive到hbase中</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_10" rel="nofollow">1.  用hive创建hbase能识别的表</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_11" rel="nofollow">2.  导入数据到关联hbase的表中去</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h3_12" rel="nofollow">1.在hive中新建一张中间表</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h3_13" rel="nofollow">2.插入数据到hbase表中去</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h3_14" rel="nofollow">3.查看关联hbase的那张表</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h3_15" rel="nofollow">4.登录hbase查看那张表的数据</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_16" rel="nofollow">7.测试hbase到hive中</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_17" rel="nofollow">1.在hbase中创建表</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_18" rel="nofollow">2.把hbase中的表关联到hive中</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_19" rel="nofollow">2.检查test1中的数据</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_20" rel="nofollow">报错：</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_21" rel="nofollow">Hive报错</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h2_22" rel="nofollow">Hbase 报错</a><a href="http://my.oschina.net/repine/blog/285015#OSC_h1_23" rel="nofollow">测试脚本</a></div></div><span></span><h1 style="padding:0px;"><a></a><span style="font-family:'微软雅黑', sans-serif;line-height:52.8px;font-size:22px;font-weight:normal;">HBase</span><span style="font-family:'微软雅黑', sans-serif;line-height:52.8px;font-size:22px;font-weight:normal;">和Hive的集成原理</span></h1><p style="background:rgb(255,255,255);"><span style="font-family:'微软雅黑', sans-serif;color:rgb(51,51,51);font-size:13px;">Hive</span><span style="font-family:'微软雅黑', sans-serif;color:rgb(51,51,51);font-size:13px;">和Hbase有各自不同的特征：hive是高延迟、结构化和面向分析的，hbase是低延迟、非结构化和面向编程的。Hive数据仓库在hadoop上是高延迟的。Hive集成Hbase就是为了使用hbase的一些特性。如下是hive和hbase的集成架构：</span></p><p style="background:rgb(255,255,255);"><a href="http://static.oschina.net/uploads/space/2014/0628/180204_C3tU_1439326.jpg" rel="nofollow"><img src="http://static.oschina.net/uploads/space/2014/0628/180204_C3tU_1439326.jpg" alt=""></a></p><p style="background:rgb(255,255,255);"><span style="font-family:'微软雅黑', sans-serif;color:rgb(51,51,51);font-size:13px;">图1 hive和hbase架构图</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'微软雅黑', sans-serif;color:rgb(51,51,51);font-size:13px;">        Hive</span><span style="font-family:'微软雅黑', sans-serif;color:rgb(51,51,51);font-size:13px;">集成HBase可以有效利用HBase数据库的存储特性，如行更新和列索引等。在集成的过程中注意维持HBase jar包的一致性。Hive集成HBase需要在Hive表和HBase表之间建立映射关系，也就是Hive表的列(columns)和列类型(column types)与HBase表的列族(column families)及列限定词(column qualifiers)建立关联。每一个在Hive表中的域都存在于HBase中，而在Hive表中不需要包含所有HBase中的列。HBase中的RowKey对应到Hive中为选择一个域使用:key来对应，列族(cf:)映射到Hive中的其它所有域，列为(cf:cq)。例如下图2为Hive表映射到HBase表：</span></p><p style="background:rgb(255,255,255);"><a href="http://static.oschina.net/uploads/space/2014/0628/180219_hmZG_1439326.jpg" rel="nofollow"><img src="http://static.oschina.net/uploads/space/2014/0628/180219_hmZG_1439326.jpg" alt=""></a></p><p style="background:rgb(255,255,255);"><span style="font-family:'微软雅黑', sans-serif;color:rgb(51,51,51);font-size:13px;">图2 Hive表映射HBase表</span></p><p> </p><span></span><h1 style="padding:0px;"><a></a>1.<span style="font-family:'宋体';">文章来源：</span></h1><p style="background:rgb(255,255,255);"><a href="http://blog.csdn.net/jiedushi/article/details/7325292" rel="nofollow">http://blog.csdn.net/jiedushi/article/details/7325292</a></p><p style="background:rgb(255,255,255);"><a href="http://www.cr173.com/html/24339_1.html" rel="nofollow">http://www.cr173.com/html/24339_1.html</a></p><span></span><h1 style="padding:0px;"><a></a>2.<span style="font-family:'宋体';">基本介绍</span></h1><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">Hive</span><span style="font-family:'宋体';color:rgb(51,51,51);">是基于</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">Hadoop</span><span style="font-family:'宋体';color:rgb(51,51,51);">的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供完整的</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">sql</span><span style="font-family:'宋体';color:rgb(51,51,51);">查询功能，可以将</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">sql</span><span style="font-family:'宋体';color:rgb(51,51,51);">语句转换为</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">MapReduce</span><span style="font-family:'宋体';color:rgb(51,51,51);">任务进行运行。</span> <span style="font-family:'宋体';color:rgb(51,51,51);">其优点是学习成本低，可以通过类</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">SQL</span><span style="font-family:'宋体';color:rgb(51,51,51);">语句快速实现简单的</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">MapReduce</span><span style="font-family:'宋体';color:rgb(51,51,51);">统计，不必开发专门的</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">MapReduce</span><span style="font-family:'宋体';color:rgb(51,51,51);">应用，十分适合数据仓库的统计分析。</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);"><br>Hive</span><span style="font-family:'宋体';color:rgb(51,51,51);">与</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">HBase</span><span style="font-family:'宋体';color:rgb(51,51,51);">的整合功能的实现是利用两者本身对外的</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">API</span><span style="font-family:'宋体';color:rgb(51,51,51);">接口互相进行通信，相互通信主要是依靠</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);">hive_hbase-handler.jar</span><span style="font-family:'宋体';color:rgb(51,51,51);">工具类，</span> <span style="font-family:'宋体';color:rgb(51,51,51);">大致意思如图所示：</span></p><p style="background:rgb(255,255,255);"><a href="http://static.oschina.net/uploads/space/2014/0628/180235_rMG6_1439326.jpg" rel="nofollow"><img src="http://static.oschina.net/uploads/space/2014/0628/180235_rMG6_1439326.jpg" alt=""></a></p><span></span><h1 style="padding:0px;"><a></a>3.<span style="font-family:'宋体';">软件版本</span></h1><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">使用的软件版本：（没有下载地址的百度中找就行）</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">jdk-6u24-linux-i586.bin    </span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">hive-0.9.0.tar.gz           <a href="http://yun.baidu.com/share/link?shareid=2138315647&amp;uk=1614030671" rel="nofollow">http://yun.baidu.com/share/link?shareid=2138315647&amp;uk=1614030671</a></span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">hbase-0.94.14.tar.gz    </span><a href="http://mirror.bit.edu.cn/apache/hbase/hbase-0.94.14/" rel="nofollow">http://mirror.bit.edu.cn/apache/hbase/hbase-0.94.14/</a></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">hadoop-1.1.2.tar.gz      <span style="color:rgb(51,51,51);line-height:22px;"><a href="http://pan.baidu.com/s/1mgmKfsG" rel="nofollow">http://pan.baidu.com/s/1mgmKfsG</a></span></span></p><span></span><h1 style="padding:0px;"><a></a>4.<span style="font-family:'宋体';">安装位置</span></h1><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">安装目录：</span><span style="font-family:Arial, sans-serif;">/usr/local/     </span><span style="font-family:'宋体';">（记得解压后重命名一下哦）</span><span style="font-family:Arial, sans-serif;"><br>Hbase</span><span style="font-family:'宋体';">的安装路径为：</span><span style="font-family:Arial, sans-serif;">/usr/local/hbase</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;"> Hive</span><span style="font-family:'宋体';">的安装路径为：</span><span style="font-family:Arial, sans-serif;">/usr/local/hive</span></p><span></span><h1 style="padding:0px;"><a></a>5.<span style="font-family:'宋体';">整合步骤</span></h1><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">整合</span><span style="font-family:Arial, sans-serif;">hive</span><span style="font-family:'宋体';">与</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">的过程如下：</span></p><span></span><h2 style="padding:0px;"><a></a>1.<span style="font-family:'宋体';">在</span> /usr/local/hbase-0.90.4<span style="font-family:'宋体';">下：</span></h2><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">hbase-0.94.14.jar</span><span style="font-family:'宋体';">，</span><span style="font-family:Arial, sans-serif;">hbase-0.94.14-tests.jar </span><span style="font-family:'宋体';">与</span><span style="font-family:Arial, sans-serif;">lib/zookeeper-3.4.5.jar</span><span style="font-family:'宋体';">拷贝到</span><span style="font-family:Arial, sans-serif;">/usr/local /hive/lib</span><span style="font-family:'宋体';">文件夹下面</span><span style="font-family:Arial, sans-serif;"><br></span><span style="font-family:'宋体';">注意：</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">如果</span><span style="font-family:Arial, sans-serif;">hive/lib</span><span style="font-family:'宋体';">下已经存在这两个文件的其他版本（例如</span><span style="font-family:Arial, sans-serif;">zookeeper-3.3.1.jar</span><span style="font-family:'宋体';">）</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">建议删除后使用</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">下的相关版本</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">还需要</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">protobuf-java-2.4.0a.jar</span><span style="font-family:'宋体';">拷贝到</span><span style="font-family:Arial, sans-serif;">/usr/local/hive/lib</span><span style="font-family:'宋体';">和</span><span style="font-family:Arial, sans-serif;">/usr/local/hadoop/lib</span><span style="font-family:'宋体';">下</span></p><span></span><h2 style="padding:0px;"><a></a>2.<span style="font-family:'宋体';">修改</span>hive-site.xml<span style="font-family:'宋体';">文件</span></h2><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">在</span><span style="font-family:Arial, sans-serif;">/usr/local/hive/conf</span><span style="font-family:'宋体';">下目录下，在</span><span style="font-family:Arial, sans-serif;">hive-site.xml</span><span style="font-family:'宋体';">最底部添加如下内容：</span></p><pre style="padding-right:0px;padding-left:0px;font-size:14px;line-height:22px;"><span style="font-family:Arial, sans-serif;background:rgb(255,255,0);">(</span><span style="background:rgb(255,255,0);">跳转到最下面的</span><span style="font-family:Arial, sans-serif;background:rgb(255,255,0);">linux</span><span style="background:rgb(255,255,0);">命令：按住</span><span style="font-family:Arial, sans-serif;background:rgb(255,255,0);">Esc</span><span style="background:rgb(255,255,0);">键</span><span style="font-family:Arial, sans-serif;background:rgb(255,255,0);"> + </span><span style="background:rgb(255,255,0);">冒号</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);background:rgb(255,255,0);"> + $  </span><span style="color:rgb(51,51,51);background:rgb(255,255,0);">然后回车</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,51);background:rgb(255,255,0);">)</span><span style="font-family:Arial, sans-serif;"> &lt;property&gt;
 &lt;name&gt;hive.querylog.location&lt;/name&gt;
 &lt;value&gt;/usr/local/hive/logs&lt;/value&gt;
 &lt;/property&gt;
 &lt;property&gt;
 &lt;name&gt;hive.aux.jars.path&lt;/name&gt; </span></pre><pre style="padding-right:0px;padding-left:0px;font-size:14px;line-height:22px;">注意：如果不存在则自行创建，或者把文件改名后使用。拷贝到所有节点包括的下。拷贝下的文件到所有节点包括的下。</pre><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';color:rgb(255,0,0);">注意，如果</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">3,4</span><span style="font-family:'宋体';color:rgb(255,0,0);">两步跳过的话，运行</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hive</span><span style="font-family:'宋体';color:rgb(255,0,0);">时很可能出现如下错误：</span><span style="font-family:Arial, sans-serif;"><br>org.apache.hadoop.hbase.ZooKeeperConnectionException: HBase is able to connect to ZooKeeper but the connection closes immediately.<br>This could be a sign that the server has too many connections (30 is the default). Consider inspecting your ZK server logs for that error and<br>then make sure you are reusing HBaseConfiguration as often as you can. See HTable's javadoc for more information. at org.apache.hadoop.<br>hbase.zookeeper.ZooKeeperWatcher.</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">5 </span><span style="font-family:'宋体';">启动</span><span style="font-family:Arial, sans-serif;">hive </span><span style="font-family:'宋体';background:rgb(255,255,0);">（测试成功）</span><span style="font-family:Arial, sans-serif;"><br></span><span style="font-family:'宋体';">单节点启动</span><span style="font-family:Arial, sans-serif;"><br><a></a>bin/hive -hiveconf hbase.master=master:60000<br></span><span style="font-family:'宋体';">集群启动</span><span style="font-family:Arial, sans-serif;">   <span style="background:rgb(255,255,0);">(</span></span><span style="font-family:'宋体';background:rgb(255,255,0);">这个我没测试</span><span style="font-family:Arial, sans-serif;background:rgb(255,255,0);">)</span><span style="font-family:Arial, sans-serif;"><br>bin/hive -hiveconf hbase.zookeeper.quorum=node1,node2,node3   (</span><span style="font-family:'宋体';color:rgb(255,0,0);">所有的</span><span style="font-family:Helvetica, sans-serif;color:rgb(255,0,0);">zookeeper</span><span style="font-family:'宋体';color:rgb(255,0,0);">节点</span><span style="font-family:Arial, sans-serif;">)<br></span><span style="font-family:'宋体';">如果</span><span style="font-family:Arial, sans-serif;">hive-site.xml</span><span style="font-family:'宋体';">文件中没有配置</span><span style="font-family:Arial, sans-serif;">hive.aux.jars.path</span><span style="font-family:'宋体';">，则可以按照如下方式启动。</span><span style="font-family:Arial, sans-serif;"><br>hive --auxpath /opt/mapr/hive/hive-0.7.1/lib/hive-hbase-handler-0.7.1.jar,/opt/mapr/hive/hive-0.7.1/lib/hbase-0.90.4.jar,/opt/mapr/hive/hive-0.7.1/lib/zookeeper-3.3.2.jar -hiveconf hbase.master=localhost:60000</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';color:rgb(51,51,255);">经测试修改</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,255);">hive</span><span style="font-family:'宋体';color:rgb(51,51,255);">的配置文件</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,255);">hive-site.xml</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;color:rgb(51,51,255);">&lt;property&gt;<br>  &lt;name&gt;hive.zookeeper.quorum&lt;/name&gt;<br>  &lt;value&gt;node1,node2,node3&lt;/value&gt;<br>  &lt;description&gt;The list of zookeeper servers to talk to. This is only needed for read/write locks.&lt;/description&gt;<br>&lt;/property&gt;</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';color:rgb(51,51,255);">不用增加参数启动</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,255);">hive</span><span style="font-family:'宋体';color:rgb(51,51,255);">就可以联合</span><span style="font-family:Arial, sans-serif;color:rgb(51,51,255);">hbase</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;"> </span></p><span></span><h1 style="padding:0px;"><a></a>6.<span style="font-family:'宋体';">测试</span>hive<span style="font-family:'宋体';">到</span>hbase<span style="font-family:'宋体';">中</span></h1><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">启动后进行测试（重启一下集群）</span></p><span></span><h2 style="padding:0px;"><a></a>1.<span style="font-family:'Times New Roman';font-size:9px;font-weight:normal;">  </span><span style="font-family:'宋体';">用</span>hive<span style="font-family:'宋体';">创建</span>hbase<span style="font-family:'宋体';">能识别的表</span></h2><p><span style="font-family:'宋体';">语句如下：</span></p><p style="background:rgb(255,255,255);"><a></a><a></a><span style="font-family:Arial, sans-serif;">create table hbase_table_1(key int, value string)</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">stored by 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">with serdeproperties ("hbase.columns.mapping" = "</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">:key</span><span style="font-family:Arial, sans-serif;">,cf1:val")</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">tblproperties ("hbase.table.name" = "xyz");</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">此刻你进入</span><span style="font-family:Arial, sans-serif;">hbase shell</span><span style="font-family:'宋体';">中发现多了一张表</span><span style="font-family:Arial, sans-serif;"> ‘xyz’<br></span><span style="font-family:'宋体';">（<span style="background:rgb(255,255,0);">可以先跳过这句话</span>：</span><span style="font-family:Arial, sans-serif;">hbase.table.name </span><span style="font-family:'宋体';">定义在</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">的</span><span style="font-family:Arial, sans-serif;">table</span><span style="font-family:'宋体';">名称，</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">多列时：</span><span style="font-family:Arial, sans-serif;">data:1</span><span style="font-family:'宋体';">，</span><span style="font-family:Arial, sans-serif;">data:2</span><span style="font-family:'宋体';">；多列族时：</span><span style="font-family:Arial, sans-serif;">data1:1,data2:1</span><span style="font-family:'宋体';">；）</span><span style="font-family:Arial, sans-serif;"><br></span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hbase.columns.mapping </span><span style="font-family:'宋体';color:rgb(255,0,0);">定义在</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hbase</span><span style="font-family:'宋体';color:rgb(255,0,0);">的列族，里面的</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">:key </span><span style="font-family:'宋体';color:rgb(255,0,0);">是固定值而且要保证在表</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">pokes</span><span style="font-family:'宋体';color:rgb(255,0,0);">中的</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">foo</span><span style="font-family:'宋体';color:rgb(255,0,0);">字段是唯一值</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">创建有分区的表</span><span style="font-family:Arial, sans-serif;"></span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">create table hbase_table_1(key int, value string) </span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">partitioned by (day string)</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">stored by 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">with serdeproperties ("hbase.columns.mapping" = ":key,cf1:val")</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">tblproperties ("hbase.table.name" = "xyz");</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';color:rgb(255,0,0);">不支持表的修改</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);"><br></span><span style="font-family:'宋体';color:rgb(255,0,0);">会提示不能修改非本地表。</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);"><br>hive&gt; ALTER TABLE hbase_table_1 ADD PARTITION (day = '2012-09-22');<br>FAILED: Error in metadata: Cannot use ALTER TABLE on a non-native table FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask </span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;"> </span></p><span></span><h2 style="padding:0px;"><a></a>2.<span style="font-family:'Times New Roman';font-size:9px;font-weight:normal;">  </span><span style="font-family:'宋体';">导入数据到关联</span>hbase<span style="font-family:'宋体';">的表中去</span></h2><span></span><h3 style="padding:0px;"><a></a>1.<span style="font-family:'宋体';">在</span>hive<span style="font-family:'宋体';">中新建一张中间表</span></h3><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">create table pokes(foo int,bar string)</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">row format delimited fields terminated by ',';<br></span><span style="font-family:'宋体';">批量导入数据</span><span style="font-family:Arial, sans-serif;"><br>load data local inpath '/home/1.txt' overwrite into table pokes;</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">1.txt</span><span style="font-family:'宋体';">文件的内容为</span><span style="font-family:Arial, sans-serif;"> <br>1,hello <br>2,pear <br>3,world</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">使用</span><span style="font-family:Arial, sans-serif;">sql</span><span style="font-family:'宋体';">导入</span><span style="font-family:Arial, sans-serif;">hbase_table_1</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:13px;">set hive.hbase.bulk=true;</span></p><span></span><h3 style="padding:0px;"><a></a>2.<span style="font-family:'宋体';">插入数据到</span>hbase<span style="font-family:'宋体';">表中去</span></h3><p><span style="font-family:Arial, sans-serif;background:rgb(255,255,255);">insert overwrite table hbase_table_1</span></p><p><span style="font-family:Arial, sans-serif;background:rgb(255,255,255);">select * from pokes;</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">导入有分区的表</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">insert overwrite table hbase_table_1  partition (day='2012-01-01') </span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">select * from pokes;</span></p><span></span><h3 style="padding:0px;"><a></a>3.<span style="font-family:'宋体';">查看关联</span>hbase<span style="font-family:'宋体';">的那张表</span></h3><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">hive&gt; select * from hbase_table_1;<br>OK<br>1 hello<br>2 pear<br>3 world</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">(</span><span style="font-family:'宋体';color:rgb(255,0,0);">注：与</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hbase</span><span style="font-family:'宋体';color:rgb(255,0,0);">整合的有分区的表存在个问题</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">  select * from table</span><span style="font-family:'宋体';color:rgb(255,0,0);">查询不到数据，</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">select key,value from table</span><span style="font-family:'宋体';color:rgb(255,0,0);">可以查到数据</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">)</span></p><span></span><h3 style="padding:0px;"><a></a>4.<span style="font-family:'宋体';">登录</span>hbase<span style="font-family:'宋体';">查看那张表的数据</span></h3><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">hbase shell</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">hbase(main):002:0&gt; describe 'xyz' <br>DESCRIPTION ENABLED {NAME =&gt; 'xyz', FAMILIES =&gt; [{NAME =&gt; 'cf1', BLOOMFILTER =&gt; 'NONE', REPLICATION_S true <br>COPE =&gt; '0', COMPRESSION =&gt; 'NONE', VERSIONS =&gt; '3', TTL =&gt; '2147483647', BLOCKSI <br>ZE =&gt; '65536', IN_MEMORY =&gt; 'false', BLOCKCACHE =&gt; 'true'}]} <br>1 row(s) in 0.0830 seconds<br>hbase(main):003:0&gt; scan 'xyz'<br>ROW COLUMN+CELL <br>1 column=cf1:val, timestamp=1331002501432, value=hello <br>2 column=cf1:val, timestamp=1331002501432, value=pear <br>3 column=cf1:val, timestamp=1331002501432, value=world</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">这时在</span><span style="font-family:Arial, sans-serif;">Hbase</span><span style="font-family:'宋体';">中可以看到刚才在</span><span style="font-family:Arial, sans-serif;">hive</span><span style="font-family:'宋体';">中插入的数据了。</span></p><span></span><h1 style="padding:0px;"><a></a>7.<span style="font-family:'宋体';">测试</span>hbase<span style="font-family:'宋体';">到</span>hive<span style="font-family:'宋体';">中</span></h1><span></span><h2 style="padding:0px;"><a></a>1.<span style="font-family:'宋体';">在</span>hbase<span style="font-family:'宋体';">中创建表</span></h2><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">create 'test1','a','b','c'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">put 'test1','1','a','qqq'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">put 'test1','1','b','aaa'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">put 'test1','1','c','bbb'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">put 'test1','2','a','qqq'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">put 'test1','2','c','bbb'</span></p><span></span><h2 style="padding:0px;"><a></a>2.<span style="font-family:'宋体';">把</span>hbase<span style="font-family:'宋体';">中的表关联到</span>hive<span style="font-family:'宋体';">中</span></h2><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">对于在</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">已经存在的表，在</span><span style="font-family:Arial, sans-serif;">hive</span><span style="font-family:'宋体';">中使用</span><span style="font-family:Arial, sans-serif;">CREATE EXTERNAL TABLE</span><span style="font-family:'宋体';">来建立</span><span style="font-family:Arial, sans-serif;"><br></span><span style="font-family:'宋体';">例如</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">中的表名称为</span><span style="font-family:Arial, sans-serif;">test1,</span><span style="font-family:'宋体';">字段为</span><span style="font-family:Arial, sans-serif;"> a: , b: ,c: </span><span style="font-family:'宋体';">在</span><span style="font-family:Arial, sans-serif;">hive</span><span style="font-family:'宋体';">中建表语句为</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">create external table hive_test</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">(key int,gid map&lt;string,string&gt;,sid map&lt;string,string&gt;,uid map&lt;string,string&gt;)</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">stored by 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">with serdeproperties ("hbase.columns.mapping" ="a:,b:,c:") </span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">tblproperties  ("hbase.table.name" = "test1");</span></p><span></span><h2 style="padding:0px;"><a></a>2.<span style="font-family:'宋体';">检查</span>test1<span style="font-family:'宋体';">中的数据</span></h2><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">在</span><span style="font-family:Arial, sans-serif;">hive</span><span style="font-family:'宋体';">中建立好表后，查询</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">中</span><span style="font-family:Arial, sans-serif;">test1</span><span style="font-family:'宋体';">表内容</span><span style="font-family:Arial, sans-serif;"><br>select * from hive_test;</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">OK<br>1 {"":"qqq"} {"":"aaa"} {"":"bbb"}<br>2 {"":"qqq"} {} {"":"bbb"}</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">查询</span><span style="font-family:Arial, sans-serif;">gid</span><span style="font-family:'宋体';">字段中</span><span style="font-family:Arial, sans-serif;">value</span><span style="font-family:'宋体';">值的方法为</span><span style="font-family:Arial, sans-serif;"><br>select gid[''] from hive_test;<br></span><span style="font-family:'宋体';">得到查询结果</span><span style="font-family:Arial, sans-serif;"><br>Total MapReduce jobs = 1<br>Launching Job 1 out of 1<br>Number of reduce tasks is set to 0 since there's no reduce operator<br>Starting Job = job_201203052222_0017, Tracking URL = </span><a href="http://dataflow.qyops.com:50030/jobdetails.jsp?jobid=job_201203052222_0017" rel="nofollow"><span style="font-family:Arial, sans-serif;color:rgb(42,86,133);">http://localhost:50030/jobdetails.jsp?jobid=job_201203052222_0017</span></a><span style="font-family:Arial, sans-serif;"><br>Kill Command = /opt/mapr/hadoop/hadoop-0.20.2/bin/../bin/hadoop job -Dmapred.job.tracker=maprfs:/// -kill job_201203052222_0017<br>2012-03-06 14:38:29,141 Stage-1 map = 0%, reduce = 0%<br>2012-03-06 14:38:33,171 Stage-1 map = 100%, reduce = 100%<br>Ended Job = job_201203052222_0017<br>OK<br>qqq<br>qqq</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">如果</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">表</span><span style="font-family:Arial, sans-serif;">test1</span><span style="font-family:'宋体';">中的字段为</span><span style="font-family:Arial, sans-serif;">user:gid,user:sid,info:uid,info:level</span><span style="font-family:'宋体';">，在</span><span style="font-family:Arial, sans-serif;">hive</span><span style="font-family:'宋体';">中建表语句为</span><span style="font-family:Arial, sans-serif;"><br>create external table hive_test</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">(key int,user map&lt;string,string&gt;,info map&lt;string,string&gt;)</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">stored by 'org.apache.hadoop.hive.hbase.hbasestoragehandler'</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">with serdeproperties ("hbase.columns.mapping" ="user:,info:") </span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;">tblproperties  ("hbase.table.name" = "test1");</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';">查询</span><span style="font-family:Arial, sans-serif;">hbase</span><span style="font-family:'宋体';">表的方法为</span><span style="font-family:Arial, sans-serif;"><br>select user['gid'] from hive_test;</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);"> </span><span style="font-family:'宋体';color:rgb(255,0,0);">注：</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hive</span><span style="font-family:'宋体';color:rgb(255,0,0);">连接</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hbase</span><span style="font-family:'宋体';color:rgb(255,0,0);">优化，将</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">HADOOP_HOME/conf</span><span style="font-family:'宋体';color:rgb(255,0,0);">中的</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hbase-site.xml</span><span style="font-family:'宋体';color:rgb(255,0,0);">文件中增加配置</span></p><p style="background:rgb(255,255,255);"><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);"> &lt;property&gt;<br>   &lt;name&gt;hbase.client.scanner.caching&lt;/name&gt;<br>   &lt;value&gt;10000&lt;/value&gt;<br> &lt;/property&gt;</span></p><p style="background:rgb(255,255,255);"><span style="font-family:'宋体';color:rgb(255,0,0);">或者在执行</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hive</span><span style="font-family:'宋体';color:rgb(255,0,0);">语句之前执行</span><span style="font-family:Arial, sans-serif;color:rgb(255,0,0);">hive&gt;set hbase.client.scanner.caching=10000;</span></p><span></span><h1 style="padding:0px;"><a></a><span style="font-family:'宋体';">报错：</span></h1><span></span><h2 style="padding:0px;"><a></a>Hive<span style="font-family:'宋体';">报错</span></h2><p><span style="font-family:Tahoma, sans-serif;font-size:18px;">1.NoClassDefFoundError</span><span style="font-family:Tahoma, sans-serif;"><br>Could not initialize class java.lang.NoClassDefFoundError: Could not initialize class org.apache.hadoop.hbase.io.HbaseObjectWritable<br></span><span style="font-family:'宋体';">将</span><span style="font-family:Tahoma, sans-serif;">protobuf-***.jar</span><span style="font-family:'宋体';">添加到</span><span style="font-family:Tahoma, sans-serif;">jars</span><span style="font-family:'宋体';">路径</span><span style="font-family:Tahoma, sans-serif;"><br><br></span></p><p><span style="font-family:'宋体';">//$HIVE_HOME/conf/hive-site.xml</span></p><p><span style="font-family:'宋体';">&lt;property&gt;</span></p><p><span style="font-family:'宋体';">   &lt;name&gt;hive.aux.jars.path&lt;/name&gt;</span></p><p><span style="font-family:'宋体';">   &lt;value&gt;file:///data/hadoop/hive-0.10.0/lib/hive-hbase-handler-0.10.0.jar,file:///data/hadoop/hive-0.10.0/lib/hbase-0.94.8.jar,file:///data/hadoop/hive-0.10.0/lib/zookeeper-3.4.5.jar,file:///data/hadoop/hive-0.10.0/lib/guava-r09.jar,file:///data/hadoop/hive-0.10.0/lib/hive-contrib-0.10.0.jar,file:///data/hadoop/hive-0.10.0/lib/protobuf-java-2.4.0a.jar&lt;/value&gt;</span></p><p><span style="font-family:'宋体';">&lt;/property&gt;</span></p><p> </p><p> </p><span></span><h2 style="padding:0px;"><a></a>Hbase <span style="font-family:'宋体';">报错</span></h2><p><span style="font-weight:700;"><span style="font-size:19px;">:java.lang.NoClassDefFoundError: com/google/protobuf/Message</span><span style="font-size:19px;">  </span></span></p><p><span style="font-family:'宋体';">编个</span>Hbase<span style="font-family:'宋体';">程序，系统提示错误，</span>java.lang.NoClassDefFoundError: com/google/protobuf/Message</p><p><span style="font-family:'宋体';">找了半天，从这个地方发现了些东西：</span>http://abloz.com/2012/06/15/hive-execution-hbase-create-the-table-can-not-find-protobuf.html</p><p> </p><p><span style="font-family:'宋体';">内容如下：</span></p><p>hadoop:1.0.3</p><p>hive:0.9.0</p><p>hbase:0.94.0</p><p>protobuf:$HBASE_HOME/lib/protobuf-java-2.4.0a.jar</p><p><span style="font-family:'宋体';">可以看到，</span>0.9.0<span style="font-family:'宋体';">的</span>hive<span style="font-family:'宋体';">里面自带的</span>hbase<span style="font-family:'宋体';">的</span>jar<span style="font-family:'宋体';">是</span>0.92<span style="font-family:'宋体';">版本的。</span></p><p>[zhouhh@Hadoop48 ~]$ hive –auxpath $HIVE_HOME/lib/hive-hbase-handler-0.9.0.jar,$HIVE_HOME/lib/hbase-0.92.0.jar,$HIVE_HOME/lib/zookeeper-3.3.4.jar,$HIVE_HOME/lib/guava-r09.jar,$HBASE_HOME/lib/protobuf-java-2.4.0a.jar</p><p>hive&gt; CREATE TABLE hbase_table_1(key int, value string)</p><p>&gt; STORED BY ‘org.apache.hadoop.hive.hbase.HBaseStorageHandler’</p><p>&gt; WITH SERDEPROPERTIES (“hbase.columns.mapping” = “:key,cf1:val”)</p><p>&gt; TBLPROPERTIES (“hbase.table.name” = “xyz”);</p><p>java.lang.NoClassDefFoundError: com/google/protobuf/Message</p><p>at org.apache.hadoop.hbase.io.HbaseObjectWritable.(HbaseObjectWritable.java</p><p><span style="font-family:'宋体';">…</span></p><p>Caused by: java.lang.ClassNotFoundException: com.google.protobuf.Message</p><p><span style="font-family:'宋体';">解决办法：</span></p><p><span style="font-family:'宋体';">将</span>$HBASE_HOME/lib/protobuf-java-2.4.0a.jar <span style="font-family:'宋体';">拷贝到</span> $HIVE_HOME/lib/.</p><p>[zhouhh@Hadoop48 ~]$ cp /home/zhouhh/hbase-0.94.0/lib/protobuf-java-2.4.0a.jar $HIVE_HOME/lib/.</p><p>hive&gt; CREATE TABLE hbase_table_1(key int, value string)</p><p>&gt; STORED BY ‘org.apache.hadoop.hive.hbase.HBaseStorageHandler’</p><p>&gt; WITH SERDEPROPERTIES (“hbase.columns.mapping” = “:key,cf1:val”)</p><p>&gt; TBLPROPERTIES (“hbase.table.name” = “xyz”);</p><p>OK</p><p>Time taken: 10.492 seconds</p><p>hbase(main):002:0&gt; list ‘xyz’</p><p>TABLE</p><p>xyz</p><p>1 row(s) in 0.0640 seconds</p><p> </p><p><span style="font-family:'宋体';">在引用</span> <span style="font-family:'宋体';">的</span>jar<span style="font-family:'宋体';">包中包含</span>protobuf-java-2.4.0a.jar<span style="font-family:'宋体';">即可。</span></p><p> </p><p> </p><span></span><h1 style="padding:0px;"><a></a><span style="font-family:'宋体';">测试脚本</span></h1><p>bin/hive -hiveconf hbase.master=master:60000</p><p> </p><p>hive --auxpath /usr/local/hive/lib/hive-hbase-handler-0.9.0.jar,/usr/local/hive/lib/hbase-0.94.7-security.jar,/usr/local/hive/lib/zookeeper-3.4.5.jar -hiveconf hbase.master=localhost:60000</p><p> </p><p>&lt;property&gt;</p><p> &lt;name&gt;hive.aux.jars.path&lt;/name&gt;</p><p>&lt;value&gt;file:///usr/local/hive/lib/hive-hbase-handler-0.9.0.jar,file:///usr/local/hive/lib/hbase-0.94.7-security.jar,file:///usr/local/hive/lib/zookeeper-3.4.5.jar&lt;/value&gt;</p><p>&lt;/property&gt;</p><p> </p><p>1 nana</p><p>2 hehe</p><p>3 xixi</p><p>hadoop dfsadmin -safemode leave</p><p> </p><p>/home/hadoop</p><p> </p><p>create table hbase_table_1(key int, value string) </p><p>stored by 'org.apache.hadoop.hive.hbase.HBaseStorageHandler' </p><p>with serdeproperties ("hbase.columns.mapping" = ":key,cf1:val") </p><p>tblproperties ("hbase.table.name" = "xyz");</p><p> </p><p> </p><p>drop table pokes;</p><p>create table pokes</p><p>(id int,name string)</p><p>row format delimited fields terminated by ' '</p><p>stored as textfile;</p><p>load data local inpath '/home/hadoop/kv1.txt' overwrite into table pokes;</p><p> </p><p>insert into table hbase_table_1</p><p>select * from pokes; </p><p> </p><p> </p><p> </p><p>create external table hive_test</p><p>(key int,gid map&lt;string,string&gt;,sid map&lt;string,string&gt;,uid map&lt;string,string&gt;)</p><p>stored by 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</p><p>with serdeproperties ("hbase.columns.mapping" ="a:,b:,c:") </p><p>tblproperties  ("hbase.table.name" = "test1");</p></div></div><div class="article-bar-bottom" style="padding:0px 0px 16px;margin:36px 0px 0px;border-bottom:1px solid rgb(227,227,227);color:rgb(51,51,51);font-family:'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;font-size:14px;"><div class="tags-box artic-tag-box" style="padding:0px;margin:0px 0px 8px;font-size:12px;"><span class="label" style="color:rgb(77,77,77);">文章标签：</span> <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=hbase&amp;t=blog" rel="nofollow" style="color:rgb(77,77,77);margin-right:8px;padding:0px 8px;height:24px;min-width:24px;line-height:24px;border:1px solid rgb(204,204,204);text-align:center;">hbase</a><a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=hive&amp;t=blog" rel="nofollow" style="color:rgb(77,77,77);margin-right:8px;padding:0px 8px;height:24px;min-width:24px;line-height:24px;border:1px solid rgb(204,204,204);text-align:center;">hive</a></div></div>            </div>
                </div>
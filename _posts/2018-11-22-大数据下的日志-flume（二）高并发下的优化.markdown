---
layout:     post
title:      大数据下的日志-flume（二）高并发下的优化
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								<div class="article-copyright">
					版权声明：本文为博主原创文章，未经博主允许不得转载。					https://blog.csdn.net/xvshu/article/details/50413373				</div>
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <h1><span style="font-family:'FangSong_GB2312';font-size:18px;font-weight:normal;">起因</span></h1><p><span style="font-family:'FangSong_GB2312';font-size:18px;">上篇博客中，我们提到了对flume的使用，但是，只是简单的使用，在高并发的情况下就会有问题，我们举两个例子：</span></p><p><span style="font-family:'FangSong_GB2312';font-size:18px;">1，在高并发下，<span style="line-height:22.5px;">Channel使用<span style="line-height:13.75px;">memory，如果使用默认配置，那么就会较快的情况下，塞满内存，造成大部分数据丢失，对的，你没有听错，<span style="line-height:13.75px;">memory类型的通道，是会丢失数据的，因为单纯的内存，虽然速度很快，但是当速度无法阻挡数据增长时，有些数据无法缓存，或者将内存型的缓存撑爆，我们就必须要考虑，如何优化这种结构。</span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">2，在高并发下，flume的单点承受能力是有限的，如果没有对应的分流措施，我们依然会丧失数据，数据是宝贵的，我们的每份数据都应严肃对待。</span></span></span></span></p><h1><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;font-weight:normal;"><span style="font-family:'FangSong_GB2312';font-size:18px;">优化</span></span></span></span></h1><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">为了解决以上问题，我们提供一种参考方案：</span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">优化结构图示：</span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><img src="https://img-blog.csdn.net/20151227185612971?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br></span></span></span></span></p><h1><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;font-weight:normal;"><span style="font-family:'FangSong_GB2312';font-size:18px;">步骤：</span></span></span></span></h1><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">1，改善<span style="line-height:13.75px;"><span style="line-height:22.5px;">Channel</span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span></span>1.1 参数调优</span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span></span>将flume中<span style="line-height:13.75px;">memory的参数进行调整，主要优化两个参数：</span></span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><br></span></span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span></span>a1.channels.c1.capacity = 1000000<br><span></span>a1.channels.c1.transactionCapacity = 10000<br></span></span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span></span>第一个为最大缓存的量，第二个为每次最大交易的量</span></span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><br></span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span></span>1.2 改变类型</span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span></span>如果不能接受<span style="line-height:13.75px;">memory可能丢失数据的方案，我们一般采用file的方式替换<span style="line-height:13.75px;">channels类型。</span></span></span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><br></span></span></span></span></span></span></span></span></p><p><span style="line-height:22.5px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:13.75px;"><span style="line-height:22.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">2，搭建flume负载均衡</span></span></span></span></span></span></p><p><span><span style="font-family:'FangSong_GB2312';font-size:18px;">借鉴常见的方案如下：</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">假设：现有两台机子，命名为：agent，collect。agent IP地址为：192.168.150.137，collect为192.168.150.135</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">要求：<span>实现agent到collect的连接，并能向collect发送日志。</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">步骤：</span></p><ol style="line-height:22.5px;"><li><p style="letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">两台电脑上分别装上 jdk,flume-ng（不是flume-og），配置好profile。具体参见百度。</span></p></li><li><p style="letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">agent的处理  </span></p><p style="letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">  (1)找到flume-ng安装目录下的conf文件夹，新建test.conf</span></span></p><p style="letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">  </span></span></p><p style="letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span></span></span></p></li></ol><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">   <span> #name the  components on this agent</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sources  = r1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sinks =  k1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.channels  = c1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">   <span>#  Describe/configure the source</span></span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sources.r1.type  = netcat //这里的数据源设置成netcat，后面将通过telnet传送信息</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sources.r1.bind  = 0.0.0.0 //建议  </span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sources.r1.port  = 44444</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    # Describe  the sink<br></span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sinks.k1.type  =avro</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sinks.k1.hostname=192.168.150.135  //collect 的IP地址，注意</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sinks.k1.port=60000 //这里的接口要与collect source的接口一致。</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;"> # Use a  channel which buffers events in memory</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.channels.c1.type  = memory</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.channels.c1.capacity  = 1000</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.channels.c1.transactionCapacity  = 100</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;"># Bind the  source and sink to the channel<br></span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sources.r1.channels  = c1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">    a1.sinks.k1.channel  = c1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">设置好后，暂时不要开启agent。</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">3.下面设置collect，同agent，新建test.conf 文件</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;"># Name the  components on this agent</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sources  = r1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sinks =  k1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.channels  = c1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">#  Describe/configure the source</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sources.r1.type  = avro</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sources.r1.bind  = 192.168.150.135 //绑定本机的IP的地址</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sources.r1.port  =60000 //接口要与agent sink的port一致</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;"># Describe  the sink</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sinks.k1.type  = logger</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;"># Use a  channel which buffers events in memory<br></span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.channels.c1.type  = memory</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.channels.c1.capacity  = 1000</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.channels.c1.transactionCapacity  = 100</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;"># Bind the  source and sink to the channel<br></span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sources.r1.channels  = c1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">a1.sinks.k1.channel  = c1</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><br></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">4.设置好之后保存退出，输入命令：（当前目录为$FLUME_HOME/conf）</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><span>flume-ng agent -n a1 -c conf -f test.conf</span>，若没有问题在agent机上输入命令：</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span><span style="font-family:'FangSong_GB2312';font-size:18px;">flume-ng  agent -c conf -f test.conf -n a1 -Dflume.root.logger=INFO,console</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">collect机上会出现：</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><a href="http://static.oschina.net/uploads/space/2014/0228/160435_HYYO_1401580.png" rel="nofollow"><span style="font-family:'FangSong_GB2312';font-size:18px;color:#000000;"><img src="http://static.oschina.net/uploads/space/2014/0228/160435_HYYO_1401580.png" title="" alt="" style="border:1px solid rgb(221,221,221);background:rgb(244,247,249);"></span></a></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">则表示没有问题。</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">进入下一步</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">5.在agent另开一个 terminal,输入 telnet 127.0.0.1 44444 后（需要安装，yum install telnet）</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"> <span>Trying 127.0.0.1...</span></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">Connected to 127.0.0.1.</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">Escape character is '^]'.</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">然后就可以输入如：ss，enter后到collect机上查看<a href="http://static.oschina.net/uploads/space/2014/0228/160157_LvBy_1401580.jpg" rel="nofollow"><img src="http://static.oschina.net/uploads/space/2014/0228/160157_LvBy_1401580.jpg" alt="" style="border:1px solid rgb(221,221,221);background:rgb(244,247,249);"></a></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><br></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">经过这些步骤的优化，我们基本可以完成对flume的优化，现在看看我们公司使用flume是如何部署这些应用的：</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">1，整体部署图：</span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;"><img src="https://img-blog.csdn.net/20170829162810427?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveHZzaHU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br></span></p><p style="line-height:22.5px;letter-spacing:.5px;"><span style="font-family:'FangSong_GB2312';font-size:18px;">先放大招，以后会逐个介绍，大家期待啊！！！</span></p>            </div>
                </div>
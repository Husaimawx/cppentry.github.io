---
layout:     post
title:      Kafka分布式消息队列（二）：环境搭建&测试
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<h3 style="color:rgb(51,51,51);font-family:Arial;line-height:25.9943180084229px;">
本文基于Kafka 0.8</h3>
<br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">在一台机器上构建一个3个节点的kafka集群，并测试producer、consumer在正常情况下的行为，以及在lead broker/follow broker失效情况下的行为</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">1.下载并解压kafka 0.8.0 release</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ mkdir kafka</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ wget http://apache.dataguru.cn/kafka/0.8.0/kafka_2.8.0-0.8.0.tar.gz</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ tar -zxvf kafka_2.8.0-0.8.0.tar.gz</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ cd kafka_2.8.0-0.8.0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ ll</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">total 2560</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">drwxr-xr-x 6 root root    4096 Dec 17 17:44 ./</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">drwxr-xr-x 4 root root    4096 Dec 17 18:20 ../</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">drwxr-xr-x 3 root root    4096 Dec 17 18:16 bin/</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">drwxr-xr-x 2 root root    4096 Dec 17 17:43 config/</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">-rw-r--r-- 1 root root 2520145 Nov 27 06:21 kafka_2.8.0-0.8.0.jar</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">drwxr-xr-x 2 root root    4096 Nov 27 06:21 libs/</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">-rw-r--r-- 1 root root   12932 Nov 27 06:21 LICENSE</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">drwxr-xr-x 2 root root    4096 Dec 17 18:00 logs/</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">-rw------- 1 root root   47165 Dec 17 18:10 nohup.out</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">-rw-r--r-- 1 root root     162 Nov 27 06:21 NOTICE</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">2.启动一个单节点的zookeeper</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ nohup bin/zookeeper-server-start.sh config/zookeeper.properties &amp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">3. 准备启动一个3个broker节点的kafka集群，因此做如下配置</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ cp config/server.properties config/server-1.properties </span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ cp config/server.properties config/server-2.properties</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
并做如下修改：</p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
config/server-1.properties:<br>
    broker.id=1<br>
    port=9093<br>
    log.dir=/tmp/kafka-logs-1<br>
config/server-2.properties:<br>
    broker.id=2<br>
    port=9094<br>
    log.dir=/tmp/kafka-logs-2</p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
说明：<br>
broker.id: broker节点的唯一标识<br>
port: broker节点使用端口号<br>
log.dir: 消息目录位置<br><br><strong>4. 启动3个broker节点</strong><br>
$ JMX_PORT=9997 bin/kafka-server-start.sh config/server-1.properties &amp;<br>
$ JMX_PORT=9998 bin/kafka-server-start.sh config/server-2.properties &amp;<br>
$ JMX_PORT=9999 bin/kafka-server-start.sh config/server.properties &amp;<br></p>
<br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">5. 创建topic并查看</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-create-topic.sh --zookeeper localhost:2181 --replica 3 --partition 1 --topic 3test</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">creation succeeded!</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-list-topic.sh --zookeeper localhost:2181</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="font-family:Arial;font-size:14px;line-height:26px;color:rgb(255,0,0);">topic: 3test    partition: 0    leader: 2       replicas: 2,1,0 isr: 2,1,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test     partition: 0    leader: 0       replicas: 0     isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test_topic       partition: 0    leader: 1       replicas: 0,1,2 isr: 1,2,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">说明：</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">partiton： partion id，由于此处只有一个partition，因此partition id 为0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">leader：当前负责读写的lead broker id</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">relicas：当前partition的所有replication broker  list</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">isr：relicas的子集，只包含出于活动状态的broker</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">6.启动consumer &amp; producer，并在producer启动后的console输入一些信息</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-console-consumer.sh --zookeeper localhost:2181 --from-beginning --topic 3test</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">message1</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">message3</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">message2</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-console-producer.sh --broker-list localhost:9092,localhost:9093,localhost:9094 --topic 3test</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">message1</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">message3</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">message2</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">producer发送的数据consumer都能正常消费</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">7. 干掉follow broker</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">杀掉一个非lead broker（lead broker id为2）</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ pkill -9 -f server-1.properties</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">查看topic：</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-list-topic.sh --zookeeper localhost:2181</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="font-family:Arial;font-size:14px;line-height:26px;color:rgb(255,0,0);">topic: 3test    partition: 0    leader: 2       replicas: 2,1,0 isr: 2,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test     partition: 0    leader: 0       replicas: 0     isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test_topic       partition: 0    leader: 2       replicas: 0,1,2 isr: 2,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
此时，存活的broker只有2,0<br>
测试：produce发送消息，consumer能正常接收到<br><br><strong>8. 继续干掉leader broker</strong></p>
<span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">干掉leader broker后，连续查看topic状态</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ pkill -9 -f server-2.properties                 </span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-list-topic.sh --zookeeper localhost:2181</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: 3test    partition: 0    leader: 2       replicas: 2,1,0 isr: 2,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test     partition: 0    leader: 0       replicas: 0     isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test_topic       partition: 0    leader: 2       replicas: 0,1,2 isr: 2,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-list-topic.sh --zookeeper localhost:2181</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: 3test    partition: 0    leader: 2       replicas: 2,1,0 isr: 2,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test     partition: 0    leader: 0       replicas: 0     isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test_topic       partition: 0    leader: 2       replicas: 0,1,2 isr: 2,0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-list-topic.sh --zookeeper localhost:2181</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: 3test    partition: 0    leader: 0       replicas: 2,1,0 isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test     partition: 0    leader: 0       replicas: 0     isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test_topic       partition: 0    leader: 0       replicas: 0,1,2 isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">$ bin/kafka-list-topic.sh --zookeeper localhost:2181</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="font-family:Arial;font-size:14px;line-height:26px;color:rgb(255,0,0);">topic: 3test    partition: 0    leader: 0       replicas: 2,1,0 isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test     partition: 0    leader: 0       replicas: 0     isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">topic: test_topic       partition: 0    leader: 0       replicas: 0,1,2 isr: 0</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">杀掉leader broker过了一会，broker 0成为新的leader broker</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">测试：produce发送消息，consumer能正常接收到</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">参考：</span><a href="https://kafka.apache.org/documentation.html#quickstart" rel="nofollow" style="color:rgb(51,102,153);text-decoration:none;font-family:Arial;font-size:14px;line-height:26px;">Kafka
 QuickStart</a>
            </div>
                </div>
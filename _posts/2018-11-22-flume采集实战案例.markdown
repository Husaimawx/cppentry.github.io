---
layout:     post
title:      flume采集实战案例
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <div align="justify"><h2><span style="font-family:Cambria;color:#000000;"> Flume</span>实战案例</h2><h4><span style="font-family:Cambria;font-size:18px;color:#000000;">1.2.1 Flume</span>的安装部署</h4><p><span style="font-family:Calibri;color:#000000;">1、Flume</span>的安装非常简单，只需要解压即可，当然，前提是已有<span style="font-family:Calibri;">hadoop</span>环境</p><p><span style="color:#000000;">上传安装包到数据源所在节点上</span></p><p><span style="color:#000000;">然后解压<span style="font-family:Calibri;">  tar -zxvfapache-flume-1.6.0-bin.tar.gz</span></span></p><p><span style="color:#000000;">然后进入<span style="font-family:Calibri;">flume</span>的目录，修改<span style="font-family:Calibri;">conf</span>下的<span style="font-family:Calibri;">flume-env.sh</span>，在里面配置<span style="font-family:Calibri;">JAVA_HOME</span></span></p><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="font-family:Calibri;color:#000000;">2</span>、根据数据采集的需求<span>配置采集方案</span>，描述在配置文件中<span style="font-family:Calibri;">(</span>文件名可任意自定义<span style="font-family:Calibri;">)</span></p><p><span style="font-family:Calibri;color:#000000;">3</span>、<strong>指定采集方案配置文件</strong>，在相应的节点上启动<span style="font-family:Calibri;">flume agent</span></p><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="color:#000000;">先用一个最简单的例子来测试一下程序环境是否正常</span></p><p><span style="font-family:Calibri;color:#000000;">1、</span>先在<span style="font-family:Calibri;">flume</span>的<span style="font-family:Calibri;">conf</span>目录下新建一个文件</p><p><span style="font-family:Calibri;color:#000000;">vi  netcat-logger.conf</span></p><table width="710" cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span style="font-family:Calibri;color:#000000;"># </span>定义这个<span style="font-family:Calibri;">agent</span>中各组件的名字</p>  <p><span style="font-family:Calibri;color:#000000;">a1.sources = r1</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.sinks = k1</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.channels = c1</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># </span>描述和配置<span style="font-family:Calibri;">source</span>组件：<span style="font-family:Calibri;">r1</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.sources.r1.type = netcat</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.sources.r1.bind = localhost</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.sources.r1.port = 44444</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># </span>描述和配置<span style="font-family:Calibri;">sink</span>组件：<span style="font-family:Calibri;">k1</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.sinks.k1.type = logger</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># </span>描述和配置<span style="font-family:Calibri;">channel</span>组件，此处使用是内存缓存的方式</p>  <p><span style="font-family:Calibri;color:#000000;">a1.channels.c1.type = memory</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.channels.c1.capacity = 1000</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.channels.c1.transactionCapacity = 100</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># </span>描述和配置<span style="font-family:Calibri;">source  channel    sink</span>之间的连接关系</p>  <p><span style="font-family:Calibri;color:#000000;">a1.sources.r1.channels = c1</span></p>  <p><span style="font-family:Calibri;color:#000000;">a1.sinks.k1.channel = c1</span></p></td> </tr></tbody></table><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="font-family:Calibri;color:#000000;">2、</span>启动<span style="font-family:Calibri;">agent</span>去采集数据</p><table width="710" cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span style="font-family:Calibri;color:#000000;">bin/flume-ng agent -c conf -f  conf/netcat-logger.conf -n a1   -Dflume.root.logger=INFO,console</span></p></td> </tr></tbody></table><p><span style="font-family:Calibri;color:#000000;">-c conf  </span>指定<span style="font-family:Calibri;">flume</span>自身的配置文件所在目录</p><p><span style="font-family:Calibri;color:#000000;">-f conf/netcat-logger.con  </span>指定我们所描述的采集方案</p><p><span style="font-family:Calibri;color:#000000;">-n a1 </span>指定我们这个<span style="font-family:Calibri;">agent</span>的名字</p><p><span style="font-family:Calibri;color:#000000;">3、</span>测试</p><p><span style="color:#000000;">先要往<span style="font-family:Calibri;">agent</span>采集监听的端口上发送数据，让<span style="font-family:Calibri;">agent</span>有数据可采</span></p><p><span style="color:#000000;">随便在一个能跟<span style="font-family:Calibri;">agent</span>节点联网的机器上</span></p><p><span style="font-family:Calibri;color:#000000;">telnet anget-hostname  port   </span>（<span style="font-family:Calibri;">telnetlocalhost 44444</span>）</p><p><br></p><h4><span style="font-family:Cambria;font-size:18px;color:#000000;">1.2.2 </span>采集案例</h4><h5><span style="font-family:Calibri;font-size:18px;color:#000000;">1</span>、采集目录到<span style="font-family:Calibri;">HDFS</span></h5><p><span style="color:#000000;">采集需求：某服务器的某特定目录下，会不断产生新的文件，每当有新文件出现，就需要把文件采集到<span style="font-family:Calibri;">HDFS</span>中去</span></p><p><span style="color:#000000;">根据需求，首先定义以下<span style="font-family:Calibri;">3</span>大要素</span></p><p><span style="color:#000000;">l 采集源，即<span style="font-family:'宋体';">source</span>——监控文件目录<span style="font-family:'宋体';"> :  spooldir</span></span></p><p><span style="color:#000000;">l 下沉目标，即<span style="font-family:'宋体';">sink</span>——<span style="font-family:'宋体';">HDFS</span>文件系统<span style="font-family:'宋体';">  :  hdfs sink</span></span></p><p><span style="color:#000000;">l <span style="font-family:'宋体';">source</span>和<span style="font-family:'宋体';">sink</span>之间的传递通道——<span style="font-family:'宋体';">channel</span>，可用<span style="font-family:'宋体';">filechannel </span>也可以用内存<span style="font-family:'宋体';">channel</span></span></p><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="color:#000000;">配置文件编写：</span></p><table width="710" cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span style="font-family:Calibri;color:#000000;">#</span>定义三大组件的名称</p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources = source1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks = sink1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels = channel1</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># </span>配置<span style="font-family:Calibri;">source</span>组件</p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.</span><span style="color:#FF0000;">type = spooldir</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.</span><span style="color:#FF0000;">spoolDir = /home/hadoop/logs/</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.fileHeader = false</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;">#</span>配置拦截器</p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.interceptors = i1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.interceptors.i1.type  = host</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.interceptors.i1.hostHeader  = hostname</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># </span>配置<span style="font-family:Calibri;">sink</span>组件</p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.type = hdfs</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.path =hdfs://hdp-node-01:9000/weblog/flume-collection/%y-%m-%d/%H-%M</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.filePrefix =  access_log</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.maxOpenFiles =  5000</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.batchSize= 100</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.fileType =  DataStream</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.writeFormat =Text</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.rollSize = 102400</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.rollCount =  1000000</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.rollInterval = 60</span></p>  <p><span style="font-family:Calibri;color:#000000;">#agent1.sinks.sink1.hdfs.round = true</span></p>  <p><span style="font-family:Calibri;color:#000000;">#agent1.sinks.sink1.hdfs.roundValue = 10</span></p>  <p><span style="font-family:Calibri;color:#000000;">#agent1.sinks.sink1.hdfs.roundUnit =  minute</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.useLocalTimeStamp  = true</span></p>  <p><span style="font-family:Calibri;color:#000000;"># Use a channel which buffers events in  memory</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.type = memory</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.keep-alive = 120</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.capacity =  500000</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.transactionCapacity  = 600</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># Bind the source and sink to the channel</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.channels =  channel1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.channel = channel1</span></p></td> </tr></tbody></table><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="font-family:Calibri;color:#000000;">Channel</span>参数解释：</p><p><span style="font-family:Calibri;color:#000000;">capacity</span>：默认该通道中最大的可以存储的<span style="font-family:Calibri;">event</span>数量</p><p><span style="font-family:Calibri;color:#000000;">trasactionCapacity</span>：每次最大可以从<span style="font-family:Calibri;">source</span>中拿到或者送到<span style="font-family:Calibri;">sink</span>中的<span style="font-family:Calibri;">event</span>数量</p><p><span style="font-family:Calibri;color:#000000;">keep-alive</span>：<span style="font-family:Calibri;">event</span>添加到通道中或者移出的允许时间</p><p><span style="font-family:Calibri;color:#000000;"> </span></p><h5><span style="font-family:Calibri;font-size:18px;color:#000000;">2</span>、采集文件到<span style="font-family:Calibri;">HDFS</span></h5><p><span style="color:#000000;">采集需求：比如业务系统使用<span style="font-family:Calibri;">log4j</span>生成的日志，日志内容不断增加，需要把追加到日志文件中的数据实时采集到<span style="font-family:Calibri;">hdfs</span></span></p><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="color:#000000;">根据需求，首先定义以下<span style="font-family:Calibri;">3</span>大要素</span></p><p><span style="color:#000000;">l 采集源，即<span style="font-family:'宋体';">source</span>——监控文件内容更新<span style="font-family:'宋体';"> :  exec  ‘tail -F file’</span></span></p><p><span style="color:#000000;">l 下沉目标，即<span style="font-family:'宋体';">sink</span>——<span style="font-family:'宋体';">HDFS</span>文件系统<span style="font-family:'宋体';">  :  hdfs sink</span></span></p><p><span style="color:#000000;">l <span style="font-family:'宋体';">Source</span>和<span style="font-family:'宋体';">sink</span>之间的传递通道——<span style="font-family:'宋体';">channel</span>，可用<span style="font-family:'宋体';">filechannel </span>也可以用内存<span style="font-family:'宋体';">channel</span></span></p><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="color:#000000;">配置文件编写：</span></p><table width="710" cellspacing="0" cellpadding="0" border="1"><tbody><tr><td valign="top"><p><span style="font-family:Calibri;color:#000000;">agent1.sources = source1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks = sink1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels = channel1</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># Describe/configure tail -F source1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.type = exec</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.command = tail -F  /home/hadoop/logs/access_log</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.channels =  channel1</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;">#configure host for source</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.interceptors = i1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.interceptors.i1.type  = host</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.interceptors.i1.hostHeader  = hostname</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># Describe sink1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.type = hdfs</span></p>  <p><span style="font-family:Calibri;color:#000000;">#a1.sinks.k1.channel = c1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.path  =hdfs://hdp-node-01:9000/weblog/flume-collection/%y-%m-%d/%H-%M</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.filePrefix =  access_log</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.maxOpenFiles =  5000</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.batchSize= 100</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.fileType =  DataStream</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.writeFormat =Text</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.rollSize = 102400</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.rollCount =  1000000</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.rollInterval = 60</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.round = true</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.roundValue = 10</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.roundUnit =  minute</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.hdfs.useLocalTimeStamp  = true</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># Use a channel which buffers events in  memory</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.type = memory</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.keep-alive = 120</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.capacity =  500000</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.channels.channel1.transactionCapacity  = 600</span></p>  <p><span style="font-family:Calibri;color:#000000;"> </span></p>  <p><span style="font-family:Calibri;color:#000000;"># Bind the source and sink to the channel</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sources.source1.channels =  channel1</span></p>  <p><span style="font-family:Calibri;color:#000000;">agent1.sinks.sink1.channel = channel1</span></p></td> </tr></tbody></table><p><span style="font-family:Calibri;color:#000000;"> </span></p><p><span style="font-family:Calibri;color:#000000;"> </span></p><p align="left"><span style="font-family:Calibri;color:#000000;"> </span></p></div>            </div>
                </div>
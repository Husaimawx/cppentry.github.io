---
layout:     post
title:      hive中文官方文档
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<div>
<span style="line-height:17px;font-family:Helvetica, Arial, sans-serif;">免责声明: Hive目前仅在Unix(linux)和Mac系统下使用Java 1.6测试运行，可以在这些或类似的平台上正常运行。并不支持在Cygwin上工作(注:windows还是别想了)。</span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">绝大部分的测试工作是基于Hadoop 0.20完成的 - 所以，我们建议不要使用其他版本，以避免编译或运行的异常</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">安装与配置</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">系统需求</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><span></span>Java 1.6</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><span></span>Hadoop 0.20.x.(注:目前0.9.0支持hadoop 1.0.x)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">用发行版安装Hive</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">使用下载工具从Apache下载镜像下载最近的Hive发行包(查看 Hive发行包)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">下一步你需要解压缩Tar包，这将会创建一个名为hive-x.y.z的子目录：</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ tar -xzvf hive-x.y.z.tar.gz</div>
</div>
</div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">设置HIVE_HOME环境变量指向到Hive的安装目录：</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ cd hive-x.y.z<br>
$ export HIVE_HOME={{pwd}}</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">最后, 将$HIVE_HOME/bin添加到你的PATH环境变量中：</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ export PATH=$HIVE_HOME/bin:$PATH</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">使用源码创建Hive</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive SVN 源: http://svn.apache.org/repos/asf/hive/trunk</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ svn co http://svn.apache.org/repos/asf/hive/trunk hive<br>
$ cd hive<br>
$ ant clean package<br>
$ cd build/dist<br>
$ ls<br>
README.txt<br>
bin/ (所有shell脚本)<br>
lib/ (所需的jar文件)<br>
conf/ (配置文件)<br>
examples/ (示例输入与查询文件)</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">在接下来, 我们会交替的使用build/dist和&lt;install-dir&gt;.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">运行Hive</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive 使用Hadoop，这意味着:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">你必须在PATH里面设置了hadoop路径 (注:原文是 you must have hadoop in your path，我认为这个path应该是大写的)  或者</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">export HADOOP_HOME=&lt;hadoop-install-dir&gt;</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">作为附加的, 你必须在创建Hive库表前，在HDFS上创建/tmp和/user/hive/warehouse，并且将它们的权限设置为chmod g+w.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">完成这个操作的命令如下：</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ $HADOOP_HOME/bin/hadoop fs -mkdir             /tmp<br>
$ $HADOOP_HOME/bin/hadoop fs -mkdir             /user/hive/warehouse<br>
$ $HADOOP_HOME/bin/hadoop fs -chmod g+w     /tmp<br>
$ $HADOOP_HOME/bin/hadoop fs -chmod g+w     /user/hive/warehouse</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">我同样发现设置 HIVE_HOME 是很重要的，但并非必须</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ export HIVE_HOME=&lt;hive-install-dir&gt;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">在Shell中使用Hive命令行(cli)模式:</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ $HIVE_HOME/bin/hive</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">配置文件管理概述</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive 默认的配置文件保存在 &lt;install-dir&gt;/conf/hive-default.xml</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">你可以修改其中的配置，并重命名这个文件为 &lt;install-dir&gt;/conf/hive-site.xml(注:我建议你还是保留原始配置文件)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive配置文件的位置可以通过设置HIVE_CONF_DIR环境变量来改变.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Log4j的配置保存在 &lt;install-dir&gt;/conf/hive-log4j.properties</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive的配置存在于Hadoop之上，这意味着Hadoop的配置默认会被继承到Hive中.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive 配置可以被如下方式控制:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">编辑 hive-site.xml 并定义任何需要的变量 (包括hadoop的变量)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">从 cli 模式使用使用set命令 (看下面)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">使用如下方式:</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
$ bin/hive -hiveconf x1=y1 -hiveconf x2=y2</div>
</div>
</div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">这个例子分别设置了变量x1为y1，x2为y2</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">设置使用 HIVE_OPTS 环境变量 "-hiveconf x1=y1 -hiveconf x2=y2" 与上面的功能相同</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">运行时配置</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive 查询是执行map-reduce查询，并且，这些查询是可以被hadoop的配置所控制的.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">命令行命令 'SET' 可以被用来设置任何hadoop(或者hive)的配置变量，例如:</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
    hive&gt; SET mapred.job.tracker=myhost.mycompany.com:50030;<br>
    hive&gt; SET -v;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">后者(注 SET -v)用来查看当前全部的设置. 而不使用 -v 选项，则是用来查看当前与Hadoop不同的配置.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">Hive, Map-Reduce 与本地模式</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive编译器会为绝大多数查询生成map-reduce的jobs。这些Jobs使用下面这个变量来表明被提交到Map-Reduce集群中:</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
    mapred.job.tracker</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">由于这通常是在一个多节点的map-reduce集群中被指出，Hadoop同样有个就近的方式来在用户的工作机上运行map-reduce jobs。这就在小数据集的查询上显得非常有用 - 在这种情况下，本地模式运行通常会比将任务提交到整个大集群中查询更快。数据从HDFS上获取是透明的。同样的，由于本地模式仅运行一个reducer，这样，在大数据查询上是非常慢的。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">从 0.7 版本开始, Hive全面支持本地运行模式，要使用这个模式，请按照下列进行设置:</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
    hive&gt; SET mapred.job.tracker=local;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">作为附加的，mapred.local.dir应该指定一个合法的本机路径(注:安装hive的那台服务器) (例如: /tmp/&lt;username&gt;/mapred/local). (否则,用户将获取一个定位本地空间的异常抛出).</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">从0.7版本开始, Hive同样支持自动/非自动地使用本地模式来完成map-reduce jobs，相关的选项是:</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
    hive&gt; SET hive.exec.mode.local.auto=false;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">请注意这个功能默认是关闭的，如果打开 - Hive将分析每一个查询的map-reduce job ，并且如果以下阀值被确认为OK，就尝试运行在本地:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">全部job的输入大小低于: hive.exec.mode.local.auto.inputbytes.max (128MB 默认)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">全部的map任务数低于: hive.exec.mode.local.auto.tasks.max (4 个默认)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">全部reduce任务数等于 1 或者 0.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">对于查询大于小数据集，或者需要查询在多个map-reduce jobs中完成，但是子查询很小的(注:小于上述条件)，jobs仍可能使用本地模式来运行。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">注意，可能不同的hadoop服务器节点和hive客户端的运行时环境(由于不同的jvm版本或者不同的软件库)。运行本地模式可能会导致一个不可被捕获的错误。同样需要注意的是，本地运行模式是在一个独立的子jvm(hive 客户端的子进程)中完成的。 如果用户希望，子jvm所能使用的最大内存数，可以通过访问hive.mapred.local.mem来进行控制。默认设置是0，所以Hive允许Hadoop来决定子jvm的默认内存限制</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">错误日志</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive 使用 log4j 来记录日志. 默认来说，日志不会被返回到CLI模式的控制台上(注:也就是CRT中)。默认的日志记录等级是WARN，并被保存到以下文件夹中:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><span></span>/tmp/&lt;user.name&gt;/hive.log</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">如果用户愿意 - 日志可以通过修改下面的参数来返回到控制台上:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><span></span>bin/hive -hiveconf hive.root.logger=INFO,console</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">另外，用户可以改变记录等级:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><span></span>bin/hive -hiveconf hive.root.logger=INFO,DRFA</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">注意，配置项 hive.root.logger 在hive初始化以后，即不能通过使用'set'命令来改变了</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive同样会为每个hive会话保存查询日志，在/tmp/&lt;user.name&gt;/ (注:本机路径下)，但是可以通过修改 hive-site.xml 中的 hive.querylog.location属性来变更。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive在一个hadoop集群上运行过程中的日志是由Hadoop的配置所决定的。通常Hadoop会为每个map和reduce任务创建日志文件，并保存在运行任务的集群服务器上。日志文件可以通过Hadoop Jobtracker提供的Web UI上的Task Detail页面来跟踪观察。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">运行本地模式时(mapred.job.tracker=local)，Hadoop/Hive 将会将执行日志放在本机上，从0.6版本开始 - Hive使用hive-exec-log4j.properties (如果不存在，则是使用hive-log4j.properties文件)来决定默认的日志的保存方式。默认的配置文件将为每个查询执行在本地模式下的日志放到/tmp/&lt;user.name&gt;。这样做的目的是为了将配置单独管理，并可以将日志集中存放到一个用户需要的位置(例如一个NFS文件服务器)上。执行日志对于运行时错误的debug并无帮助。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">错误日志对于定位问题非常有用，请将存在的任何bug发送到hive-dev@hadoop.apache.org</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><br></span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">DDL 操作</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">创建Hive表和查看使用</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">CREATE</span> <span style="color:#0000ff;">TABLE</span> pokes (foo<span style="color:#0000ff;">INT</span>, bar STRING);</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">创建一个包含两个字段，名称为pokes的表，第一个字段是int(注:整型)，第二个字段是string(注:字符串)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">CREATE</span> <span style="color:#0000ff;">TABLE</span> invites (foo<span style="color:#0000ff;">INT</span>, bar STRING) PARTITIONED<span style="color:#0000ff;">BY</span> (ds STRING);</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;line-height:17px;">创建一个名为invites的表，其中包含两个字段和一个叫做ds的分区(partition)字段. 分区字段是一个虚拟的字段，本身并不包含在数据中，但是是从加载进来的数据中特别衍生出来的数据集.</span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">默认情况下，表被假定是纯文本的格式，并且使用^A(ctrl-a)来作为数据分割的。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; SHOW TABLES;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;line-height:17px;">列出所有的表</span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; SHOW TABLES <span style="color:#ff0000;">'.*s'</span>;</div>
</div>
</div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">列出所有结尾包含 's' 的表名。匹配方式使用Java正则表达式，查看下列连接获取关于Java正则的信息  http://java.sun.com/javase/6/docs/api/java/util/regex/Pattern.html</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; DESCRIBE invites;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;line-height:17px;">查看invites表的全部字段</span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">可以修改表名，增加删除新的字段等:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">ALTER</span> <span style="color:#0000ff;">TABLE</span> pokes<span style="color:#0000ff;">ADD</span> COLUMNS (new_col<span style="color:#0000ff;">INT</span>);<br>
hive&gt; <span style="color:#0000ff;">ALTER</span> <span style="color:#0000ff;">TABLE</span> invites<span style="color:#0000ff;">ADD</span> COLUMNS (new_col2<span style="color:#0000ff;">INT</span> COMMENT
<span style="color:#ff0000;">'a comment'</span>);<br>
hive&gt; <span style="color:#0000ff;">ALTER</span> <span style="color:#0000ff;">TABLE</span> events RENAME<span style="color:#0000ff;">TO</span> 3koobecaf;<br></div>
</div>
<br></div>
<div>
删除表:</div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">DROP</span> <span style="color:#0000ff;">TABLE</span> pokes;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">元数据存储</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">元数据默认使用Derby数据库保存在本地文件系统中，并保存在./metastore_db下。通过修改conf/hive-default.xml中的javax.jdo.option.ConnectionURL变量修改。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">当前，在默认配置下，元数据每次只能同时被一个用户所使用。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">元数据可以存储在任何一个使用JPOX支持的数据库中，这些关系型数据库的连接和类型可以通过两个变量进行控制。javax.jdo.option.ConnectionURL 和 javax.jdo.option.ConnectionDriverName。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">你需要查看数据库的JDO(或JPOX)手册来获取更多信息。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">数据库的Schema定义在JDO元数据注释文件package.jdo中，位置在src/contrib/hive/metastore/src/model。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">计划在未来，元数据存储引擎可以成为一个独立的服务。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">如果你想将元数据作为一个网络的服务来在多个节点中访问，请尝试HiveDerbyServerMode.</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><br></span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">DML 操作</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">将文件中的数据加载到Hive中:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">LOAD</span> DATA LOCAL INPATH <span style="color:#ff0000;">
'./examples/files/kv1.txt'</span> OVERWRITE <span style="color:#0000ff;">INTO</span><span style="color:#0000ff;">TABLE</span> pokes;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">加载到pokes表的文件包含两个用ctrl-a符号分割的数据列，'LOCAL' 意味着文件是从本地文件系统加载，如果没有 'LOCAL' 则意味着从HDFS中加载。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">关键词 'OVERWRITE' 意味着当前表中已经存在的数据将会被删除掉。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">如果没有给出 'OVERWRITE'，则意味着数据文件将追加到当前的数据集中。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">注意:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">通过load命令加载的数据不会被校验正确性。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">如果文件在HDFS上，他将会被移动到hive所管理的文件系统的命名空间中</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Hive目录的根路径是在hive-default.xml文件中的变量</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">hive.metastore.warehouse.dir</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">决定的。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">我们建议用户在使用Hive建表之前就创建好这个变量指定的目录。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">LOAD</span> DATA LOCAL INPATH <span style="color:#ff0000;">
'./examples/files/kv2.txt'</span> OVERWRITE <span style="color:#0000ff;">INTO</span><span style="color:#0000ff;">TABLE</span> invites PARTITION (ds=<span style="color:#ff0000;">'2008-08-15'</span>);<br>
hive&gt; <span style="color:#0000ff;">LOAD</span> DATA LOCAL INPATH <span style="color:#ff0000;">
'./examples/files/kv3.txt'</span> OVERWRITE <span style="color:#0000ff;">INTO</span><span style="color:#0000ff;">TABLE</span> invites PARTITION (ds=<span style="color:#ff0000;">'2008-08-08'</span>);</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">上面这两个 LOAD 语句，将加载不同的数据到invites表的分区(partition)中。invites表必须事先使用 ds 创建好partition。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">LOAD</span> DATA INPATH <span style="color:#ff0000;">
'/user/myname/kv2.txt'</span> OVERWRITE <span style="color:#0000ff;">INTO</span> <span style="color:#0000ff;">
TABLE</span> invites PARTITION (ds=<span style="color:#ff0000;">'2008-08-15'</span>);</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">上述命令是将HDFS上的文件加载到表中。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">注意从HDFS中加载数据，将会把数据移动到目录下。这几乎是瞬间完成的。(注:因为只是在HDFS元数据中修改了文件路径的指向。)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><br></span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:24px;color:#6495ed;"><span style="line-height:17px;">SQL 查询</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">查询示例</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">下面会演示一些查询范例，在build/dist/examples/queries中可以找到。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">更多的，可以在hive源码中的 ql/src/test/queries/positive中可以找到。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><br></span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">SELECTS 和 FILTERS</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">SELECT</span> a.foo <span style="color:#0000ff;">
FROM</span> invites a <span style="color:#0000ff;">WHERE</span> a.ds=<span style="color:#ff0000;">'2008-08-15'</span>;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;line-height:17px;">从invite表的字段 'foo' 中选择所有分区ds=2008-08-15的结果。这些结果并不存储在任何地方，只在控制台中显示。</span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">注意：下面的示例中，INSERT (到hive表，本地目录或者HDFS目录) 是可选命令。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
    hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE DIRECTORY <span style="color:#ff0000;">
'/tmp/hdfs_out'</span> <span style="color:#0000ff;">SELECT</span> a.* <span style="color:#0000ff;">
FROM</span> invites a <span style="color:#0000ff;">WHERE</span> a.ds=<span style="color:#ff0000;">'2008-08-15'</span>;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">从invites表中选择分区 ds=2008-08-15 的所有行，并放入HDFS目录中。结果数据在在/tmp/hdfs_out目录中的文件(多个文件，文件数量取决于mapper的数量)。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><br></span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">存在分区的表在使用 WHERE 条件过滤的时候必须至少指定一个分区来查询。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE LOCAL DIRECTORY <span style="color:#ff0000;">
'/tmp/local_out'</span> <span style="color:#0000ff;">SELECT</span> a.* <span style="color:#0000ff;">
FROM</span> pokes a;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">选择pokes表中所有的数据并放到一个本地(注:当前服务器)的文件路径中。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE <span style="color:#0000ff;">
TABLE</span> events <span style="color:#0000ff;">SELECT</span> a.* <span style="color:#0000ff;">
FROM</span> profiles a;<br>
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE <span style="color:#0000ff;">
TABLE</span> events <span style="color:#0000ff;">SELECT</span> a.* <span style="color:#0000ff;">
FROM</span> profiles a <span style="color:#0000ff;">WHERE</span> a.<span style="color:#0000ff;">key</span> &lt; 100;<br>
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE LOCAL DIRECTORY <span style="color:#ff0000;">
'/tmp/reg_3'</span> <span style="color:#0000ff;">SELECT</span> a.* <span style="color:#0000ff;">
FROM</span> events a;<br>
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE DIRECTORY <span style="color:#ff0000;">
'/tmp/reg_4'</span> <span style="color:#0000ff;">select</span> a.invites, a.pokes <span style="color:#0000ff;">
FROM</span> profiles a;<br>
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE DIRECTORY <span style="color:#ff0000;">
'/tmp/reg_5'</span> <span style="color:#0000ff;">SELECT</span> <span style="color:#0000ff;">
<span style="color:#ff00ff;">COUNT</span></span>(*) <span style="color:#0000ff;">FROM</span> invites a<span style="color:#0000ff;">WHERE</span> a.ds=<span style="color:#ff0000;">'2008-08-15'</span>;<br>
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE DIRECTORY <span style="color:#ff0000;">
'/tmp/reg_5'</span> <span style="color:#0000ff;">SELECT</span> a.foo, a.bar <span style="color:#0000ff;">
FROM</span> invites a;<br>
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE LOCAL DIRECTORY <span style="color:#ff0000;">
'/tmp/sum'</span> <span style="color:#0000ff;">SELECT</span> <span style="color:#0000ff;">
<span style="color:#ff00ff;">SUM</span></span>(a.pc) <span style="color:#0000ff;">FROM</span> pc1 a;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">字段计算和，最大值，最小值同样可以使用，注意不包含在 HIVE-287 中的Hive版本，你需要使用COUNT(1) 来代替 COUNT(*)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">GROUP BY</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">FROM</span> invites a <span style="color:#0000ff;">
INSERT</span> OVERWRITE <span style="color:#0000ff;">TABLE</span> events <span style="color:#0000ff;">
SELECT</span> a.bar, <span style="color:#0000ff;"><span style="color:#ff00ff;">count</span></span>(*)<span style="color:#0000ff;">WHERE</span> a.foo &gt; 0<span style="color:#0000ff;">GROUP</span><span style="color:#0000ff;">BY</span> a.bar;<br>
hive&gt; <span style="color:#0000ff;">INSERT</span> OVERWRITE <span style="color:#0000ff;">
TABLE</span> events <span style="color:#0000ff;">SELECT</span> a.bar, <span style="color:#0000ff;">
<span style="color:#ff00ff;">count</span></span>(*) <span style="color:#0000ff;">FROM</span> invites a<span style="color:#0000ff;">WHERE</span> a.foo &gt; 0<span style="color:#0000ff;">GROUP</span><span style="color:#0000ff;">BY</span> a.bar;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">注意不包含在 HIVE-287 中的Hive版本，你需要使用COUNT(1) 来代替 COUNT(*)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">JOIN</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
hive&gt; <span style="color:#0000ff;">FROM</span> pokes t1 <span style="color:#999999;">
JOIN</span> invites t2 <span style="color:#0000ff;">ON</span> (t1.bar = t2.bar) <span style="color:#0000ff;">
INSERT</span> OVERWRITE <span style="color:#0000ff;">TABLE</span> events <span style="color:#0000ff;">
SELECT</span> t1.bar, t1.foo, t2.foo;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">MULTITABLE INSERT(多重插入)</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
    FROM src<br>
    INSERT OVERWRITE TABLE dest1 SELECT src.* WHERE src.key &lt; 100<br>
    INSERT OVERWRITE TABLE dest2 SELECT src.key, src.value WHERE src.key &gt;= 100 and src.key &lt; 200<br>
    INSERT OVERWRITE TABLE dest3 PARTITION(ds='2008-04-08', hr='12') SELECT src.key WHERE src.key &gt;= 200 and src.key &lt; 300<br>
    INSERT OVERWRITE LOCAL DIRECTORY '/tmp/dest4.out' SELECT src.value WHERE src.key &gt;= 300;<br>
STREAMING<br>
    hive&gt; FROM invites a INSERT OVERWRITE TABLE events SELECT TRANSFORM(a.foo, a.bar) AS (oof, rab) USING '/bin/cat' WHERE a.ds &gt; '2008-08-09';</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">在map中使用脚本/bin/cat对数据的流式访问(就像使用hadoop的streaming)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">同样的 - 流式访问也可以使用在reduce阶段。(请查看 Hive Tutorial 范例)</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><br></span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;font-size:18px;color:#6495ed;"><span style="line-height:17px;">简单的使用范例</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">用户对电影的投票统计</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">首先，创建一个使用tab分割的文本文件的表</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
<span style="color:#0000ff;">CREATE</span> <span style="color:#0000ff;">TABLE</span> u_data (<br>
        userid <span style="color:#0000ff;">INT</span>,<br>
        movieid <span style="color:#0000ff;">INT</span>,<br>
        rating <span style="color:#0000ff;">INT</span>,<br>
        unixtime STRING)<br>
ROW FORMAT DELIMITED<br>
FIELDS TERMINATED <span style="color:#0000ff;">BY</span> <span style="color:#ff0000;">
'\t'</span><br>
STORED <span style="color:#0000ff;">AS</span> TEXTFILE;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">然后，下载这个数据文件</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><span></span>wget http://www.grouplens.org/system/files/ml-data.tar+0.gz</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"><span></span>tar xvzf ml-data.tar+0.gz</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">将这个文件加载到刚刚创建的表中:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
<span style="color:#0000ff;">LOAD</span> DATA LOCAL INPATH <span style="color:#ff0000;">
'ml-data/u.data' </span>OVERWRITE <span style="color:#0000ff;">INTO</span> <span style="color:#0000ff;">
TABLE</span> u_data;</div>
</div>
<br></div>
<div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">计算表 u_data 中的总行数:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
<span style="color:#0000ff;">SELECT</span> <span style="color:#0000ff;"><span style="color:#ff00ff;">COUNT</span></span>(*)<span style="color:#0000ff;">FROM</span> u_data;</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;line-height:17px;">注意不包含在 HIVE-287 中的Hive版本，你需要使用COUNT(1) 来代替 COUNT(*)</span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">现在，我们可以在表 u_data 中做一些复杂的数据分析</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">创建 weekday_mapper.py:</span></span></div>
<div>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
import sys<br>
import datetime<br>
for line in sys.stdin:<br>
    line = line.strip()<br>
    userid, movieid, rating, unixtime = line.split('\t')<br>
    weekday = datetime.datetime.fromtimestamp(float(unixtime)).isoweekday()<br>
    print '\t'.join([userid, movieid, rating, str(weekday)])</div>
</div>
<br></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">使用mapper脚本:</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
<span style="color:#0000ff;">CREATE</span> <span style="color:#0000ff;">TABLE</span> u_data_new (<br>
        userid <span style="color:#0000ff;">INT</span>,<br>
        movieid <span style="color:#0000ff;">INT</span>,<br>
        rating <span style="color:#0000ff;">INT</span>,<br>
        weekday <span style="color:#0000ff;">INT</span>)<br>
ROW FORMAT DELIMITED<br>
FIELDS TERMINATED <span style="color:#0000ff;">BY</span> <span style="color:#ff0000;">
'\t'</span>;<br><span style="color:#0000ff;">add</span> <span style="color:#0000ff;">FILE</span> weekday_mapper.py;<br><span style="color:#0000ff;">INSERT</span> OVERWRITE <span style="color:#0000ff;">TABLE</span> u_data_new<br><span style="color:#0000ff;">SELECT</span><br>
        TRANSFORM (userid, movieid, rating, unixtime)<br>
        USING <span style="color:#ff0000;">'python weekday_mapper.py'</span><br>
        <span style="color:#0000ff;">AS</span> (userid, movieid, rating, weekday)<br><span style="color:#0000ff;">FROM</span> u_data;<br><span style="color:#0000ff;">SELECT</span> weekday, <span style="color:#0000ff;"><span style="color:#ff00ff;">COUNT</span></span>(*)<br><span style="color:#0000ff;">FROM</span> u_data_new<br><span style="color:#0000ff;">GROUP</span> <span style="color:#0000ff;">BY</span> weekday;</div>
</div>
</div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;line-height:17px;">注意 0.5.0 及更早的的Hive版本，你需要使用COUNT(1) 来代替 COUNT(*)</span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Apache Web日志数据</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">Apache日志格式是可以自定义的，作为大多数网管来说都是使用默认设置。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">我们可以给默认的Apache日志创建一个如下的表</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">更多的关于正则序列化/反序列化(注: 原文!RegexSerDe) 可以在这里看到。</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;">http://issues.apache.org/jira/browse/HIVE-662</span></span></div>
<div>
<span style="font-family:Helvetica, Arial, sans-serif;"><span style="line-height:17px;"></span></span>
<div>
<div style="border-bottom:#cccccc 1px solid;border-left:#cccccc 1px solid;line-height:16px;background-color:#eeeeee;font-family:Verdana, '宋体';color:#000000;font-size:10pt;border-top:#cccccc 1px solid;border-right:#cccccc 1px solid;">
<span style="color:#0000ff;">add</span> jar ../build/contrib/hive_contrib.jar;<br><span style="color:#0000ff;">CREATE</span> <span style="color:#0000ff;">TABLE</span> apachelog (<br>
        host STRING,<br>
        identity STRING,<br>
        <span style="color:#0000ff;"><span style="color:#ff00ff;">user</span></span> STRING,<br>
        time STRING,<br>
        request STRING,<br>
        status STRING,<br>
        <span style="color:#0000ff;">size</span> STRING,<br>
        referer STRING,<br>
        agent STRING)<br>
ROW FORMAT SERDE <span style="color:#ff0000;">'org.apache.hadoop.hive.contrib.serde2.RegexSerDe'</span><br><span style="color:#0000ff;">WITH</span> SERDEPROPERTIES (<br>
        "input.regex" = "([^]*) ([^]*) ([^]*) (-|\\[^\\]*\\]) ([^ \"]*|\"[^\"]*\") (-|[0-9]*) (-|[0-9]*)(?: ([^ \"]*|\".*\") ([^ \"]*|\".*\"))?",<br>
        "output.format.string" = "%1$s %2$s %3$s %4$s %5$s %6$s %7$s %8$s %9$s"<br>
)<br>
STORED <span style="color:#0000ff;">AS</span> TEXTFILE;</div>
</div>
<br></div>
            </div>
                </div>
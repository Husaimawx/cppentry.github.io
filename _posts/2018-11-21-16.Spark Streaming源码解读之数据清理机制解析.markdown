---
layout:     post
title:      16.Spark Streaming源码解读之数据清理机制解析
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								<div class="article-copyright">
					版权声明：原创作品，允许转载，转载时请务必以超链接形式标明文章 原始出处 、作者信息和本声明，否则将追究法律责任。					https://blog.csdn.net/zhouzx2010/article/details/51801262				</div>
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-size:14pt"><span style="font-size:13.3333px; line-height:35px; font-family:Arial,Helvetica,sans-serif; color:rgb(102,102,102)"><em><span style="font-size:14pt">原创文章，转载请注明:</span></em></span><span style="font-size:13.3333px; line-height:35px; font-family:Arial,Helvetica,sans-serif; color:rgb(102,102,102)"><em><span style="font-size:14pt">转载自 <a target="_blank" href="http://blog.csdn.net/zhouzx2010" rel="nofollow">听风居士</a></span><a target="_blank" href="http://blog.csdn.net/zhouzx2010" rel="nofollow"><span style="color:#108ac6"><span style="color:rgb(0,102,170); text-decoration:none; font-size:14pt">博客</span></span><span style="font-size:14pt">(</span></a></em></span><a target="_blank" href="http://blog.csdn.net/zhouzx2010" rel="nofollow"><span style="font-size:13.3333px; line-height:24px; widows:auto; font-family:Arial,Helvetica,sans-serif; color:rgb(102,102,102)"><span style="line-height:35px"><em><span style="font-size:14pt">http://blog.csdn.net/zhouzx2010</span></em></span></span><span style="font-size:10.5pt; line-height:35px; widows:auto; color:rgb(102,102,102); font-family:Arial,Helvetica,sans-serif"><em><span style="font-size:14pt">)</span></em></span></a><strong><span style="font-size:14pt"><br>
</span></strong></span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-size:14pt"><strong>本期内容：</strong></span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-size:18.8235px"><span style="font-size:14pt">一、Spark Streaming 数据清理总览</span></span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="color:rgb(0,0,0); font-size:18.823528289794922px; widows:auto">二、<span style="font-size:14pt">Spark Streaming </span>数据清理过程详解</span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="color:rgb(0,0,0); widows:auto; font-size:18.823528289794922px">三、<span style="font-size:14pt">Spark Streaming </span>数据清理的触发机制</span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="color:rgb(0,0,0); widows:auto; font-size:18.8235px"><br>
</span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-size:12pt"><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt">    </span></span><span style="font-size:14pt">S</span></span><span style="font-size:12pt"><span style="font-size:14pt">park Streaming不像普通Spark 的应用程序，</span></span><span style="font-size:12pt"><span style="font-size:14pt">普通</span></span><span style="font-size:12pt"><span style="font-size:14pt">Spark程序运行完成后,中间数据会随着SparkContext的关闭而被销毁,</span></span><span style="font-size:12pt"><span style="font-size:14pt">而Spark
 Streaming一直在运行，不断计算，每一秒中在不断运行都会产生大量的中间数据，所以需要对对象及元数据需要定期清理。每个batch duration运行时不断触发job后需要清理rdd和元数据。下面我们就结合源码详细解析一下Spark Streaming程序的数据清理机制。</span></span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-size:12pt"><br>
</span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-size:14pt"><strong>一、数据清理总览</strong></span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-size:12pt">    Spark Streaming 运行过程中,随着时间不断产生Job,当job运行结束后,需要清理相应的数据(RDD,元数据信息,Checkpoint数据</span><span style="font-size:12pt">),Job由JobGenerator定时产生,数据的清理也是有</span><span style="font-size:12pt">JobGenerator负责。</span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
<span style="font-family:Consolas"><span style="font-size:12pt">    JobGenerator负责数据清理控制的代码位于一个消息循环体eventLoop中：</span></span><span style="font-size:12pt"><br>
</span></p>
<p style="font-family:Consolas; padding-top:0px; padding-bottom:0px; margin-top:0px; margin-bottom:0px; clear:both; height:auto; overflow:hidden; color:rgb(44,44,44); font-size:14px; line-height:28px">
</p>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    eventLoop </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">new</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">EventLoop</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">[</span></span><span class="typ" style="color:teal"><span style="font-size:12pt">JobGeneratorEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">](</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"JobGenerator"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      override </span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">protected</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def onReceive</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">event</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">JobGeneratorEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">):</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Unit</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> processEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">event</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"> </code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      override </span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">protected</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def onError</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Throwable</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">):</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Unit</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">reportError</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Error in job generator"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    eventLoop</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">start</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()</span></span></code></div></div></pre>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<br>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt">其中的核心逻辑位于processEvent(event</span><span style="font-size:14px; line-height:28px"><span style="font-size:12pt">)函数中:</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">/** Processes all events */</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def processEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">event</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">JobGeneratorEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Got event "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> event</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    event match </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">GenerateJobs</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> generateJobs</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">ClearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">DoCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        doCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">ClearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt">可以看到当JobGenerator收到ClearMetadata(time) 和 ClearCheckpointData(time)是会进行相应的数据清理,其中 </span><span class="pln" style="color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">)</span></span><span style="font-size:14px; line-height:28px"><span style="font-size:12pt">会清理RDD数据和一些元数据信息,
 C</span></span><span class="pln" style="color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">learCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt">)</span></span><span style="font-size:14px; line-height:28px"><span style="font-size:12pt">会清理Checkpoint数据。</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:14pt"><strong>二、数据清理过程详解</strong></span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-family:Consolas"><span style="font-size:12pt">    <strong>2.1 ClearMetaData 过程详解</strong></span></span><span style="font-size:14px; line-height:28px"><span style="font-size:14pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-family:Consolas"><span style="font-size:12pt">首先看一下clearMetaData函数的处理逻辑：</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">/** Clear DStream metadata for the given `time`. */</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"> </code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// If checkpointing is enabled, then checkpoint,</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// else mark batch to be fully processed</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">shouldCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      eventLoop</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">post</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="typ" style="color:teal"><span style="font-size:12pt">DoCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">true</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">else</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// If checkpointing is not enabled, then delete metadata information about</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// received blocks (block data not saved in any case). Otherwise, wait for</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// checkpointing of this batch to complete.</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      val maxRememberDuration </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getMaxInputStreamRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">receiverTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanupOldBlocksAndBatches</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">inputInfoTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      markBatchFullyProcessed</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt">首先调用了DStreamGraph的clearMetadata方法:</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<br>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">  def clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Clearing metadata for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">this</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">synchronized</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      outputStreams</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">foreach</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Cleared old metadata for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="line-height:27.996322631835938px"><span style="font-size:12pt">这里调用了所有OutputDStream (关于DStream 的分类请参考</span></span><a target="_blank" href="http://blog.csdn.net/zhouzx2010/article/details/51460790" rel="nofollow" style="font-size:12pt; line-height:1.5"><span style="font-size:12pt">http://blog.csdn.net/zhouzx2010/article/details/51460790</span></a><span style="line-height:27.996322631835938px; font-size:12pt">)的clearMetadata方法</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">[</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">streaming</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">]</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    val unpersistData </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">conf</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getBoolean</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"spark.streaming.unpersist"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">true</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)">     <span style="color:#ff0000"><span style="font-size:12pt">//获取需要清理的RDD</span></span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    val oldRDDs </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> generatedRDDs</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">filter</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_1 </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">&lt;=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> rememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Clearing references to old RDDs: ["</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      oldRDDs</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">map</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">x </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> s</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"${x._1} -&gt; ${x._2.id}"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">).</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">mkString</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">", "</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"]"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">
</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)">    <span style="color:#ff0000"><span style="font-size:12pt">//将要清除的RDD从generatedRDDs 中清除 </span></span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    generatedRDDs </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">--=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> oldRDDs</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">keys</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">unpersistData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">s</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Unpersisting old RDDs: ${oldRDDs.values.map(_.id).mkString("</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">")}"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      oldRDDs</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">values</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">foreach </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> rdd </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt"><span style="font-family:Consolas">      <span style="color:#ff0000">//将RDD 从persistence列表中移除</span></span></span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        rdd</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">unpersist</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">false</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">        </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// Explicitly remove blocks of BlockRDD</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        rdd match </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">          </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> b</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">BlockRDD</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">[</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">]</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">            logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">s</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Removing blocks of RDD $b of time $time"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">            <span style="color:#ff0000">//移除RDD的block 数据</span></span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">            b</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">removeBlocks</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">          </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> _ </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">        </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">s</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Cleared ${oldRDDs.size} RDDs that were older than "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      s</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"${time - rememberDuration}: ${oldRDDs.keys.mkString("</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">")}"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">    <span style="color:#ff0000">//清除依赖的DStream</span></span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    dependencies</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">foreach</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt">关键的清理逻辑在代码中做了详细注释,首先清理DStream对应的RDD的元数据信息,然后清理RDD的数据,最后对DStream所依赖的DStream进行清理。</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt">回到JobGenerator的clearMetadata函数：</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">shouldCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      eventLoop</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">post</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="typ" style="color:teal"><span style="font-size:12pt">DoCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">true</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">else</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// If checkpointing is not enabled, then delete metadata information about</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// received blocks (block data not saved in any case). Otherwise, wait for</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// checkpointing of this batch to complete.</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      val maxRememberDuration </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getMaxInputStreamRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">receiverTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanupOldBlocksAndBatches</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">inputInfoTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      markBatchFullyProcessed</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="line-height:27.996322631835938px">调用了ReceiverTracker的 </span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt">cleanupOldBlocksAndBatches</span><span style="line-height:27.996322631835938px; font-size:12pt">方法，最后调用了clearupOldBatches方法：</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="line-height:27.996322631835938px; font-size:12pt"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">  def cleanupOldBatches</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanupThreshTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> waitForCompletion</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Boolean</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">):</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Unit</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">synchronized</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    require</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanupThreshTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">milliseconds </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">&lt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clock</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getTimeMillis</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">())</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    val timesToCleanup </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> timeToAllocatedBlocks</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">keys</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">filter </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> _ </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">&lt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> cleanupThreshTime </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">toSeq</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">s</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Deleting batches: ${timesToCleanup.mkString("</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">")}"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">writeToLog</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="typ" style="color:teal"><span style="font-size:12pt">BatchCleanupEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">timesToCleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)))</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">     <span style="color:#ff0000"> //将要删除的Batch数据清除</span></span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      timeToAllocatedBlocks </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">--=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> timesToCleanup</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      <span style="color:#ff0000">//清理WAL日志</span></span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      writeAheadLogOption</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">foreach</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clean</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanupThreshTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">milliseconds</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> waitForCompletion</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">else</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      logWarning</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Failed to acknowledge batch clean up in the Write Ahead Log."</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
可以看到<span style="line-height:27.996322631835938px; font-size:12pt">ReceiverTracker的</span><span style="line-height:27.996322631835938px; font-size:12pt">clearupOldBatches方法</span><span style="font-size:12pt; line-height:1.5">清理了Receiver数据,也就是Batch数据和WAL日志数据。</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
最后对InputInfoTracker信息进行清理：</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">  def cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">batchThreshTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">):</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Unit</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">synchronized</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    val timesToCleanup </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> batchTimeToInputInfos</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">keys</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">filter</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_ </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">&lt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> batchThreshTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">s</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"remove old batch metadata: ${timesToCleanup.mkString("</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">")}"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    batchTimeToInputInfos </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">--=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> timesToCleanup</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
这简单的清除了<span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt">batchTimeToInputInfos
</span><span style="font-family:Consolas,Liberation Mono,Menlo,Courier,monospace; color:#48484c; font-size:12pt; line-height:1.5"><span style="line-height:17.996322631835938px; white-space:pre">的输入信息。</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-family:Consolas,Liberation Mono,Menlo,Courier,monospace; color:#48484c; font-size:12pt; line-height:1.5"><span style="line-height:17.996322631835938px; white-space:pre"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<strong>2.2 ClearCheckPoint 过程详解</strong><span style="font-family:Consolas,Liberation Mono,Menlo,Courier,monospace; color:#48484c; font-size:12pt; line-height:1.5"><span style="line-height:17.996322631835938px; white-space:pre"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)">看一下clearCheckpointData的处理逻辑:</span><strong><br>
</strong></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">/** Clear DStream checkpoint data for the given `time`. */</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def clearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"> </code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// All the checkpoint information about which batches have been processed, etc have</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// been saved to checkpoints, so its safe to delete block metadata and data WAL files</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    val maxRememberDuration </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getMaxInputStreamRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">receiverTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanupOldBlocksAndBatches</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">inputInfoTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    markBatchFullyProcessed</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
<div><span style="font-size:14pt">后面的ReceiverTraker和InputInforTracker的清理逻辑和ClearMetaData的相同,这分析DStreamGraph的clearCheckpointData方法:</span></div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<br>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">  def clearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Clearing checkpoint data for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">this</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">synchronized</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      outputStreams</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">foreach</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Cleared checkpoint data for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt">同样的调用了</span><span style="font-size:12pt; line-height:1.5">DStreamGraph中所有OutputDStream的clearCheckPiontData 方法:</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">[</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">streaming</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">]</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def clearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Clearing checkpoint data"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    <span style="background-color:rgb(255,215,0)"><span style="font-size:12pt">checkpointData</span></span></span></span><span style="background-color:rgb(255,215,0)"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    dependencies</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">foreach</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Cleared checkpoint data"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt">这里的核心逻辑在</span><span class="pln" style="color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(247,247,249)"><span style="font-size:12pt"><span style="background-color:rgb(255,215,0)"><span style="font-size:12pt">checkpointData</span></span></span></span><span style="color:rgb(190,190,197); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre; background-color:rgb(255,215,0)"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></span><span style="font-size:12pt; line-height:1.5">方法,这里的CheckpointData
 是 DStreamCheckpointData对象,</span><span style="font-size:12pt; line-height:1.5"> DStreamCheckpointData的clearup方法如下:</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">def cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt"><span style="color:#ff0000">// 获取需要清理的Checkpoint 文件 时间</span></span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    timeToOldestCheckpointFileTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">remove</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> match </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Some</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">lastCheckpointFileTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">        <span style="font-size:14px; color:#ff0000">//获取需要删除的文件</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        val filesToDelete </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> timeToCheckpointFile</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">filter</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_1 </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">&lt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> lastCheckpointFileTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Files to delete:\n"</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> filesToDelete</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">mkString</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">","</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        filesToDelete</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">foreach </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">          </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> file</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">            </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">try</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">              val path </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">new</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Path</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">file</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">              </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">fileSystem </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">==</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">null</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">                fileSystem </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> path</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getFileSystem</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">dstream</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">sparkContext</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">hadoopConfiguration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">              </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">          /<span style="color:#ff0000"><span style="font-size:12pt">/</span></span></span></span></code><span style="font-family:Consolas"><span style="color:#ff0000"><span style="font-size:12pt"> </span><strong><span style="font-size:12pt"> 删除文件</span></strong></span><strong><span style="font-size:12pt">  </span></strong></span><span style="font-family:Consolas"><strong> </strong>  </span></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">              fileSystem</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">delete</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">path</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">true</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">              timeToCheckpointFile </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">              logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Deleted checkpoint file '"</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> file </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"' for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">            </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">catch</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">              </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Exception</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">                logWarning</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Error deleting old checkpoint file '"</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> file </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"' for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">                fileSystem </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">null</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">            </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">        </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">None</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        logDebug</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Nothing to delete"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
<div>可以看到checkpoint的清理,就是删除了指定时间以前的checkpoint文件。</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:18.823528289794922px; line-height:27.996322631835938px">三、数据清理的触发</span><br>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-family:Consolas">    3</span><span style="font-size:12pt; line-height:1.5">.1 ClearMetaData 过程的触发<br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5">JobGenerator 生成job后,交给JobHandler执行,</span><span style="font-size:12pt; line-height:1.5"> JobHandler的run方法中,会在job执行完后给JobScheduler 发送JobCompleted消息:</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">          _eventLoop </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> eventLoop</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">          </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">_eventLoop </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">!=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">null</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">            _eventLoop</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">post</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="typ" style="color:teal"><span style="font-size:12pt">JobCompleted</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">job</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clock</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getTimeMillis</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()))</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"> </code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">          </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
JobScheduler 收到<span style="font-size:12pt; line-height:1.5">JobCompleted </span><span style="font-size:12pt; line-height:1.5">消息调用 </span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt">handleJobCompletion
</span><span style="font-size:12pt; line-height:1.5">方法,源码如下:</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def processEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">event</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">JobSchedulerEvent</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">try</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      event match </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">        </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">JobStarted</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">job</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> startTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> handleJobStart</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">job</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> startTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">        </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">JobCompleted</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">job</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> completedTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> handleJobCompletion</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">job</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> completedTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">        </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">ErrorReported</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">m</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> handleError</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">m</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">catch</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Throwable</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        reportError</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Error in job scheduler"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> e</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)">}</span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt">在 JobScheduler 的handleJobCompletion方法中会调用JobGenerator的</span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre"><span style="font-size:12pt">onBatchCompletion</span></span><span style="font-size:12pt; line-height:1.5">方法,我们看一下</span><span style="font-size:12pt; line-height:1.5">JobGenerator的 </span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre"><span style="font-size:12pt">onBatchCompletion
</span></span><span style="font-size:12pt; line-height:1.5">方法的源码:</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  def onBatchCompletion</span><span class="pun" style="color:rgb(147,161,161)">(</span><span class="pln" style="color:rgb(72,72,76)">time</span><span class="pun" style="color:rgb(147,161,161)">:</span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal">Time</span><span class="pun" style="color:rgb(147,161,161)">)</span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)">{</span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    eventLoop</span><span class="pun" style="color:rgb(147,161,161)">.</span><span class="pln" style="color:rgb(72,72,76)">post</span><span class="pun" style="color:rgb(147,161,161)">(</span><span class="typ" style="color:teal">ClearMetadata</span><span class="pun" style="color:rgb(147,161,161)">(</span><span class="pln" style="color:rgb(72,72,76)">time</span><span class="pun" style="color:rgb(147,161,161)">))</span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)">}</span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
可以看到<span style="font-size:12pt; line-height:1.5">JobGenerator的</span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre"><span style="font-size:12pt">onBatchCompletion</span></span><span style="font-size:12pt; line-height:1.5">方法给自己发送了ClearMetadata消息从而触发了ClearMetaData操作。</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5">3.2 ClearCheckPoint 过程的触发</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-family:Consolas">    清理CheckPoint数据发生在CheckPoint完成之后,我们先看一下CheckPointHandler的run方法:</span><span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-family:Consolas"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">          </span><span class="com" style="color:rgb(147,161,161)"><span style="font-size:12pt">// All done, print success</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">          val finishTime </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">System</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">currentTimeMillis</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">          logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Checkpoint for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> checkpointTime </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">" saved to file '"</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> checkpointFile </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">            </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"', took "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> bytes</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">length </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">" bytes and "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">finishTime </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> startTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">" ms"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)">          <span style="color:#ff0000"><span style="font-size:12pt">//调用JobGenerator的方法进行checkpoint数据清理</span></span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">          jobGenerator</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">onCheckpointCompletion</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">checkpointTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">          </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">return</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt">可以看到在checkpoint完成后,会调用JobGenerator的onCheckpointCompletion方法进行checkpoint数据清理,我查看</span><span style="font-size:12pt; line-height:1.5">JobGenerator的onCheckpointCompletion方法源码:</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">  def onCheckpointCompletion</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Boolean</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      eventLoop</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">post</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="typ" style="color:teal"><span style="font-size:12pt">ClearCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14pt">可以看到</span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt">JobGenerator的onCheckpointCompletion方法中首先对传进来的 </span></span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt"><span style="font-size:14pt">clearCheckpointDataLater
</span></span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt">参数进行判断,如果该参数为true,就会给JobGenerator的eventLoop循环体发送ClearCheckpointData消息,从而触发</span></span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt"><span style="font-size:14pt">clearCheckpointData</span></span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt"> 方法的调用,进行Checkpoint数据的清理。</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt">什么时候该参数会true呢？</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt">我们回到JobGenerator的 </span></span><span style="background-color:rgb(247,247,249); color:rgb(0,128,128); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; font-size:12.941176414489746px; line-height:17.996322631835938px; white-space:pre"><span style="font-size:14pt">ClearMetadata</span></span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt"> 方法：</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">    ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">clearMetadata</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"> </code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none">
</div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">shouldCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">      <span style="color:#ff0000">//发送DoCheckpoint消息,并进行相应的Checkpoint数据清理</span></span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      eventLoop</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">post</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="typ" style="color:teal"><span style="font-size:12pt">DoCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">true</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">else</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none">
</div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      val maxRememberDuration </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">getMaxInputStreamRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">()</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">receiverTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanupOldBlocksAndBatches</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      jobScheduler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">inputInfoTracker</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">cleanup</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> maxRememberDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      markBatchFullyProcessed</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
可以看到在clearMetadata方法中,发送了DoCheckpoint消息,其中参数 <span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt">clearCheckpointDataLater</span><span style="font-size:12pt; line-height:1.5"> 为ture。Generator的eventLoop收到该消息后调用 </span><span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt">doCheckpoint</span><span style="font-size:12pt; line-height:1.5"> 方法：</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">private</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> def doCheckpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Boolean</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">if</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">shouldCheckpoint </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">&amp;&amp;</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">-</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">zeroTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">).</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">isMultipleOf</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">checkpointDuration</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Checkpointing graph for time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">graph</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">updateCheckpointData</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      checkpointWriter</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">write</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">new</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Checkpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">ssc</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> time</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">),</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
这里关键一步：调用了CheckpointWriter的write方法,注意此时参数 <span style="background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt">clearCheckpointDataLater</span><span style="font-size:12pt; line-height:1.5"> 为true。我们进入该方法：</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:12pt; line-height:1.5"><br>
</span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<div>
<pre class="prettyprint linenums prettyprinted" style="font-size:13px; font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word; background-color:rgb(247,247,249); padding:10px; border:1px solid rgb(225,225,232)"><div class="linenums" style="color:rgb(30,52,123); margin-top:0px; margin-bottom:0px; padding-left:0px"><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">  def write</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">checkpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Checkpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Boolean</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L1" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">try</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      val bytes </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">Checkpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">serialize</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">checkpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> conf</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L2" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><span style="font-size:14px; color:#ff0000">     //将参数<span style="font-size:16.47058868408203px">clearCheckpointDataLater</span>传入CheckpoitWriteHandler</span></div><div class="L3" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      executor</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">execute</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">new</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">CheckpointWriteHandler</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span></code></div><div class="L4" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        checkpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">checkpointTime</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> bytes</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> clearCheckpointDataLater</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">))</span></span></code></div><div class="L5" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">      logInfo</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Submitted checkpoint of time "</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> checkpoint</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">.</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">checkpointTime </span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">+</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">" writer queue"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L6" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">catch</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">{</span></span></code></div><div class="L7" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">      </span><span class="kwd" style="color:rgb(30,52,123)"><span style="font-size:12pt">case</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> rej</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">:</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="typ" style="color:teal"><span style="font-size:12pt">RejectedExecutionException</span></span><span class="pln" style="color:rgb(72,72,76)"> </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">=&gt;</span></span></code></div><div class="L8" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt">        logError</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">(</span></span><span class="str" style="color:rgb(221,17,68)"><span style="font-size:12pt">"Could not submit checkpoint task to the thread pool executor"</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">,</span></span><span class="pln" style="color:rgb(72,72,76)"><span style="font-size:12pt"> rej</span></span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">)</span></span></code></div><div class="L9" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">    </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div><div class="L0" style="color:rgb(190,190,197); line-height:18px; padding-left:0px; list-style-type:none"><code class="language-java" style="font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; word-wrap:break-word"><span class="pln" style="color:rgb(72,72,76)">  </span><span class="pun" style="color:rgb(147,161,161)"><span style="font-size:12pt">}</span></span></code></div></div></pre>
</div>
<div><br>
</div>
</div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14pt">可以看到此时参数 </span><span style="font-size:12pt; background-color:rgb(247,247,249); color:rgb(72,72,76); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre"><span style="font-size:14pt">clearCheckpointDataLater</span></span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt"> </span></span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt">传入</span></span><span style="background-color:rgb(247,247,249); color:rgb(0,128,128); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt"><span style="font-size:14pt">CheckpointWriteHandler</span></span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt"> 。这样Checkpoint完成之后就会发送</span></span><span style="background-color:rgb(247,247,249); color:rgb(0,128,128); font-family:Consolas,'Liberation Mono',Menlo,Courier,monospace; line-height:17.996322631835938px; white-space:pre; font-size:12pt"><span style="font-size:14pt">ClearCheckpointData</span></span><span style="font-size:12pt; line-height:1.5"><span style="font-size:14pt">消息给JobGenerator进行Checkpoint数据的清理。</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:14px; line-height:28px"><span style="font-size:12pt"><br>
</span></span></div>
<div style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<span style="font-size:13.3333px; line-height:35px; font-family:Arial,Helvetica,sans-serif; color:rgb(102,102,102)"><em><span style="font-size:14pt"></span></em></span><span style="font-size:13.3333px; line-height:35px; color:rgb(102,102,102)"><em><span style="font-size:14pt">原创文章，转载请注明:</span></em></span><span style="font-size:13.3333px; line-height:35px; color:rgb(102,102,102)"><em><span style="font-size:14pt">转载自 <a target="_blank" href="http://blog.csdn.net/zhouzx2010" rel="nofollow">听风居士</a></span><a target="_blank" href="http://blog.csdn.net/zhouzx2010" rel="nofollow"><span style="color:rgb(16,138,198)"><span style="color:rgb(0,102,170); text-decoration:none; font-size:14pt">博客</span></span><span style="font-size:14pt">(</span></a></em></span><a target="_blank" href="http://blog.csdn.net/zhouzx2010" rel="nofollow" style="font-family:Consolas; font-size:18.6667px; line-height:28px"><span style="font-family:Arial,Helvetica,sans-serif; font-size:13.3333px; line-height:24px; widows:auto; color:rgb(102,102,102)"><span style="line-height:35px"><em><span style="font-size:14pt">http://blog.csdn.net/zhouzx2010</span></em></span></span><span style="font-family:Arial,Helvetica,sans-serif; font-size:10.5pt; line-height:35px; widows:auto; color:rgb(102,102,102)"><em><span style="font-size:14pt">)</span></em></span></a></div>
<br style="font-family:Consolas; font-size:16.4706px; line-height:28.2353px; widows:auto">
<small style="font-family:Consolas; widows:auto"><small> </small></small>
            </div>
                </div>
---
layout:     post
title:      实时系统HBase读写优化--大量写入无障碍
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">在使用hbase过程中发现在写入hbase的数据量很大时，经常发生写不进去的情况。而我们基于hbase的应用是对实时性要求很高的，一旦hbase不能读写则会大大影响系统的使用。下面将记录hbase写优化的过程。</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">1.禁止Major Compaction</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">在hbase进行Major Compaction时，该region将合并所有的storefile，因此整个region都不可读，所有对此region的查询都会block。HBase默认一天左右执行一次Major Compaction。我们将Major Compaction禁掉并用Cron脚本每天在系统空闲时对所有表执行major compaction。</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">Major Compaction的配置：</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<div class="dp-highlighter bg_html" style="font-family:Consolas, 'Courier New', Courier, mono, serif;overflow:auto;color:rgb(51,51,51);line-height:26px;background-color:rgb(231,229,220);">
<div class="bar">
<div class="tools" style="font-size:9px;line-height:normal;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:#C0C0C0;border-left-width:3px;border-left-style:solid;border-left-color:rgb(108,226,108);background-color:rgb(248,248,248);">
<strong>[html]</strong> <a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="ViewSource" title="view plain" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">view
 plain</a><a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="CopyToClipboard" title="copy" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">copy</a>
<div style="width:18px;z-index:99;">
</div>
</div>
</div>
<ol start="1" class="dp-xml" style="border:none;color:rgb(92,92,92);background-color:rgb(255,255,255);"><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">span</span><span style="border:none;background-color:inherit;"> </span><span class="attribute" style="border:none;color:#FF0000;background-color:inherit;">style</span><span style="border:none;background-color:inherit;">=</span><span class="attribute-value" style="border:none;color:#0000FF;background-color:inherit;">"font-size:18px;"</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">property</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">name</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">hbase.hregion.majorcompaction</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">name</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">value</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">0</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">value</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">property</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">span</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li></ol></div>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">默认是1天，每个region会在创建时以当前时间初始化regionMajorCompactionTime，并将下一次的major compaction时间设为1+-0.2天。配置中将此值设为0禁止major compaction。</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">major_compaction的脚本：取出所有table，一一执行major_compact：</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<div class="dp-highlighter bg_java" style="font-family:Consolas, 'Courier New', Courier, mono, serif;overflow:auto;color:rgb(51,51,51);line-height:26px;background-color:rgb(231,229,220);">
<div class="bar">
<div class="tools" style="font-size:9px;line-height:normal;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:#C0C0C0;border-left-width:3px;border-left-style:solid;border-left-color:rgb(108,226,108);background-color:rgb(248,248,248);">
<strong>[java]</strong> <a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="ViewSource" title="view plain" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">view
 plain</a><a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="CopyToClipboard" title="copy" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">copy</a>
<div style="width:18px;z-index:99;">
</div>
</div>
</div>
<ol start="1" class="dp-j" style="border:none;color:rgb(92,92,92);background-color:rgb(255,255,255);"><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span style="border:none;background-color:inherit;">&lt;span style=</span><span class="string" style="border:none;color:#0000FF;background-color:inherit;">"font-size:18px;"</span><span style="border:none;background-color:inherit;">&gt;TMP_FILE=tmp_tables  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">TABLES_FILE=tables.txt  </span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">  </span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">echo <span class="string" style="border:none;color:#0000FF;background-color:inherit;">"list"</span><span style="border:none;background-color:inherit;"> | hbase shell &gt; tmp_tables  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">sleep <span class="number" style="border:none;color:rgb(192,0,0);background-color:inherit;">2</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">sed <span class="string" style="border:none;color:#0000FF;background-color:inherit;">'1,6d'</span><span style="border:none;background-color:inherit;"> $TMP_FILE | tac | sed </span><span class="string" style="border:none;color:#0000FF;background-color:inherit;">'1,2d'</span><span style="border:none;background-color:inherit;"> | tac &gt; $TABLES_FILE  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">sleep <span class="number" style="border:none;color:rgb(192,0,0);background-color:inherit;">2</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">  </span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">for</span><span style="border:none;background-color:inherit;"> table in $(cat $TABLES_FILE); </span><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">do</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">        echo <span class="string" style="border:none;color:#0000FF;background-color:inherit;">"major_compact '$table'"</span><span style="border:none;background-color:inherit;"> | hbase shell  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">        sleep <span class="number" style="border:none;color:rgb(192,0,0);background-color:inherit;">10</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">done&lt;/span&gt;  </span></li></ol></div>
<span style="color:rgb(51,51,51);font-family:Arial;line-height:26px;font-size:18px;">2.禁掉split</span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"></span>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">hbase通过split region实现水平的sharding，但在split的过程中旧的region会下线，新region还会做compaction，中间有一段时间大量的数据不能被读写，这对于我们这种online系统是不能忍受的。我们同样禁掉自动的split，而在晚上系统空闲时执行我们的splittool手动的split。</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">禁止split的配置：</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<div class="dp-highlighter bg_html" style="font-family:Consolas, 'Courier New', Courier, mono, serif;overflow:auto;color:rgb(51,51,51);line-height:26px;background-color:rgb(231,229,220);">
<div class="bar">
<div class="tools" style="font-size:9px;line-height:normal;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:#C0C0C0;border-left-width:3px;border-left-style:solid;border-left-color:rgb(108,226,108);background-color:rgb(248,248,248);">
<strong>[html]</strong> <a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="ViewSource" title="view plain" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">view
 plain</a><a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="CopyToClipboard" title="copy" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">copy</a>
<div style="width:18px;z-index:99;">
</div>
</div>
</div>
<ol start="1" class="dp-xml" style="border:none;color:rgb(92,92,92);background-color:rgb(255,255,255);"><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">span</span><span style="border:none;background-color:inherit;"> </span><span class="attribute" style="border:none;color:#FF0000;background-color:inherit;">style</span><span style="border:none;background-color:inherit;">=</span><span class="attribute-value" style="border:none;color:#0000FF;background-color:inherit;">"font-size:18px;"</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;"> </span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">property</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;"> <span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">name</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">hbase.hregion.max.filesize</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">name</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"> <span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">value</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">536870912000</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">value</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;"> <span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">property</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">span</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li></ol></div>
<span style="color:rgb(51,51,51);font-family:Arial;line-height:26px;font-size:18px;">配置项的含义是当region的大小大于设定值后hbase就会开始split，我们将此值设为500G，我们认为在白天系统繁忙时一个region不会超过此大小，在晚上时运行splittool将region分割开。</span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"></span>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">splittool的逻辑比较简单。遍历所有region的信息，如果region大小大于某值（比如1G）则split该region，这样为一轮split，如果一轮后没有大于某值的region则结束，如果还有大于某个值的region则继续新一轮split，直到没有region大于某个阈值为止。这里提一下判断split完成的方法：通过检查hdfs上旧region的文件夹是否被清除来判断split是否结束。</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">3.设置blockingStoreFiles</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">这个参数的重要性是在我们的性能测试中发现的。我们禁掉major_compaction和split后理论上写入应该无障碍了，但在测试中发现写入单个region速度大于10M/s时还是会出现长时间无法写入的情况。通过查看log，我们发现了这行log<span style="color:rgb(255,0,0);">“Waited 90314ms on a compaction to clean up 'too many store  files'”，</span>通过查看代码发现原来是blockingStoreFiles这个参数在作怪。</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;">在flushRegion时会检测当前store中hfile的数量是否大于此值，如果大于则会block数据的写入，等待其他线程将hfile compact掉。这样，如果写入速度超过compact的速度，hbase就会阻止该region的数据写入。</span></p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<div class="dp-highlighter bg_java" style="font-family:Consolas, 'Courier New', Courier, mono, serif;overflow:auto;color:rgb(51,51,51);line-height:26px;background-color:rgb(231,229,220);">
<div class="bar">
<div class="tools" style="font-size:9px;line-height:normal;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:#C0C0C0;border-left-width:3px;border-left-style:solid;border-left-color:rgb(108,226,108);background-color:rgb(248,248,248);">
<strong>[java]</strong> <a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="ViewSource" title="view plain" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">view
 plain</a><a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="CopyToClipboard" title="copy" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">copy</a>
<div style="width:18px;z-index:99;">
</div>
</div>
</div>
<ol start="1" class="dp-j" style="border:none;color:rgb(92,92,92);background-color:rgb(255,255,255);"><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span style="border:none;background-color:inherit;">&lt;span style=</span><span class="string" style="border:none;color:#0000FF;background-color:inherit;">"font-size:18px;"</span><span style="border:none;background-color:inherit;">&gt;</span><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">private</span><span style="border:none;background-color:inherit;"> </span><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">boolean</span><span style="border:none;background-color:inherit;"> flushRegion(</span><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">final</span><span style="border:none;background-color:inherit;"> FlushRegionEntry fqe) {  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">    HRegion region = fqe.region;  </span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">    <span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">if</span><span style="border:none;background-color:inherit;"> (!fqe.region.getRegionInfo().isMetaRegion() &amp;&amp;  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">        isTooManyStoreFiles(region)) {  </span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">      <span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">if</span><span style="border:none;background-color:inherit;"> (fqe.isMaximumWait(</span><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">this</span><span style="border:none;background-color:inherit;">.blockingWaitTime)) {  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">        LOG.info(<span class="string" style="border:none;color:#0000FF;background-color:inherit;">"Waited "</span><span style="border:none;background-color:inherit;"> + (System.currentTimeMillis() - fqe.createTime) +  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">          <span class="string" style="border:none;color:#0000FF;background-color:inherit;">"ms on a compaction to clean up 'too many store files'; waited "</span><span style="border:none;background-color:inherit;"> +  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">          <span class="string" style="border:none;color:#0000FF;background-color:inherit;">"long enough... proceeding with flush of "</span><span style="border:none;background-color:inherit;"> +  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">          region.getRegionNameAsString());  </span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">      } &lt;/span&gt;  </span></li></ol></div>
<span style="color:rgb(51,51,51);font-family:Arial;line-height:26px;font-size:18px;">默认值为7<br></span>
<div class="dp-highlighter bg_java" style="font-family:Consolas, 'Courier New', Courier, mono, serif;overflow:auto;color:rgb(51,51,51);line-height:26px;background-color:rgb(231,229,220);">
<div class="bar">
<div class="tools" style="font-size:9px;line-height:normal;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:#C0C0C0;border-left-width:3px;border-left-style:solid;border-left-color:rgb(108,226,108);background-color:rgb(248,248,248);">
<strong>[java]</strong> <a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="ViewSource" title="view plain" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">view
 plain</a><a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="CopyToClipboard" title="copy" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">copy</a>
<div style="width:18px;z-index:99;">
</div>
</div>
</div>
<ol start="1" class="dp-j" style="border:none;color:rgb(92,92,92);background-color:rgb(255,255,255);"><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span style="border:none;background-color:inherit;">&lt;span style=</span><span class="string" style="border:none;color:#0000FF;background-color:inherit;">"font-size:18px;"</span><span style="border:none;background-color:inherit;">&gt;</span><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">this</span><span style="border:none;background-color:inherit;">.blockingStoreFilesNumber =  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">      conf.getInt(<span class="string" style="border:none;color:#0000FF;background-color:inherit;">"hbase.hstore.blockingStoreFiles"</span><span style="border:none;background-color:inherit;">, </span><span class="number" style="border:none;color:rgb(192,0,0);background-color:inherit;">7</span><span style="border:none;background-color:inherit;">);  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">    <span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">if</span><span style="border:none;background-color:inherit;"> (</span><span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">this</span><span style="border:none;background-color:inherit;">.blockingStoreFilesNumber == -</span><span class="number" style="border:none;color:rgb(192,0,0);background-color:inherit;">1</span><span style="border:none;background-color:inherit;">) {  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">      <span class="keyword" style="border:none;color:rgb(0,102,153);font-weight:bold;background-color:inherit;">this</span><span style="border:none;background-color:inherit;">.blockingStoreFilesNumber = </span><span class="number" style="border:none;color:rgb(192,0,0);background-color:inherit;">1</span><span style="border:none;background-color:inherit;"> +  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;">        conf.getInt(<span class="string" style="border:none;color:#0000FF;background-color:inherit;">"hbase.hstore.compactionThreshold"</span><span style="border:none;background-color:inherit;">, </span><span class="number" style="border:none;color:rgb(192,0,0);background-color:inherit;">3</span><span style="border:none;background-color:inherit;">);  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;">    }&lt;/span&gt;  </span></li></ol></div>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
<span style="font-size:18px;"><br></span></p>
<span style="color:rgb(51,51,51);font-family:Arial;line-height:26px;font-size:18px;">我们将此值设为很大的值，使得此问题不会block我们的写入。</span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;"></span>
<p style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
</p>
<div class="dp-highlighter bg_html" style="font-family:Consolas, 'Courier New', Courier, mono, serif;overflow:auto;background-color:rgb(231,229,220);">
<div class="bar" style="color:rgb(51,51,51);line-height:26px;">
<div class="tools" style="font-size:9px;line-height:normal;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:#C0C0C0;border-left-width:3px;border-left-style:solid;border-left-color:rgb(108,226,108);background-color:rgb(248,248,248);">
<strong>[html]</strong> <a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="ViewSource" title="view plain" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">view
 plain</a><a href="http://blog.csdn.net/mrtitan/article/details/8660280#" rel="nofollow" class="CopyToClipboard" title="copy" style="color:rgb(160,160,160);text-decoration:none;border:none;display:inline-block;width:16px;text-indent:-2000px;background-color:inherit;">copy</a>
<div style="width:18px;z-index:99;">
</div>
</div>
</div>
<ol start="1" class="dp-xml" style="color:rgb(92,92,92);line-height:26px;border:none;background-color:rgb(255,255,255);"><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">span</span><span style="border:none;background-color:inherit;"> </span><span class="attribute" style="border:none;color:#FF0000;background-color:inherit;">style</span><span style="border:none;background-color:inherit;">=</span><span class="attribute-value" style="border:none;color:#0000FF;background-color:inherit;">"font-size:18px;"</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">property</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">name</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">hbase.hstore.blockingStoreFiles</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">name</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;color:inherit;line-height:18px;">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">value</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">2100000000</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">value</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li></ol><p></p>
<ol start="1" class="dp-xml" style="color:rgb(92,92,92);line-height:26px;border:none;background-color:rgb(255,255,255);"><li style="border-style:none none none solid;border-left-width:3px;border-left-color:rgb(108,226,108);list-style:outside;line-height:18px;background-color:rgb(248,248,248);">
<span style="border:none;color:#000000;background-color:inherit;"><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">property</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&lt;/</span><span class="tag-name" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">span</span><span class="tag" style="border:none;color:rgb(153,51,0);font-weight:bold;background-color:inherit;">&gt;</span><span style="border:none;background-color:inherit;">  </span></span></li></ol><div><span style="color:#993300;"><span style="line-height:18px;"><strong><br></strong></span></span></div>
<div><span style="color:#993300;"><span style="line-height:18px;"><strong><br></strong></span></span></div>
<div><span style="color:#993300;"><span style="line-height:18px;"><strong>http://blog.csdn.net/mrtitan/article/details/8660280<br></strong></span></span></div>
<p></p>
</div>
            </div>
                </div>
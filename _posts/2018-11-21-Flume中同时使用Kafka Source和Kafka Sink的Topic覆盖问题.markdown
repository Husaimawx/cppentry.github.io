---
layout:     post
title:      Flume中同时使用Kafka Source和Kafka Sink的Topic覆盖问题
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
转载：<a href="http://lxw1234.com/" rel="nofollow" title="" style="color:rgb(217,83,79);text-decoration:none;font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">lxw的大数据田地</a><span style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;"> » </span><a href="http://lxw1234.com/archives/2016/06/684.htm" rel="nofollow" title="" style="color:rgb(0,166,124);text-decoration:none;font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">Flume中同时使用Kafka
 Source和Kafka Sink的Topic覆盖问题</a></p>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
<br></p>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
如果在一个Flume Agent中同时使用Kafka Source和Kafka Sink来处理events，便会遇到Kafka Topic覆盖问题，具体表现为，Kafka Source可以正常从指定的Topic中读取数据，但在Kafka Sink中配置的目标Topic不起作用，数据仍然会被写入到Source中指定的Topic中。</p>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
比如：在Agent中的Kafka Source配置Topic为：<br>
agent_myAgent.sources.kafkaSource.topic = sourceTopic<br>
在Kafka Sink配置Topic为：<br>
agent_myAgent.sinks.kafkaSink.topic = sinkTopic<br>
你会发现，最后数据又被写入到sourceTopic中，而sinkTopic没有任何数据写入。</p>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
经过DEBUG和分析，原因如下：</p>
<h2 style="line-height:18px;color:rgb(85,85,85);font-size:18px;border-left:4px solid rgb(0,166,124);background-color:rgb(251,251,251);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;text-indent:30px;">
在Kafka Sink中</h2>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
配置项官网文档说明如下：<br>
属性名topic，默认值为default-flume-topic。<br>
The topic in Kafka to which the messages will be published. If this parameter is configured, messages will be published to this topic. If the event header contains a “topic” field, the event will be published to that topic overriding the topic configured here。<br>
如果event header中包含了key为”topic”的值，那么将会覆盖该属性配置。</p>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
在源码<strong>org.apache.flume.sink.kafka.KafkaSink.process()</strong>中，</p>
<pre class="prettyprint linenums" style="color:rgb(68,68,68);font-size:14px;line-height:20px;background-color:rgb(248,248,248);border:1px solid rgb(238,238,238);overflow:hidden;text-indent:30px;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;"></pre><ol class="linenums" style="list-style:none;"><li class="L0" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="kwd" style="color:rgb(249,38,89);">if</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="pun" style="color:rgb(0,170,0);">((</span><span class="pln" style="color:rgb(0,0,255);">eventTopic </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> headers</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="kwd" style="color:rgb(249,38,89);">get</span><span class="pun" style="color:rgb(0,170,0);">(</span><span class="pln" style="color:rgb(0,0,255);">TOPIC_HDR</span><span class="pun" style="color:rgb(0,170,0);">))</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="pun" style="color:rgb(0,170,0);">==</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="kwd" style="color:rgb(249,38,89);">null</span><span class="pun" style="color:rgb(0,170,0);">)</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="pun" style="color:rgb(0,170,0);">{</span></li><li class="L1" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">            eventTopic </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> topic</span><span class="pun" style="color:rgb(0,170,0);">;</span></li><li class="L2" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);"> </span><span class="pun" style="color:rgb(0,170,0);">}</span></li></ol>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
其中topic是从属性agent_myAgent.sinks.kafkaSink.topic = sinkTopic 中获取的属性值（如果没有配置，则使用默认topic名称）<br>
topic = context.getString(KafkaSinkConstants.TOPIC,KafkaSinkConstants.DEFAULT_TOPIC);</p>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
即：先使用event header中key为”topic”的值作为sink的topic，如果event header中没有，才取属性中配置的topic。</p>
<h2 style="line-height:18px;color:rgb(85,85,85);font-size:18px;border-left:4px solid rgb(0,166,124);background-color:rgb(251,251,251);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;text-indent:30px;">
在Kafka Source中</h2>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
源码：<strong>org.apache.flume.source.kafka.KafkaSource.process()</strong></p>
<pre class="prettyprint linenums" style="color:rgb(68,68,68);font-size:14px;line-height:20px;background-color:rgb(248,248,248);border:1px solid rgb(238,238,238);overflow:hidden;text-indent:30px;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;"></pre><ol class="linenums" style="list-style:none;"><li class="L0" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="com" style="color:rgb(102,102,102);">// Add headers to event (topic, timestamp, and key)</span></li><li class="L1" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">    headers </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="kwd" style="color:rgb(249,38,89);">new</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="typ" style="color:rgb(0,170,0);">HashMap</span><span class="pun" style="color:rgb(0,170,0);">&lt;</span><span class="typ" style="color:rgb(0,170,0);">String</span><span class="pun" style="color:rgb(0,170,0);">,</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="typ" style="color:rgb(0,170,0);">String</span><span class="pun" style="color:rgb(0,170,0);">&gt;();</span></li><li class="L2" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">    headers</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">put</span><span class="pun" style="color:rgb(0,170,0);">(</span><span class="typ" style="color:rgb(0,170,0);">KafkaSourceConstants</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">TIMESTAMP</span><span class="pun" style="color:rgb(0,170,0);">,</span></li><li class="L3" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">            </span><span class="typ" style="color:rgb(0,170,0);">String</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">valueOf</span><span class="pun" style="color:rgb(0,170,0);">(</span><span class="typ" style="color:rgb(0,170,0);">System</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">currentTimeMillis</span><span class="pun" style="color:rgb(0,170,0);">()));</span></li><li class="L4" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">    headers</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">put</span><span class="pun" style="color:rgb(0,170,0);">(</span><span class="typ" style="color:rgb(0,170,0);">KafkaSourceConstants</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">TOPIC</span><span class="pun" style="color:rgb(0,170,0);">,</span><span class="pln" style="color:rgb(0,0,255);"> topic</span><span class="pun" style="color:rgb(0,170,0);">);</span></li></ol>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
在event中，将Kafka Source中配置的topic加入到了header中。<br>
因此，在Kafka Sink中，首先从event header中读取到了topic，Sink端的配置项不起作用。</p>
<h2 style="line-height:18px;color:rgb(85,85,85);font-size:18px;border-left:4px solid rgb(0,166,124);background-color:rgb(251,251,251);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;text-indent:30px;">
解决办法</h2>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
使用Flume拦截器，修改event header中key=topic的值为目标topic，拦截器使用Static interceptor，配置如下：</p>
<pre class="prettyprint linenums" style="color:rgb(68,68,68);font-size:14px;line-height:20px;background-color:rgb(248,248,248);border:1px solid rgb(238,238,238);overflow:hidden;text-indent:30px;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;"></pre><ol class="linenums" style="list-style:none;"><li class="L0" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="com" style="color:rgb(102,102,102);">## Source 拦截器</span></li><li class="L1" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">agent_myAgent</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">sources</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">kafkaSource</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">interceptors </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> i1</span></li><li class="L2" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">agent_myAgent</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">sources</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">kafkaSource</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">interceptors</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">i1</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">type </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="kwd" style="color:rgb(249,38,89);">static</span></li><li class="L3" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">agent_myAgent</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">sources</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">kafkaSource</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">interceptors</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">i1</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">key </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> topic</span></li><li class="L4" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">agent_myAgent</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">sources</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">kafkaSource</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">interceptors</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">i1</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">preserveExisting </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> </span><span class="kwd" style="color:rgb(249,38,89);">false</span></li><li class="L5" style="line-height:20px;text-indent:0px;color:rgb(190,190,197);margin-left:0px;list-style:decimal;"><span class="pln" style="color:rgb(0,0,255);">agent_myAgent</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">sources</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">kafkaSource</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">interceptors</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">i1</span><span class="pun" style="color:rgb(0,170,0);">.</span><span class="pln" style="color:rgb(0,0,255);">value </span><span class="pun" style="color:rgb(0,170,0);">=</span><span class="pln" style="color:rgb(0,0,255);"> sinkTopic</span></li></ol>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
其中，要特别注意preserveExisting属性值需要设置为false，该属性设置如果event header中已经存在key=topic，是否保留原来的值，默认为true，如果为true，那么还是会保留原来的topic，你设置的将不会生效。</p>
<p style="color:rgb(85,85,85);font-family:'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:15px;text-indent:30px;">
另外，Kafka Sink中可以不用再设置topic属性了，反正也没用。<br>
agent_myAgent.sinks.kafkaSink.topic = sinkTopic  //不需要了</p>
            </div>
                </div>
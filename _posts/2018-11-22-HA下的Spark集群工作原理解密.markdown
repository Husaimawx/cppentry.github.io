---
layout:     post
title:      HA下的Spark集群工作原理解密
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<p><span style="font-size:14px;">第一阶段（<span style="font-family:'Times New Roman';">1-3</span><span style="font-family:'宋体';">月）：会从浅入深，基于大量案例实战，深度剖析和讲解</span><span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">，并且会包含完全从企业真实复杂业务需求中抽取出的案例实战。课程会涵盖</span><span style="font-family:'Times New Roman';">Scala</span><span style="font-family:'宋体';">编程详解、</span><span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">核心编程、</span><span style="font-family:'Times New Roman';">Spark SQL</span><span style="font-family:'宋体';">和</span><span style="font-family:'Times New Roman';">Spark Streaming</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Spark GraphX</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">SparkR</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Machine Learning</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">内核以及源码剖析、性能调优、企业级案例实战等部分</span></span></p>
<p><span style="font-size:14px;">第二阶段（<span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">超大规模大数据案例实战）：使用了</span><span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">技术生态栈中的</span><span style="font-family:'Times New Roman';">Spark Core</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Spark SQL</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Spark Streaming</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">SparkR</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Machine Learning</span><span style="font-family:'宋体';">，进行离线计算和实时计算业务模块的开发、数据的关联性分析、用户行为模式和特征的训练与应用、用户网络的社区发现、用户影响力、能量传播、标签传播、标签推理、人群划分、年龄段预测、商品交易时序跳转</span></span></p>
<p><strong><span style="color:#ff0000;">本期内容：</span></strong></p>
<p><span style="color:#ff0000;">1 Spark<span style="font-family:'宋体';">高可用</span><span style="font-family:'Times New Roman';">HA</span><span style="font-family:'宋体';">实战</span></span></p>
<p><span style="color:#ff0000;">2 Spark<span style="font-family:'宋体';">集群工作原理详解</span></span></p>
<p><span style="font-family:'宋体';"></span></p>
<p><span></span>通常资源指<span style="font-family:'Times New Roman';">Memory</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">CPU</span><span style="font-family:'宋体';">，</span><span style="font-family:'Times New Roman';">Master Slaves</span><span style="font-family:'宋体';">结构存在单点故障，即</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">容易出现故障，为了应对单点故障，</span><span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">在生产环境下通过</span><span style="font-family:'Times New Roman';">zookeeperr</span><span style="font-family:'宋体';">做</span><span style="font-family:'Times New Roman';">HA</span><span style="font-family:'宋体';">。</span>现通常使用<span style="font-family:'Times New Roman';">3</span>个<span style="font-family:'Times New Roman';">Master</span>做<span style="font-family:'Times New Roman';">HA</span>，即使有<span style="font-family:'Times New Roman';">Avtive</span>的<span style="font-family:'Times New Roman';">Master</span>出现故障，另外两个<span style="font-family:'Times New Roman';">STANDBY</span>模式的<span style="font-family:'Times New Roman';">Master</span>会由<span style="font-family:'Times New Roman';">zookeeper</span>选出<span style="font-family:'Times New Roman';">leader</span>，替换故障的<span style="font-family:'Times New Roman';">Master</span>，变为<span style="font-family:'Times New Roman';">Avtive Master</span>，恢复集群状态，通过<span style="font-family:'Times New Roman';">zookeeper</span>保存集群的元数据恢复（Zookeeper中包含元数据，所有的<span style="font-family:'Times New Roman';">Worker</span>、<span style="font-family:'Times New Roman';">Driver Application</span>）。</p>
<p><span></span>只有<span style="font-family:'Times New Roman';">STANDBY</span><span style="font-family:'宋体';">模式</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">恢复了</span><span style="font-family:'Times New Roman';">Avtive</span><span style="font-family:'宋体';">才能恢复集群的正常，而在此过程中不能提交作业，</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">切换的过程中不会影响集群的作业的运行，因为程序在运行前，已经向</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">申请过资源，申请过资源后，</span><span style="font-family:'Times New Roman';">Driver</span><span style="font-family:'宋体';">与</span><span style="font-family:'Times New Roman';">Worker</span><span style="font-family:'宋体';">分配的</span><span style="font-family:'Times New Roman';">Executor</span><span style="font-family:'宋体';">进行通信，此过程不需要</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">参与，除非</span><span style="font-family:'Times New Roman';">Executor</span><span style="font-family:'宋体';">故障。所以，切换</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">的过程不影响作业运行，这是一种粗粒度的管理方式。</span></p>
<p><strong>粗粒度：</strong>一次性分配好资源，之后只需使用或覆用，</p>
<p><span></span>优点：在于一次性分配好资源后无需再分配，<span style="font-family:'Times New Roman';">Driver</span><span style="font-family:'宋体';">和</span><span style="font-family:'Times New Roman';">Worker</span><span style="font-family:'宋体';">的</span><span style="font-family:'Times New Roman';">Executor
       </span><span style="font-family:'宋体';">正常交互不受</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">切换的影响；</span></p>
<p><span></span>缺点：<span style="font-family:'Times New Roman';">job</span><span style="font-family:'宋体';">较多的时候，只要有一个</span><span style="font-family:'Times New Roman';">job</span><span style="font-family:'宋体';">没有运行完，作业没有运行完，为作 业分配的资源就会闲置起来，</span></p>
<p><strong>细粒度：</strong>需要资源的时候在进行分配，使用完资源后立即释放，缺点：资源无法覆   用，任务启动非常慢，且有通信麻烦。</p>
<div style="text-align:center;"><img src="https://img-blog.csdn.net/20160116112651298?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></div>
<p><span style="font-family:'宋体';"></span></p>
<p><strong>实现<span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">高可用</span><span style="font-family:'Times New Roman';">HA</span><span style="font-family:'宋体';">实战：</span></strong></p>
<p><strong>第一步：</strong>下载<span style="font-family:'Times New Roman';">zookeeper </span><span style="font-family:'宋体';">地址：</span><span style="font-family:'Times New Roman';">http://zookeeper.apache.org/</span></p>
<p><strong></strong></p>
<p>第二步：解压配置环境</p>
<p>export /ZOOKEEPER_HOME=/usr/local/zookeeper-3.6.4</p>
<p>并在<span style="font-family:'Times New Roman';">path</span><span style="font-family:'宋体';">中添加</span><span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">的</span><span style="font-family:'Times New Roman';">bin</span><span style="font-family:'宋体';">目录（</span><span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">安装和</span><span style="font-family:'Times New Roman';">hadoop</span><span style="font-family:'宋体';">，</span><span style="font-family:'Times New Roman';">spark</span><span style="font-family:'宋体';">没有关系）</span></p>
<p>修改：<span style="font-family:'Times New Roman';">1</span><span style="font-family:'宋体';">、进到</span><span style="font-family:'Times New Roman';">conf</span><span style="font-family:'宋体';">目录下，把</span><span style="font-family:'Times New Roman';">zoo_sample.cfg</span><span style="font-family:'宋体';">修改成</span><span style="font-family:'Times New Roman';">zoo.cfg</span></p>
<p>   <span> </span>dataDir=.../zookeeper/zookeeper-3.6.4/data(<span style="font-family:'宋体';">若不修改，重启后会删除</span><span style="font-family:'Times New Roman';">)</span></p>
<p>  <span> </span> dataLogDir=.../logs(data<span style="font-family:'宋体';">和</span><span style="font-family:'Times New Roman';">logs</span><span style="font-family:'宋体';">是</span><span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">安装目录下创建的目录</span><span style="font-family:'Times New Roman';">)</span></p>
<p>  <span> </span> 指定三台<span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">集群</span><br></p>
<p></p>
<p><span></span>2、zookeeper<span style="font-family:'宋体';">安装目录下创建</span><span style="font-family:'Times New Roman';">data</span><span style="font-family:'宋体';">和</span><span style="font-family:'Times New Roman';">logs</span><span style="font-family:'宋体';">用来存放数据和日志，并在</span><span style="font-family:'Times New Roman';">data</span> 
  下创建文件<span style="font-family:'Times New Roman';">myid,</span><span style="font-family:'宋体';">并在</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">中</span><span style="font-family:'Times New Roman';">myid</span><span style="font-family:'宋体';">添加</span><span style="font-family:'Times New Roman';">0</span><span style="font-family:'宋体';">。</span></p>
<p></p>
<pre><code class="language-java">
dataDir=/tmp/zookeeper
dataDir=/usr/local/zookeeper-3.4.6/data
dataLogDir=/usr/local/zookeeper-3.4.6/logs
server.0=master:2888:3888
server.1=worker1:2888:3888
server.2=worker2:2888:3888</code></pre>
<p></p>
<p><strong>第三步：</strong><span style="font-family:'Times New Roman';">scp </span><span style="font-family:'宋体';">拷贝到</span><span style="font-family:'Times New Roman';">2</span><span style="font-family:'宋体';">台</span><span style="font-family:'Times New Roman';">Worker</span><span style="font-family:'宋体';">上面；将Worker1
</span><span style="font-family:'Times New Roman';">myid</span><span style="font-family:'宋体';">中的</span><span style="font-family:'Times New Roman';">0</span><span style="font-family:'宋体';">改为</span><span style="font-family:'Times New Roman';">1</span><span style="font-family:'宋体';">，</span><span style="font-family:'Times New Roman';">Worker2</span><span style="font-family:'宋体';">上的
</span><span style="font-family:'Times New Roman';">myid</span><span style="font-family:'宋体';">中的</span><span style="font-family:'Times New Roman';">0</span><span style="font-family:'宋体';">改为</span><span style="font-family:'Times New Roman';">2</span></p>
<p><strong>第四步：</strong>分别启动<span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">（</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Worker1</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Worker2</span><span style="font-family:'宋体';">）：</span></p>
<p><span></span>.../bin/# zkServer.sh start</p>
<p>jps<span style="font-family:'宋体';">查看进程，多了进程</span><span style="font-family:'Times New Roman';">QuorumPeerMain</span></p>
<p><strong>第五步：</strong>让<span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">支持</span><span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">：</span></p>
<p> vim spark-env.sh<span style="font-family:'宋体';">配置</span><span style="font-family:'Times New Roman';">spark</span><span style="font-family:'宋体';">的支持信息，</span></p>
<p><span></span>1<span style="font-family:'宋体';">、将</span><span style="font-family:'Times New Roman';">SPARK_DAEMON_JABA_OPTS</span></p>
<p><span></span>2<span style="font-family:'宋体';">、配置</span><span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">所有做</span><span style="font-family:'Times New Roman';">HA</span><span style="font-family:'宋体';">的机器</span></p>
<pre><code class="language-java">&lt;p&gt;&lt;span style="color:rgb(255,0,0);"&gt;export JAVA_HOME=/root/install/jdk1.7.0_21&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style="color:rgb(255,0,0);"&gt;#export SPARK_MASTER_IP=spark1&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style="color:rgb(255,0,0);"&gt;#export SPARK_MASTER_PORT=7077&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style="color:rgb(255,0,0);"&gt;export SPARK_WORKER_CORES=1&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style="color:rgb(255,0,0);"&gt;export SPARK_WORKER_INSTANCES=1&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style="color:rgb(255,0,0);"&gt;export SPARK_WORKER_MEMORY=1g&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style="color:rgb(255,0,0);"&gt;export SPARK_DAEMON_JAVA_OPTS="-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=Master:2181,Worker1:2181 -Dspark.deploy.zookeeper.dir=/spark"&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;其中：&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;-Dspark.deploy.recoveryMode=ZOOKEEPER &lt;span style="font-family:宋体;"&gt;：说明整个集群状态通过&lt;/span&gt;&lt;span style="font-family:Times New Roman;"&gt;zookeeper&lt;/span&gt;&lt;span style="font-family:宋体;"&gt;来维护&lt;/span&gt;&lt;span style="font-family: Arial, Helvetica, sans-serif;"&gt;也说明整个集群状态恢复也是靠&lt;/span&gt;&lt;span style="font-family: 'Times New Roman';"&gt;zookeeper&lt;/span&gt;&lt;/p&gt;&lt;p&gt;-Dspark.deploy.zookeeper.url=Master:2181,Worker1:2181 &lt;span style="font-family:宋体;"&gt;：说明&lt;/span&gt;&lt;span style="font-family:Times New Roman;"&gt;zookeeper&lt;/span&gt;&lt;span style="font-family:宋体;"&gt;做&lt;/span&gt;&lt;span style="font-family:Times New Roman;"&gt;HA&lt;/span&gt;&lt;span style="font-family:宋体;"&gt;的机器&lt;/span&gt;&lt;/p&gt;&lt;p&gt;-Dspark.deploy.zookeeper.dir=/spark"&lt;span style="font-family:宋体;"&gt;：说明存放&lt;/span&gt;&lt;span style="font-family:Times New Roman;"&gt;Spark&lt;/span&gt;&lt;span style="font-family:宋体;"&gt;元数据，和&lt;/span&gt;&lt;span style="font-family:Times New Roman;"&gt;spark&lt;/span&gt;&lt;span style="font-family:宋体;"&gt;运行状态&lt;/span&gt;&lt;/p&gt;</code></pre>
<p><strong>第六步：</strong>启动<span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">集群</span></p>
<p>问题：为什么只在<span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">中有</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">进程？</span></p>
<p>Spark<span style="font-family:'宋体';">配置文件</span><span style="font-family:'Times New Roman';">Slaves</span><span style="font-family:'宋体';">中指定了</span><span style="font-family:'Times New Roman';">Worker</span><span style="font-family:'宋体';">，此时需要手动启动</span><span style="font-family:'Times New Roman';">Worker1</span><span style="font-family:'宋体';">、</span><span style="font-family:'Times New Roman';">Worker2</span><span style="font-family:'宋体';">上启动</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">进程：</span><span style="font-family:'Times New Roman';">./start-master.sh </span><span style="font-family:'宋体';">，之后查看</span><span style="font-family:'Times New Roman';">Worker1</span><span style="font-family:'宋体';">的</span><span style="font-family:'Times New Roman';">Status</span><span style="font-family:'宋体';">为</span><span style="font-family:'Times New Roman';">STANDB</span></p>
<div style="text-align:center;"><img src="https://img-blog.csdn.net/20160116112922855?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="">   <img src="https://img-blog.csdn.net/20160116112936710?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></div>
<p>状态所以的Workers，所有的Died、所有的Alive</p>
<p><strong>第七步：测试<span style="font-family:'Times New Roman';">HA</span></strong></p>
<p> ./spark-shell --master spark://Master<span style="font-family:'宋体';">：</span><span style="font-family:'Times New Roman';">7077,Worker1:7077,Worker2:7077</span></p>
<p>向<span style="font-family:'Times New Roman';">zookeeper</span><span style="font-family:'宋体';">去找一个</span><span style="font-family:'Times New Roman';">Active</span><span style="font-family:'宋体';">的</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">，只跟</span><span style="font-family:'Times New Roman';">Active</span><span style="font-family:'宋体';">的</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">进行交互。</span></p>
<p></p>
<p>client.AppClient$ClientActor: Master haschanged, new master is at spark://worker1:7077</p>
<p>关闭<span style="font-family:'Times New Roman';">Active Master</span><span style="font-family:'宋体';">机器，恢复集群需要时间，哪台机器恢复快</span><span style="font-family:'Times New Roman';">Active</span><span style="font-family:'宋体';">，就会与</span><span style="font-family:'Times New Roman';">Apalication</span><span style="font-family:'宋体';">中的</span><span style="font-family:'Times New Roman';">Driver</span><span style="font-family:'宋体';">进行交互，即该机器变为</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">，此时</span><span style="font-family:'Times New Roman';">Web</span><span style="font-family:'宋体';">界面无法访问，</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">变为</span><span style="font-family:'Times New Roman';">Worker1</span><span style="font-family:'宋体';">，</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">机器</span><span style="font-family:'Times New Roman';">Status</span><span style="font-family:'宋体';">变为</span><span style="font-family:'Times New Roman';">STANDBY</span><span style="font-family:'宋体';">（切换</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">没有意义，且浪费时间），然后重启集群后，</span><span style="font-family:'Times New Roman';">Maste</span><span style="font-family:'宋体';">任然变为</span><span style="font-family:'Times New Roman';">Worker1</span><span style="font-family:'宋体';">。</span></p>
<p>zookeeper做ha，以前一直认为可以从woker选举变为master级别，原来从master（standby）变为master(active)，心跳貌似是2秒，默认。</p>
<p><strong>Spark Runtime </strong></p>
<p>一般程序提交的时候，当<span style="font-family:'Times New Roman';">Driver</span><span style="font-family:'宋体';">启动后，向</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">进行注册初始化时完成，（</span><span style="font-family:'Times New Roman';">Spark</span><span style="font-family:'宋体';">程序是在注册的时候完成资源分配）然后由</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">分配资源，程序提交给</span><span style="font-family:'Times New Roman';">Master</span><span style="font-family:'宋体';">由</span><span style="font-family:'Times New Roman';">CoarseGraineSchedularBackend</span><span style="font-family:'宋体';">的子类</span><span style="font-family:'Times New Roman';">SparkDeploySchedulerBackend</span><span style="font-family:'宋体';">进行管理。</span></p>
<div style="text-align:center;"><img src="https://img-blog.csdn.net/20160116113131952?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></div>
<p></p>
<p></p>
<p>ＤＴ大数据梦工厂</p>
<p>新浪微博：<a href="http://www.weibo.com/ilovepains/" rel="nofollow">www.weibo.com/ilovepains/</a></p>
<p>微信公众号：<span style="font-family:'Times New Roman';">DT_Spark</span></p>
<p>博客：<a href="/ilovepains" rel="nofollow">http://.blog.sina.com.cn/ilovepains</a></p>
<p>TEL:18610086859</p>
<p>Email:18610086859@vip.126.com</p>
<br><p><br></p>
<p><br></p>
<p><br></p>
            </div>
                </div>
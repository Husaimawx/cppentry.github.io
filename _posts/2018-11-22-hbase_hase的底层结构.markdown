---
layout:     post
title:      hbase_hase的底层结构
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <p align="justify">一、hbase<span style="font-family:'宋体';">的底层结构</span></p><p>Hbase<span style="font-family:'宋体';">的存储默认为</span><span style="font-family:Calibri;">hdfs</span><span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">/hbase</span><span style="font-family:'宋体';">目录，可以通过</span><span style="font-family:Calibri;">hbase-sit.xml</span><span style="font-family:'宋体';">配置。</span></p><p> <img src="https://img-blog.csdn.net/2018051017220460" alt=""></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/archive (1)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/corrupt (2) </span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/data/default/TestTable/.tabledesc/.tableinfo.0000000001 (3)</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">/hbase/data/default/TestTable/fc06f27a6c5bc2ff57ea38018b4dd399/info/</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">2e58b3e274ba4d889408b05e526d4b7b (4)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/data/default/TestTable/fc06f27a6c5bc2ff57ea38018b4dd399/</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">recovered.edits/340.seqid (5)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/data/default/TestTable/fc06f27a6c5bc2ff57ea38018b4dd399/.regioninfo (6)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/data/default/TestTable/fc06f27a6c5bc2ff57ea38018b4dd399/.tmp (7)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/data/default/TestTable/fc06f27a6c5bc2ff57ea38018b4dd399/.splits (8)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/data/default/TestTable/fc06f27a6c5bc2ff57ea38018b4dd399/.merges (9)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/data/hbase/acl (10)</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">/hbase/data/hbase/meta (11)</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">/hbase/hbase.id (12)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/hbase.version (13)</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">/hbase/MasterProcWALs (14)</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">/hbase/oldWALs (15)</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">/hbase/.tmp (16)</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">/hbase/.trashtables/data (17)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">/hbase/WALs/tins-donot-rm-test-hb1-004.hbase.9b78df04-b.rds.aliyuncs.com,16020,1523502350378/tins-donot-rm-test-hb1-004.hbase.</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">9b78df04-b.rds.aliyuncs.com%2C16020%2C1523502350378.</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">default.1524538284034 (18)</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);"> </span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(1) 进行snapshot或者升级的时候使用到的归档目录。compaction删除hfile的时候，也会把</span><span style="color:rgb(62,62,62);"><span style="font-family:'宋体';">旧</span></span><span style="color:rgb(62,62,62);"><span style="font-family:'宋体';">的</span>hfile归档到这里等。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(2) splitlog的corrupt目录，以及corrupt hfile的目录。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(3) 表的基本属性信息元文件tableinfo。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(4) 对应表下的hfile数据文件。</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">(5) 当splitlog发生时，一个RS的wal会按照region级别split WALs写到对应目录下的的recovered.edits目录上，使得此region再次被open的时候，回放这些recovered.edits 日志。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(6) regioninfo文件。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(7) compaction等的临时tmp目录。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(8) split时临时目录，如果上次region的split没有完成被中断了，这个region再open的时候会自动清理这个目录，一般不需要人工干预。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(9) merges时的临时目录，和split一样，如果没有正常完成的时候被中断了，那么他会在下次被open的时候自动清理。一般也不需要人工干预。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(10) acl 开启HBase权限控制时的权限记录系统表</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(11) meta 元数据表，记录region相关信息</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(12) hbase.id 集群启动初始化的时候，创建的集群唯一id。可以重新fix生成</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">(13) hbase.version hbase 软件版本文件，代码静态版本，现在都是8</span><span style="color:rgb(62,62,62);"><br></span><span style="color:rgb(62,62,62);">(14) master执行过程程序的状态保存，用于中断恢复执行使用。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(15) oldWALs 历史wal，即wal记录的数据已经确认持久化了，那么这些wal就会被移到这里。splitlog完成的那些就日志，也会被放到这里。</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(16) tmp 临时辅助目录，比如写一个hbase.id文件，在这里写成功后，rename到 /hbase/hbase.id</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(17) /hbase/.trashtables/data 当truncate table或者delete table的时候，这些数据会临时放在这里，默认1小时内被清</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);">(18) 记录着一台RegionServer上的WAL日志文件。可以看到它是regionserver名字是有时间的，即下一次启动时RS的wal目录就会使用新的目录结构存放wal，这个旧的RS wal 目录就会被splitlog过程拆分回放</span></p><p style="background:rgb(255,255,255);"><span style="color:rgb(62,62,62);"> </span></p><p><strong>HBase涉及的主要文件及用途</strong></p><p>HDFS静态文件，HDFS上的HBase 数据完整性</p><p>    1. hfile文件：数据文件，目前最高版本也是默认常用版本为 3。 hfile文件结构细节可以参考官网http://hbase.apache.org/book.html#_hfile_format_2。我们这里逆向生成元数据主要使用到了HFile fileinfo的firstkey、lastkey信息。</p><p>    2. hfilelink文件: 在hbase snapshot时用到, migration upgrade 也会使用到。很少碰到这类文件的运维问题，这里不作过多介绍。</p><p>    3. reference文件：用来指定half hfile，一个region有reference时，这个region不能split。split/merge会创建这个。进行compaction后生成新的hfile后，会把这个reference删除。hfile的reference文件名格式一般是 hfile.parentEncRegion。如：/hbase/data/default/table/region-one/family/hfilename。其region-two有reference hfile文件名格式为：/hbase/data/default/table/region-two/family/hfile.region-one 通常无效引用就是 region-one的hfile不存在了，那么这个引用就会失效。他的修复方法一般是把reference无效的引用移除。</p><p>    4. ".regioninfo" 文件，保存着 endkey/offline标志/regionid/regionName/split标志/startkey/tablename等</p><p>    5. tableinfo文件这类文件保存着 tableName/table属性信息/table级别config信息/family信息。其中family信息保存着 famliyName/famiy属性/famliy级别config信息等。</p><p>        <span style="font-family:'宋体';">通常，</span>table属性有：REGION_MEMSTORE_REPLICATION,PRIORITY,IS_ROOT_KEY等，一般这些属性默认也是根据配置的一样。family属性有：BLOCKSIZE,TTL，REPLICATION_SCOPE等，一般属性是根据配置使用默认的。</p><p>    6. hbase:meta表数据内容格式</p><p>        regionname, info:regioninfo, regioninfo的encodeValue值</p><p>        regionname, info:seqnumDuringOpen, 序列号</p><p>        regionname, info:server, region所在的server名</p><p>        regionname, info:serverstartcode, regionserver 启动的timestamp</p>            </div>
                </div>
---
layout:     post
title:      hive strict模式
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive strict模式</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">set hive.mapred.mode=nonstrict;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">set hive.mapred.mode=strict;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive&gt; set hive.mapred.mode;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive.mapred.mode=nonstrict</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive&gt; set hive.mapred.mode=strict;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive&gt; select key, value from src order by key,value;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">FAILED: Error in semantic analysis: line 1:36 In strict mode, limit must be specified if ORDER BY is present value</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive&gt; </span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">HiveConf：</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">HIVEMAPREDMODE("hive.mapred.mode", "nonstrict"),</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">tianzhao@ubuntu:~/hive/trunk/hive-0.6.0/conf$ grep -r "hive.mapred.mode" ../conf/</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">../conf/hive-default.xml:  &lt;name&gt;hive.mapred.mode&lt;/name&gt;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive-default.xml：</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">&lt;property&gt;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">  &lt;name&gt;hive.mapred.mode&lt;/name&gt;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">  &lt;value&gt;nonstrict&lt;/value&gt;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">  &lt;description&gt;The mode in which the hive operations are being performed. In strict mode, some risky queries are not allowed to run&lt;/description&gt;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">&lt;/property&gt;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">strict：</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">出现的地方：</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">（1）</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">  private Operator genJoinReduceSinkChild(QB qb, QBJoinTree joinTree,</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      Operator child, String srcName, int pos) throws SemanticException {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">    // Use only 1 reducer in case of cartesian product</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">    if (reduceKeys.size() == 0) {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      numReds = 1;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      // Cartesian product is not supported in strict mode</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      if (conf.getVar(HiveConf.ConfVars.HIVEMAPREDMODE).equalsIgnoreCase(</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">          "strict")) {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">        throw new SemanticException(ErrorMsg.NO_CARTESIAN_PRODUCT.getMsg());</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      }</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">    }</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">}</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive&gt; set hive.mapred.mode=strict;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">hive&gt; EXPLAIN SELECT subq.key, tab.value FROM src subq JOIN src tab  where subq.key &lt; 200;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">FAILED: Error in semantic analysis: In strict mode, cartesian product is not allowed. If you really want to perform the operation, set hive.mapred.mode=nonstrict</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">（2）</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">  private Operator genReduceSinkPlan(String dest, QB qb, Operator input,</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      int numReducers) throws SemanticException {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">    if (sortExprs == null) {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      sortExprs = qb.getParseInfo().getOrderByForClause(dest);</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      if (sortExprs != null) {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">        assert numReducers == 1;</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">        // in strict mode, in the presence of order by, limit must be specified</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">        Integer limit = qb.getParseInfo().getDestLimit(dest);</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">        if (conf.getVar(HiveConf.ConfVars.HIVEMAPREDMODE).equalsIgnoreCase(</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">            "strict")</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">            &amp;&amp; limit == null) {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">          throw new SemanticException(ErrorMsg.NO_LIMIT_WITH_ORDERBY</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">              .getMsg(sortExprs));</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">        }</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      }</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">    }</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">}</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">（3）</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">  public static PrunedPartitionList prune(Table tab, ExprNodeDesc prunerExpr,</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      HiveConf conf, String alias,</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">      Map&lt;String, PrunedPartitionList&gt; prunedPartitionsMap) throws HiveException {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">     </span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">          // If the "strict" mode is on, we have to provide partition pruner for</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">          // each table.</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">          if ("strict".equalsIgnoreCase(HiveConf.getVar(conf,</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">              HiveConf.ConfVars.HIVEMAPREDMODE))) {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">            if (!hasColumnExpr(prunerExpr)) {</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">              throw new SemanticException(ErrorMsg.NO_PARTITION_PREDICATE</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">                  .getMsg("for Alias \"" + alias + "\" Table \""</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">                  + tab.getTableName() + "\""));</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">            }</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">          }</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">}</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">strict模式在下面三种情况下有限制：</span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">(1) partition表需要加上分区裁剪 </span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">(2) order by 只有一个reduce，需要加上limit </span><br style="font-family:Tahoma;font-size:14px;line-height:24px;"><span style="font-family:Tahoma;font-size:14px;line-height:24px;">(3) join时，如果只有一个reduce，笛卡尔积不支持。</span>
            </div>
                </div>
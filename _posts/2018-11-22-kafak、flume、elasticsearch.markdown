---
layout:     post
title:      kafak、flume、elasticsearch
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
目标：利用Flume Agent实现，将Kafka中数据取出，送入ElasticSearch中。</p>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
分析：Flume Agent需要的工作，两点：</p>
<ul style="font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;line-height:27.136px;"><li>Flume Kafka Source：负责从Kafka中读取数据；</li><li>Flume ElasticSearch Sink：负责将数据送入ElasticSearch；</li></ul><p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
当前Flume 1.5.2已经包含了ElasticSearchSink，因此，需要定制实现Flume Kafka Source即可。当前从Jira上得知，Flume 1.6.0 中将包含Flume-ng-kafka-source，但是，当前Flume 1.6.0版本并没有发布，怎么办？两条路：</p>
<ul style="font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;line-height:27.136px;"><li>github上别人开源的Flume-ng-kafka-source</li><li>flume 1.6.0分支的代码中flume-ng-kafka-source</li></ul><p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
初步选定Flume 1.6.0分支中的flume-ng-kafka-source部分，这部分代码已经包含在<a href="https://github.com/ningg/flume-ng-extends-source" rel="nofollow" style="text-decoration:none;">flume-ng-extends-source</a>。</p>
<h2 style="font-size:1.3em;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';line-height:27.136px;">
编译代码</h2>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
执行命令：<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">mvn clean </span><span class="kwd" style="color:rgb(0,0,139);">package</span></code>得到jar包：<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">flume</span><span class="pun">-</span><span class="pln">ng</span><span class="pun">-</span><span class="kwd" style="color:rgb(0,0,139);">extends</span><span class="pun">-</span><span class="pln">source</span><span class="pun">-</span><span class="pln">x</span><span class="pun">.</span><span class="pln">x</span><span class="pun">.</span><span class="pln">x</span><span class="pun">.</span><span class="pln">jar</span></code>。</p>
<h2 style="font-size:1.3em;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';line-height:27.136px;">
安装插件</h2>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
两类jar包：</p>
<ul style="font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;line-height:27.136px;"><li>lib中jar包
<ul><li><code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">flume</span><span class="pun">-</span><span class="pln">ng</span><span class="pun">-</span><span class="kwd" style="color:rgb(0,0,139);">extends</span><span class="pun">-</span><span class="pln">source</span><span class="pun">-</span><span class="pln">x</span><span class="pun">.</span><span class="pln">x</span><span class="pun">.</span><span class="pln">x</span><span class="pun">.</span><span class="pln">jar</span></code></li></ul></li><li>libext中jar包
<ul><li><code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">kafka_2</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">9.2</span><span class="pun">-</span><span class="lit" style="color:rgb(128,0,0);">0.8</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">2.0</span><span class="pun">.</span><span class="pln">jar</span></code></li><li><code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">kafka</span><span class="pun">-</span><span class="pln">clients</span><span class="pun">-</span><span class="lit" style="color:rgb(128,0,0);">0.8</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">2.0</span><span class="pun">.</span><span class="pln">jar</span></code></li><li><code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">metrics</span><span class="pun">-</span><span class="pln">core</span><span class="pun">-</span><span class="lit" style="color:rgb(128,0,0);">2.2</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">0.jar</span></code></li><li><code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">scala</span><span class="pun">-</span><span class="pln">library</span><span class="pun">-</span><span class="lit" style="color:rgb(128,0,0);">2.9</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">2.jar</span></code></li><li><code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">zkclient</span><span class="pun">-</span><span class="lit" style="color:rgb(128,0,0);">0.3</span><span class="pun">.</span><span class="pln">jar</span></code></li></ul></li></ul><p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
<strong>疑问</strong>：maven打包时，如何将当前jar包以及其依赖包都导出？ 参考<a href="https://github.com/thilinamb/flume-ng-kafka-sink" rel="nofollow" style="text-decoration:none;">thilinamb flume kafka sink</a></p>
<h2 style="font-size:1.3em;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';line-height:27.136px;">
配置</h2>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
在properties文件中进行配置，配置样本文件：</p>
<pre class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;overflow:auto;font-size:.8em;line-height:1.5em;background-color:rgb(225,225,225);"><code class="prettyprint" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;display:block;overflow:auto;background-color:rgb(247,247,247);"><span class="com" style="color:#808080;"># Kafka Source For retrieve from Kafka cluster.</span><span class="pln">
agent</span><span class="pun">.</span><span class="pln">sources</span><span class="pun">.</span><span class="pln">seqGenSrc</span><span class="pun">.</span><span class="pln">type </span><span class="pun">=</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">github</span><span class="pun">.</span><span class="pln">ningg</span><span class="pun">.</span><span class="pln">flume</span><span class="pun">.</span><span class="pln">source</span><span class="pun">.</span><span class="typ" style="color:rgb(43,145,175);">KafkaSource</span><span class="pln">
</span><span class="com" style="color:#808080;">#agent.sources.seqGenSrc.batchSize = 2</span><span class="pln">
agent</span><span class="pun">.</span><span class="pln">sources</span><span class="pun">.</span><span class="pln">seqGenSrc</span><span class="pun">.</span><span class="pln">batchDurationMillis </span><span class="pun">=</span><span class="pln"> </span><span class="lit" style="color:rgb(128,0,0);">1000</span><span class="pln">
agent</span><span class="pun">.</span><span class="pln">sources</span><span class="pun">.</span><span class="pln">seqGenSrc</span><span class="pun">.</span><span class="pln">topic </span><span class="pun">=</span><span class="pln"> good
agent</span><span class="pun">.</span><span class="pln">sources</span><span class="pun">.</span><span class="pln">seqGenSrc</span><span class="pun">.</span><span class="pln">zookeeperConnect </span><span class="pun">=</span><span class="pln"> </span><span class="lit" style="color:rgb(128,0,0);">168.7</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">2.164</span><span class="pun">:</span><span class="lit" style="color:rgb(128,0,0);">2181</span><span class="pun">,</span><span class="lit" style="color:rgb(128,0,0);">168.7</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">2.165</span><span class="pun">:</span><span class="lit" style="color:rgb(128,0,0);">2181</span><span class="pun">,</span><span class="lit" style="color:rgb(128,0,0);">168.7</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">2.166</span><span class="pun">:</span><span class="lit" style="color:rgb(128,0,0);">2181</span><span class="pln">
agent</span><span class="pun">.</span><span class="pln">sources</span><span class="pun">.</span><span class="pln">seqGenSrc</span><span class="pun">.</span><span class="pln">groupId </span><span class="pun">=</span><span class="pln"> elasticsearch
</span><span class="com" style="color:#808080;">#agent.sources.seqGenSrc.kafka.consumer.timeout.ms = 1000</span><span class="pln">
</span><span class="com" style="color:#808080;">#agent.sources.seqGenSrc.kafka.auto.commit.enable = false</span><span class="pln">
</span><span class="com" style="color:#808080;"># ElasticSearchSink for ElasticSearch.</span><span class="pln">
agent</span><span class="pun">.</span><span class="pln">sinks</span><span class="pun">.</span><span class="pln">loggerSink</span><span class="pun">.</span><span class="pln">type </span><span class="pun">=</span><span class="pln"> org</span><span class="pun">.</span><span class="pln">apache</span><span class="pun">.</span><span class="pln">flume</span><span class="pun">.</span><span class="pln">sink</span><span class="pun">.</span><span class="pln">elasticsearch</span><span class="pun">.</span><span class="typ" style="color:rgb(43,145,175);">ElasticSearchSink</span><span class="pln">
agent</span><span class="pun">.</span><span class="pln">sinks</span><span class="pun">.</span><span class="pln">loggerSink</span><span class="pun">.</span><span class="pln">indexName </span><span class="pun">=</span><span class="pln"> flume
agent</span><span class="pun">.</span><span class="pln">sinks</span><span class="pun">.</span><span class="pln">loggerSink</span><span class="pun">.</span><span class="pln">indexType </span><span class="pun">=</span><span class="pln"> log
agent</span><span class="pun">.</span><span class="pln">sinks</span><span class="pun">.</span><span class="pln">loggerSink</span><span class="pun">.</span><span class="pln">batchSize </span><span class="pun">=</span><span class="pln"> </span><span class="lit" style="color:rgb(128,0,0);">100</span><span class="pln">
</span><span class="com" style="color:#808080;">#agent.sinks.loggerSink.ttl = 5</span><span class="pln">
agent</span><span class="pun">.</span><span class="pln">sinks</span><span class="pun">.</span><span class="pln">loggerSink</span><span class="pun">.</span><span class="pln">client </span><span class="pun">=</span><span class="pln"> transport
agent</span><span class="pun">.</span><span class="pln">sinks</span><span class="pun">.</span><span class="pln">loggerSink</span><span class="pun">.</span><span class="pln">hostNames </span><span class="pun">=</span><span class="pln"> </span><span class="lit" style="color:rgb(128,0,0);">168.7</span><span class="pun">.</span><span class="lit" style="color:rgb(128,0,0);">1.69</span><span class="pun">:</span><span class="lit" style="color:rgb(128,0,0);">9300</span><span class="pln">
</span><span class="com" style="color:#808080;">#agent.sinks.loggerSink.client = rest</span><span class="pln">
</span><span class="com" style="color:#808080;">#agent.sinks.loggerSink.hostNames = 168.7.1.69:9200</span><span class="pln">
</span><span class="com" style="color:#808080;">#agent.sinks.loggerSink.serializer = org.apache.flume.sink.elasticsearch.ElasticSearchLogStashEventSerializer</span></code></pre>
<h2 style="font-size:1.3em;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';line-height:27.136px;">
定制</h2>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
目标：定制ElasticSearchSink的serializer。</p>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
现象：设置ElasticSearchSink的参数<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">batchSize</span><span class="pun">=</span><span class="lit" style="color:rgb(128,0,0);">1000</span></code>后，当前ES中当天的Index中出现了<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="lit" style="color:rgb(128,0,0);">120</span><span class="pun">,</span><span class="lit" style="color:rgb(128,0,0);">000</span></code>+的记录，而此时，原有平台发现，当前产生的数据只有<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="lit" style="color:rgb(128,0,0);">20</span><span class="pun">,</span><span class="lit" style="color:rgb(128,0,0);">000</span></code>，因此，猜测KafkaSource将Kafka集群中指定topic下的所有数据都传入了ES中。</p>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
几点：</p>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
ElasticSearchSink中新的配置参数：</p>
<ul style="font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;line-height:27.136px;"><li>indexNameBuilder=org.apache.flume.sink.elasticsearch.TimeBasedIndexNameBuilder
<ul><li>上述将以<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">indexPrefix</span></code>-<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">yyyy</span><span class="pun">-</span><span class="pln">MM</span><span class="pun">-</span><span class="pln">dd</span></code>方式，每天产生一个Index；</li><li>其他选项：org.apache.flume.sink.elasticsearch.SimpleIndexNameBuilder，其直接以设定的<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">indexPrefix</span></code>（实际就是设置的<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">indexName</span></code>）</li></ul></li><li>dateFormat=<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="pln">yyyy</span><span class="pun">-</span><span class="pln">MM</span><span class="pun">-</span><span class="pln">dd</span></code></li><li>timeZONE=<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="typ" style="color:rgb(43,145,175);">Etc</span><span class="pun">/</span><span class="pln">UTC</span></code></li><li>serializer=org.apache.flume.sink.elasticsearch.ElasticSearchLogStashEventSerializer
<ul><li>上述选项，将 flume event 的 Header 中 key-value 添加到一个新增的字段<code class="prettyprint prettyprinted" style="font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;background-color:rgb(247,247,247);"><span class="lit" style="color:rgb(128,0,0);">@fields</span></code>中；</li><li>其他选项：org.apache.flume.sink.elasticsearch.ElasticSearchDynamicSerializer，其直接将body、header构造为一个JSON字符串，添加到ElasticSearch中。</li></ul></li></ul><h2 style="font-size:1.3em;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';line-height:27.136px;">
重启</h2>
<p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
如果终止Flume Agent，然后重启。疑问：</p>
<ul style="font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;line-height:27.136px;"><li>Kafka中的数据，是否会重复发送到ElasticSearch？</li><li>Kafka中的数据，是否有遗漏，没有发送到ElasticSearch？</li></ul><p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
思考，几个情况：</p>
<ul style="font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;line-height:27.136px;"><li>Kafka对应的Consumer有offset</li><li>Kafka中数据，周期性的清理，例如默认3天</li></ul><p style="line-height:27.136px;font-family:'Helvetica Neue', Helvetica, STHeiTi, 'Microsoft YaHei';font-size:16.96px;">
需要详细思考Flume Agent的重启场景。</p>
            </div>
                </div>
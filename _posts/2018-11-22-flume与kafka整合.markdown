---
layout:     post
title:      flume与kafka整合
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <h1 style="line-height:1.75;font-size:14px;">一. flume安装配置</h1><div style="line-height:1.75;font-size:14px;">1. flume下载：<a href="http://archive.apache.org/dist/flume/" rel="nofollow"><span style="color:rgb(0,56,132);">http://archive.apache.org/dist/flume/</span></a></div><div style="line-height:1.75;font-size:14px;"><span style="color:rgb(57,57,57);">2. fulme部署：上传rz，解压：</span>tar zxvf<a href="http://archive.apache.org/dist/flume/1.7.0/apache-flume-1.7.0-bin.tar.gz" rel="nofollow"><span style="color:rgb(0,56,132);">apache-flume-1.7.0-bin.tar.gz</span></a> </div><h1 style="line-height:1.75;font-size:14px;">二. flume的kafka配置</h1><h2 style="line-height:1.75;font-size:14px;">1. 配置Kafka信息</h2><div style="line-height:1.75;font-size:14px;">   <span style="font-size:14px;">新建</span>kafka-conf.properties，上传至flume的apache-flume-1.7.0-bin/conf目录下，配置内容如下：</div><hr style="clear:both;"><div style="line-height:1.75;font-size:14px;">#client</div><div style="line-height:1.75;font-size:14px;">agent.channels=ch1</div><div style="line-height:1.75;font-size:14px;">agent.sources=src1</div><div style="line-height:1.75;font-size:14px;">agent.sinks=sk1</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;">#define source monitor a logfile</div><div style="line-height:1.75;font-size:14px;">agent.sources.src1.type=exec</div><div style="line-height:1.75;font-size:14px;">agent.sources.src1.command=<span style="color:#ffcc66;">tail -F /data/jsp/log_producer/logs/producer.log</span></div><div style="line-height:1.75;font-size:14px;">agent.sources.src1.channels=ch1</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;">agent.channels.ch1.type=memory</div><div style="line-height:1.75;font-size:14px;">agent.channels.ch1.capacity=10000</div><div style="line-height:1.75;font-size:14px;">agent.channels.ch1.transactionCapacity=100</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;">#define kafka receiver</div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.type=org.apache.flume.sink.kafka.KafkaSink</div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.brokerList=<span style="color:#ffcc33;">ip1:9092,ip2:9092,ip3:9092</span></div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.topic=<span style="color:#ffcc66;">kafkatest</span></div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.serializer.class=kafka.serializer.StringEncoder</div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.channel=ch1</div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.batchSize=20<span style="font-size:9px;color:rgb(223,64,42);">注意：信息字段名称配置需仔细</span></div><hr style="clear:both;"><div style="line-height:1.75;font-size:14px;">需要注意以下三个重要配置：</div><div style="line-height:1.75;font-size:14px;">agent.sources.src1.command=tail -F /data/jsp/log_producer/logs/producer.log         <span style="color:rgb(223,64,42);">tail监听日志文件</span></div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.brokerList=ip1:9092,ip2:9092,ip3:9092                                                    <span style="color:rgb(223,64,42);">kafka集群配置</span></div><div style="line-height:1.75;font-size:14px;">agent.sinks.sk1.topic=kafkatest                                                                                            <span style="color:rgb(223,64,42);">flume向<span style="font-size:14px;">kafkatest</span>主题push数据</span></div><div style="line-height:1.75;font-size:14px;"><br></div><h2 style="line-height:1.75;font-size:14px;">2. 配置JAVA</h2><div style="line-height:1.75;font-size:14px;">    修改cong目录下的flume-env.sh，主要配置参数JAVA_HOME和JAVA_OPTS，配置内容如下：</div><hr style="clear:both;"><div style="line-height:1.75;font-size:14px;"># Licensed to the Apache Software Foundation (ASF) under one</div><div style="line-height:1.75;font-size:14px;"># or more contributor license agreements. See the NOTICE file</div><div style="line-height:1.75;font-size:14px;"># distributed with this work for additional information</div><div style="line-height:1.75;font-size:14px;"># regarding copyright ownership. The ASF licenses this file</div><div style="line-height:1.75;font-size:14px;"># to you under the Apache License, Version 2.0 (the</div><div style="line-height:1.75;font-size:14px;"># "License"); you may not use this file except in compliance</div><div style="line-height:1.75;font-size:14px;"># with the License. You may obtain a copy of the License at</div><div style="line-height:1.75;font-size:14px;">#</div><div style="line-height:1.75;font-size:14px;"># http://www.apache.org/licenses/LICENSE-2.0</div><div style="line-height:1.75;font-size:14px;">#</div><div style="line-height:1.75;font-size:14px;"># Unless required by applicable law or agreed to in writing, software</div><div style="line-height:1.75;font-size:14px;"># distributed under the License is distributed on an "AS IS" BASIS,</div><div style="line-height:1.75;font-size:14px;"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div style="line-height:1.75;font-size:14px;"># See the License for the specific language governing permissions and</div><div style="line-height:1.75;font-size:14px;"># limitations under the License.</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;"># If this file is placed at FLUME_CONF_DIR/flume-env.sh, it will be sourced</div><div style="line-height:1.75;font-size:14px;"># during Flume startup.</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;"># Enviroment variables can be set here.</div><div style="line-height:1.75;font-size:14px;"><span style="color:rgb(119,201,75);">export JAVA_HOME=/usr/java/jdk1.7.0_67-cloudera</span></div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;"># Give Flume more memory and pre-allocate, enable remote monitoring via JMX</div><div style="line-height:1.75;font-size:14px;"># export JAVA_OPTS="-Xms100m -Xmx2000m -Dcom.sun.management.jmxremote"</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;"># Let Flume write raw event data and configuration information to its log files for debugging</div><div style="line-height:1.75;font-size:14px;"># purposes. Enabling these flags is not recommended in production,</div><div style="line-height:1.75;font-size:14px;"># as it may result in logging sensitive user information or encryption secrets.</div><div style="line-height:1.75;font-size:14px;"><span style="color:rgb(119,201,75);">export JAVA_OPTS="-Xms1024m -Xmx1024m -Xss256k -Xmn512m -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:-</span>UseGCOverheadLimit"</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;"># Note that the Flume conf directory is always included in the classpath.</div><div style="line-height:1.75;font-size:14px;">#FLUME_CLASSPATH=""</div><div style="line-height:1.75;font-size:14px;">#set JAVA_HOME</div><hr style="clear:both;"><div style="line-height:1.75;font-size:14px;"><span style="font-size:14px;">至此flume的kafka配置完毕！</span></div><div style="line-height:1.75;font-size:14px;"><br></div><h2 style="line-height:1.75;font-size:14px;">3. flume启动</h2><div style="line-height:1.75;font-size:14px;">flume启动命令： ./flume-ng agent --conf-file<span style="color:rgb(119,201,75);">/opt/apache-flume-1.7.0-bin/conf/kafka-conf.properties</span> -c <span style="color:rgb(119,201,75);">/opt/apache-flume-1.7.0-bin/conf/ </span>--name agent -Dflume.root.logger=DEBUG,console<span style="font-size:9px;color:rgb(223,64,42);">注意：命令中绿色表示部分用的是绝对路径</span></div><div style="line-height:1.75;font-size:14px;"><br></div><h2 style="line-height:1.75;font-size:14px;">4. flume测试脚本</h2><div style="line-height:1.75;font-size:14px;">(1) 测试脚本，模拟生产日志记录，保存为producer_log.sh，用chmod赋执行权限，执行命令./producer_log.sh，会向producer.log写日志。脚本编码如下：</div><div style="line-height:1.75;font-size:14px;"><span style="font-size:12px;font-family:'Courier New';background-color:rgb(244,244,244);">---------------------------------------------------------------------------------------------------------------</span></div><div style="line-height:1.75;font-size:14px;"><span style="font-size:12px;font-family:'Courier New';color:rgb(0,0,255);background-color:rgb(244,244,244);">for</span><span style="font-size:12px;font-family:'Courier New';background-color:rgb(244,244,244);">((i=0;i&lt;=1000;i++));</span></div><div style="line-height:1.75;font-size:14px;"><span style="font-size:12px;font-family:'Courier New';color:rgb(0,0,255);">do</span><span style="font-size:12px;font-family:'Courier New';"> echo </span><span style="font-size:12px;font-family:'Courier New';color:rgb(0,0,255);">"kafka_test-"</span><span style="font-size:12px;font-family:'Courier New';">+$i&gt;&gt;</span><span style="font-family:SimSun, STSong;">/data/jsp/log_producer/logs/producer.log</span><span style="font-size:12px;font-family:'Courier New';">;</span></div><div style="line-height:1.75;font-size:14px;"><span style="font-size:12px;font-family:'Courier New';background-color:rgb(244,244,244);">done</span></div><div style="line-height:1.75;font-size:14px;"><span style="font-size:12px;font-family:'Courier New';background-color:rgb(244,244,244);">--------------------------------------------------------------------------------------------------------------</span></div><div style="line-height:1.75;font-size:14px;"><span style="font-size:12px;font-family:'Courier New';color:rgb(223,64,42);background-color:rgb(244,244,244);">日志内容样式：</span><span style="font-family:SimSun, STSong;color:rgb(223,64,42);">kafka_fulume_test-+1</span></div><div style="line-height:1.75;font-size:14px;"><br></div><h2 style="line-height:1.75;font-size:14px;">5. flume与kafka互动测试</h2><div style="line-height:1.75;font-size:14px;">    启动ZK和Kafka，在主题kafkatest，启动消费者服务，详见《Kafka-安装部署》</div><div style="line-height:1.75;font-size:14px;">创建主题： ./kafka-topics.sh --create --zookeeper ip:2181 --replication-factor 1 --partitions 1 --topic <span style="color:rgb(119,201,75);">kafkatest</span></div><div style="line-height:1.75;font-size:14px;">启动消费者：./kafka-console-consumer.sh --<span style="color:rgb(70,172,200);">zookeeper </span>ip1:2181,ip2:2181,ip3:2181 --topic <span style="color:rgb(119,201,75);">kafkatest </span>--from-beginning</div><div style="line-height:1.75;font-size:14px;">消费者服务端console会打印日志内容！</div><div style="line-height:1.75;font-size:14px;"><br></div><div style="line-height:1.75;font-size:14px;"><span style="color:rgb(144,167,209);">flume参考链接：</span><a href="https://www.cnblogs.com/cnmenglang/p/6550427.html" rel="nofollow"><span style="color:rgb(144,167,209);">https://www.cnblogs.com/cnmenglang/p/6550427.html</span></a></div><div style="line-height:1.75;font-size:14px;"><br></div>            </div>
                </div>
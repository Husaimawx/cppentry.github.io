---
layout:     post
title:      HBase HFile与Prefix Compression内部实现全解
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<h1 class="post-title" style="font-size:26px;line-height:1.5;text-align:center;">
HBase HFile与Prefix Compression内部实现全解--KeyValue格式</h1>
<div class="post-meta" style="color:rgb(153,153,153);font-size:12px;text-align:center;">
<span class="post-time"><span class="post-meta-item-text">发表于</span> 2012-02-20 </span><span class="post-category">  |   <span class="post-meta-item-text">分类于</span> <span><a href="http://jm.taobao.org/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/" rel="nofollow" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"><span>未分类</span> </a></span></span><span class="post-comments-count"> 
 |  <a href="http://jm.taobao.org/2012/02/20/internal-of-hbase-hfile-and-prefix-compression/#comments" rel="nofollow" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"><span class="post-comments-count ds-thread-count"></span></a></span></div>
<div class="post-body" style="font-family:Lato, 'PingFang SC', 'Microsoft YaHei', sans-serif;text-align:justify;color:rgb(85,85,85);font-size:14px;">
<div class="blog_content"><br><br>
## 1. 引子<br><br>
HFile (<span style="color:rgb(51,153,102);">H</span>Base <span style="color:rgb(51,153,102);">File</span>)是HBase使用的一种文件存储格式的抽象，<br><br>
目前存在两种版本的HFile: HFile V1和HFile V2<br><br>
HBase 0.92之前的版本仅支持HFile V1,<br><br>
HBase 0.92/0.94同时支持HFile V1和HFile V2。<br><br>
以下分别是HFile V1/V2的结构图:<br><br>
HFile V1<a href="http://rdc.taobao.com/team/jm/files/2012/02/1.png" rel="nofollow" class="fancybox" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"><img src="http://rdc.taobao.com/team/jm/files/2012/02/1.png" alt="" style="border:1px solid rgb(221,221,221);display:block !important;"></a><br><br>
HFile V2<br><br><a href="http://rdc.taobao.com/team/jm/files/2012/02/2.png" rel="nofollow" class="fancybox" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"><img src="http://rdc.taobao.com/team/jm/files/2012/02/2.png" alt="" style="border:1px solid rgb(221,221,221);display:block !important;"></a><br>
(<span style="color:rgb(51,153,102);">注: 这两个图片在hbase 0.94的svn目录: srcsiteresourcesimages</span>)<br><br>
图中的数据块(Data block)正是实际存放应用数据的地方，<br><br><a id="more" style="background-color:transparent;border-bottom:1px solid rgb(153,153,153);"></a><br><br>
每个数据块又由一系列的KeyValue组成，并且这些KeyValue之间是按Key升序排列的，<br><br>
本文将说明KeyValue到底是什么以及当KeyValue越来越多时出现大量类似的数据有哪些算法能减少重复?<br><br><span style="color:rgb(51,153,102);">首先来看一个例子:</span><br><br>
假设需要将用户的基本信息以及正在参与的开源项目的有关信息存入HBase:<br><br>
 <br><div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码</div>
<br></div>
<ol><li>用户基本信息 参与的开源项目</li><li>——————— —————————-</li><li>用户Id 职业 性别 tomcat hbase</li><li>——————— —————————-</li><li>zhh2009 码农 男 提patch打酱油 提patch打酱油</li><li><li>用户Id 职业 性别 tomcat ant</li><li>——————— —————————-</li><li>jdd1999 码神 男 创始人 创始人</li><li>———————————————————</li><li>表<span class="number">1.1</span> <br></li></ol></div>
<br><pre style="overflow:auto;font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;font-size:13px;color:rgb(77,77,76);background:rgb(247,247,247);line-height:1.6;">    用户基本信息                   参与的开源项目

</pre><p>用户Id    职业   性别          tomcat           hbase           </p>
<hr style="border:none;background-color:rgb(221,221,221);"><p>zhh2009   码农   男            提patch打酱油    提patch打酱油</p>
<p>用户Id    职业   性别          tomcat           ant</p>
<hr style="border:none;background-color:rgb(221,221,221);"><h2 id="jdd1999-码神-男-创始人-创始人" style="line-height:1.5;font-family:Lato, 'PingFang SC', 'Microsoft YaHei', sans-serif;font-size:20px;"><a href="http://jm.taobao.org/2012/02/20/internal-of-hbase-hfile-and-prefix-compression/#jdd1999-%E7%A0%81%E7%A5%9E-%E7%94%B7-%E5%88%9B%E5%A7%8B%E4%BA%BA-%E5%88%9B%E5%A7%8B%E4%BA%BA" rel="nofollow" class="headerlink" title="jdd1999   码神   男            创始人           创始人" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"></a>jdd1999   码神   男            创始人           创始人</h2><pre style="overflow:auto;font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:rgb(247,247,247);line-height:1.6;"><code style="font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:none;">表1.1&lt;/pre&gt;
</code></pre><p>从这个例子来看，用户的基本信息比较好确定，但是参与的开源项目不确定且在开源项目中扮演的角色也不确定，</p><p>所以用关系数据库不太好建表，因为不知道具体有多少列，也无法把相关的列归成一个组。</p><h3 id="1-1-列族" style="line-height:1.5;font-family:Lato, 'PingFang SC', 'Microsoft YaHei', sans-serif;font-size:18px;"><a href="http://jm.taobao.org/2012/02/20/internal-of-hbase-hfile-and-prefix-compression/#1-1-%E5%88%97%E6%97%8F" rel="nofollow" class="headerlink" title="1.1 列族" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"></a>1.1 列族</h3><p>HBase是一种基于列的数据库，相关的列可以归到一个列族(Column Family)，</p><p>每个列族中具体有哪些列不必事先知道，可以在需要的时候添加，比如在用户基本信息中为zhh2009加入email这样的列,</p><p>上例中”用户基本信息”和”参与的开源项目”可以作为两个列族，</p><p>不同的列族在HBase内部通常对应一个目录，这样不同的列值只会放到它所属的列族目录下。</p><h3 id="1-2-rowKey" style="line-height:1.5;font-family:Lato, 'PingFang SC', 'Microsoft YaHei', sans-serif;font-size:18px;"><a href="http://jm.taobao.org/2012/02/20/internal-of-hbase-hfile-and-prefix-compression/#1-2-rowKey" rel="nofollow" class="headerlink" title="1.2 rowKey" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"></a>1.2 rowKey</h3><p>我们希望通过查询某个列就能把同一个列族或多个列族中的信息取出来，用户Id就是这样的列，</p><p>比如当我们要查询zhh2009的邮箱和参与的开源项目时，根据用户Id来查就不会查到jdd1999的信息，</p><p>在HBase中称这样的列为rowKey。</p><p>HBase是如何存放上例中的信息呢?</p><p>将用户Id这一列抽出来作为rowKey, 把上面的信息按如下格式扁平化:</p><div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码  </div><br></div><ol><li>&lt;rowKey,  列族名称,       列名   =&gt; 列值&gt;  </li><li>—————————————————–  </li><li>&lt;zhh2009, 用户基本信息,   职业   =&gt; 码农&gt;  </li><li>&lt;zhh2009, 用户基本信息,   性别   =&gt; 男&gt;  </li><li>&lt;zhh2009, 参与的开源项目, tomcat =&gt; 提patch打酱油&gt;  </li><li>&lt;zhh2009, 参与的开源项目, hbase  =&gt; 提patch打酱油&gt;  </li><li>  </li><li>&lt;jdd1999, 用户基本信息,   职业   =&gt; 码神&gt;  </li><li>&lt;jdd1999, 用户基本信息,   性别   =&gt; 男&gt;  </li><li>&lt;jdd1999, 参与的开源项目, tomcat =&gt; 创始人&gt;  </li><li>&lt;jdd1999, 参与的开源项目, ant    =&gt; 创始人&gt;  </li><li>—————————————————–  </li><li>                表<span class="number" style="color:rgb(113,140,0);">1.2</span>  <br></li></ol></div><br><pre style="overflow:auto;font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:rgb(247,247,247);line-height:1.6;">&lt;rowKey,  列族名称,       列名   =&gt; 列值&gt;

</pre><p>&lt;zhh2009, 用户基本信息,   职业   =&gt; 码农&gt;
&lt;zhh2009, 用户基本信息,   性别   =&gt; 男&gt;
&lt;zhh2009, 参与的开源项目, tomcat =&gt; 提patch打酱油&gt;
&lt;zhh2009, 参与的开源项目, hbase  =&gt; 提patch打酱油&gt;</p>
<p>&lt;jdd1999, 用户基本信息,   职业   =&gt; 码神&gt;
&lt;jdd1999, 用户基本信息,   性别   =&gt; 男&gt;
&lt;jdd1999, 参与的开源项目, tomcat =&gt; 创始人&gt;</p>
<h2 id="lt-jdd1999-参与的开源项目-ant-gt-创始人-gt" style="line-height:1.5;font-family:Lato, 'PingFang SC', 'Microsoft YaHei', sans-serif;font-size:20px;"><a href="http://jm.taobao.org/2012/02/20/internal-of-hbase-hfile-and-prefix-compression/#lt-jdd1999-%E5%8F%82%E4%B8%8E%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE-ant-gt-%E5%88%9B%E5%A7%8B%E4%BA%BA-gt" rel="nofollow" class="headerlink" title="&lt;jdd1999, 参与的开源项目, ant    =&gt; 创始人&gt;" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"></a>&lt;jdd1999, 参与的开源项目, ant    =&gt; 创始人&gt;</h2><pre style="overflow:auto;font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:rgb(247,247,247);line-height:1.6;"><code style="font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:none;">表1.2&lt;/pre&gt;
</code></pre><p>表1.2中的每一行在HBase中对应一个KeyValue，</p><p>“=&gt;”左边的是KeyValue中的”Key”，”=&gt;”右边对应KeyValue中的”Value”。</p><p>当然这只是KeyValue的一个简化格式，内部格式并非那么简单，我们接下来看看真实的KeyValue是怎样的?</p><h2 id="2-KeyValue内部格式" style="line-height:1.5;font-family:Lato, 'PingFang SC', 'Microsoft YaHei', sans-serif;font-size:20px;"><a href="http://jm.taobao.org/2012/02/20/internal-of-hbase-hfile-and-prefix-compression/#2-KeyValue%E5%86%85%E9%83%A8%E6%A0%BC%E5%BC%8F" rel="nofollow" class="headerlink" title="2. KeyValue内部格式" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"></a>2. KeyValue内部格式</h2><p>KeyValue内部格式可以分成三部份: <span style="color:rgb(51,153,102);">头、Key、Value</span>，如表2.1所示</p><div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码  </div><br></div><ol><li>名称　　　          字节数                  说明  </li><li>——————————————————————–  </li><li>keyLength　　         <span class="number" style="color:rgb(113,140,0);">4</span>                     表示Key所占的总字节数  </li><li>valueLength           <span class="number" style="color:rgb(113,140,0);">4</span>                     表示Value所占的总字节数  </li><li>  </li><li>rowKeyLength          <span class="number" style="color:rgb(113,140,0);">2</span>                     表示rowKey所占的字节数  </li><li>rowKey                rowKeyLength          rowKey  </li><li>columnFamilyLength    <span class="number" style="color:rgb(113,140,0);">1</span>                     表示列族名称所占的字节数  </li><li>columnFamily          columnFamilyLength    列族名称  </li><li>columnName            columnNameLength      列名  </li><li>timestamp             <span class="number" style="color:rgb(113,140,0);">8</span>                     时间戳  </li><li>type                  <span class="number" style="color:rgb(113,140,0);">1</span>                     Key类型，比如是新增(Put)，还是删除(Delete)  </li><li>  </li><li>value                 valueLength           列值  </li><li>——————————————————————–  </li><li>                      表<span class="number" style="color:rgb(113,140,0);">2.1</span>  <br></li></ol></div><br><pre style="overflow:auto;font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:rgb(247,247,247);line-height:1.6;">名称　　　          字节数                  说明

</pre><p>keyLength　　         4                     表示Key所占的总字节数
valueLength           4                     表示Value所占的总字节数</p>
<p>rowKeyLength          2                     表示rowKey所占的字节数
rowKey                rowKeyLength          rowKey
columnFamilyLength    1                     表示列族名称所占的字节数
columnFamily          columnFamilyLength    列族名称
columnName            columnNameLength      列名
timestamp             8                     时间戳
type                  1                     Key类型，比如是新增(Put)，还是删除(Delete)</p>
<h2 id="value-valueLength-列值" style="line-height:1.5;font-family:Lato, 'PingFang SC', 'Microsoft YaHei', sans-serif;font-size:20px;"><a href="http://jm.taobao.org/2012/02/20/internal-of-hbase-hfile-and-prefix-compression/#value-valueLength-%E5%88%97%E5%80%BC" rel="nofollow" class="headerlink" title="value                 valueLength           列值" style="background-color:transparent;color:rgb(85,85,85);border-bottom:1px solid rgb(153,153,153);"></a>value                 valueLength           列值</h2><pre style="overflow:auto;font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:rgb(247,247,247);line-height:1.6;"><code style="font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:none;">表2.1&lt;/pre&gt;
</code></pre><p>keyLength和valueLength组成头部，</p><p>rowKeyLength到type这7项组成Key，最后一项value代表第三部份: Value，</p><p><span style="color:rgb(51,153,102);">上面有个地方值得注意</span>，在columnFamily前面有columnFamilyLength，</p><p>但是在columnName之前并没有columnNameLength这一项，为了节省空间，这不是必需的，</p><p>当在解析KeyValue时，通过keyLength-8(timestamp)-1(type)就可以确定columnName在此KeyValue中的结束位置。</p><p>把表1.2中的前两行按表2.1中的格式生成两个KeyValue:</p><p>KeyValue A 代表: &lt;zhh2009, 用户基本信息,   职业   =&gt; 码农&gt;</p><p>KeyValue B 代表: &lt;zhh2009, 用户基本信息,   性别   =&gt; 男&gt;</p><div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码 </div><br></div><ol><li>名称　　　          字节数                  KeyValue A        KeyValue B  </li><li>—————————————————————————-  </li><li>keyLength　　         <span class="number" style="color:rgb(113,140,0);">4</span>                     <span class="number" style="color:rgb(113,140,0);">35</span>                <span class="number" style="color:rgb(113,140,0);">35</span>  </li><li>valueLength           <span class="number" style="color:rgb(113,140,0);">4</span>                     <span class="number" style="color:rgb(113,140,0);">4</span>                 <span class="number" style="color:rgb(113,140,0);">2</span>  </li><li>  </li><li>rowKeyLength          <span class="number" style="color:rgb(113,140,0);">2</span>                     <span class="number" style="color:rgb(113,140,0);">7</span>                 <span class="number" style="color:rgb(113,140,0);">7</span>  </li><li>rowKey                rowKeyLength          zhh2009           zhh2009  </li><li>columnFamilyLength    <span class="number" style="color:rgb(113,140,0);">1</span>                     <span class="number" style="color:rgb(113,140,0);">12</span>                <span class="number" style="color:rgb(113,140,0);">12</span>  </li><li>columnFamily          columnFamilyLength    用户基本信息      用户基本信息  </li><li>columnName            columnNameLength      职业              性别  </li><li>timestamp             <span class="number" style="color:rgb(113,140,0);">8</span>                     <span class="number" style="color:rgb(113,140,0);">1329663787364</span>     <span class="number" style="color:rgb(113,140,0);">1329663787364</span>  </li><li>type                  <span class="number" style="color:rgb(113,140,0);">1</span>                     <span class="number" style="color:rgb(113,140,0);">4</span>(Put)            <span class="number" style="color:rgb(113,140,0);">4</span>(Put)  </li><li>  </li><li>value                 valueLength           码农              男  </li><li>—————————————————————————-  </li><li>                              表<span class="number" style="color:rgb(113,140,0);">2.2</span>  <br></li></ol></div><br><pre style="overflow:auto;font-family:consolas, Menlo, 'PingFang SC', 'Microsoft YaHei', monospace;background:rgb(247,247,247);line-height:1.6;">名称　　　          字节数                  KeyValue A        KeyValue B

</pre><p>keyLength　　         4                     35                35
valueLength           4                     4                 2</p><br>rowKeyLength 2 7 7<br>rowKey rowKeyLength zhh2009 zhh2009<br>columnFamilyLength 1 12 12<br>columnFamily columnFamilyLength 用户%E<p></p>
</div>
</div>
            </div>
                </div>
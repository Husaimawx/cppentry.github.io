---
layout:     post
title:      Spark Streaming 实现思路与模块概述
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<p style="margin-left:0px;font-size:2.25em;line-height:1.2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(238,238,238);color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
Spark Streaming 实现思路与模块概述</p>
<p style="margin-left:0px;font-size:2.25em;line-height:1.2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(238,238,238);color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
[酷玩 <a href="http://lib.csdn.net/base/spark" rel="nofollow" class="replace_word" title="Apache Spark知识库" style="color:rgb(223,52,52);text-decoration:none;font-weight:bold;">Spark</a>] Spark Streaming 源码解析系列 ，返回目录请 <a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/readme.md" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;">猛戳这里</a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="http://e.qq.com/" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;">「腾讯·广点通」</a>技术团队荣誉出品</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
本文内容适用范围：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>2016.01.04 update, Spark 1.6 全系列 √ (1.6.0)</li><li>2015.11.09 update, Spark 1.5 全系列 √ (1.5.0, 1.5.1, 1.5.2)</li><li>2015.07.15 update, Spark 1.4 全系列 √ (1.4.0, 1.4.1)</li><li>2015.04.17 update, Spark 1.3 全系列 √ (1.3.0, 1.3.1) <br><br></li></ul><h2 style="line-height:1.225;font-size:1.75em;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(238,238,238);color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t1" style="color:rgb(202,0,0);"></a><a id="user-content-一基于-spark-做-spark-streaming-的思路" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#%E4%B8%80%E5%9F%BA%E4%BA%8E-spark-%E5%81%9A-spark-streaming-%E7%9A%84%E6%80%9D%E8%B7%AF" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1;background-color:transparent;"></a>一、基于
 Spark 做 Spark Streaming 的思路</h2>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
Spark Streaming 与 Spark Core 的关系可以用下面的经典部件图来表述：</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/010.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/010.png" alt="image" style="border:0px;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
在本节，我们先探讨一下基于 Spark Core 的 RDD API，如何对 streaming data 进行处理。理解下面描述的这个思路非常重要，因为基于这个思路详细展开后，就能够充分理解整个 Spark Streaming 的模块划分和代码逻辑。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
第一步，假设我们有一小块数据，那么通过 RDD API，我们能够构造出一个进行数据处理的 RDD DAG（如下图所示）。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/020.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/020.png" alt="image" style="border:0px;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
第二步，我们对连续的 streaming data 进行切片处理 —— 比如将最近 200ms 时间的 event 积攒一下 —— 每个切片就是一个 batch，然后使用第一步中的 RDD DAG 对这个 batch 的数据进行处理。</p>
<blockquote style="color:rgb(119,119,119);border-left-width:4px;border-left-style:solid;border-left-color:rgb(221,221,221);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<p>
注意: 这里我们使用的是 batch 的概念 —— 其实 200ms 在其它同类系统中通常叫做 mini-batch，不过既然 Spark Streaming 官方的叫法就是 batch，我们这里就用 batch 表达 mini-batch 的意思了 :)</p>
</blockquote>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
所以，针对连续不断的 streaming data 进行多次切片，就会形成多个 batch，也就对应出来多个 RDD DAG（每个 RDD DAG 针对一个 batch 的数据）。如此一来，这多个 RDD DAG 之间相互同构，却又是不同的实例。我们用下图来表示这个关系：</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/030.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/030.png" alt="image" style="border:0px;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
所以，我们将需要：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>
<p>
(1) 一个静态的 RDD DAG 的模板，来表示处理逻辑；</p>
</li><li>
<p>
(2) 一个动态的工作控制器，将连续的 streaming data 切分数据片段，并按照模板复制出新的 RDD DAG 的实例，对数据片段进行处理。</p>
</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/032.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/032.png" alt="image" style="border:0px;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
第三步，我们回过头来看 streaming data 本身的产生。<a href="http://lib.csdn.net/base/hadoop" rel="nofollow" class="replace_word" title="Hadoop知识库" style="color:rgb(223,52,52);text-decoration:none;font-weight:bold;">Hadoop</a> MapReduce, Spark RDD API 进行批处理时，一般默认数据已经在
 HDFS, <a href="http://lib.csdn.net/base/hbase" rel="nofollow" class="replace_word" title="Hbase知识库" style="color:rgb(223,52,52);text-decoration:none;font-weight:bold;">Hbase</a> 或其它存储上。而 streaming data —— 比如 twitter 流 —— 又有可能是在系统外实时产生的，就需要能够将这些数据导入到
 Spark Streaming 系统里，就像 Apache Storm 的 Spout，Apache S4 的 Adapter 能够把数据导入系统里的作用是一致的。所以，我们将需要：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>(3) 原始数据的产生和导入。</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
第四步，我们考虑，有了以上 (a)(b)(c) 3 部分，就可以顺利用 RDD API 处理 streaming data 了吗？其实相对于 batch job 通常几个小时能够跑完来讲，streaming job 的运行时间是 +∞（正无穷大）的，所以我们还将需要：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>(4) 对长时运行任务的保障，包括输入数据的失效后的重构，处理任务的失败后的重调。</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
至此，streaming data 的特点决定了，如果我们想基于 Spark Core 进行 streaming data 的处理，还需要在 Spark Core 的框架上解决刚才列出的 (1)(2)(3)(4) 这四点问题：</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/035.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/035.png" alt="image" style="border:0px;"></a></p>
<h2 style="line-height:1.225;font-size:1.75em;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(238,238,238);color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t2" style="color:rgb(202,0,0);"></a><a id="user-content-二spark-streaming-的整体模块划分" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#%E4%BA%8Cspark-streaming-%E7%9A%84%E6%95%B4%E4%BD%93%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1;background-color:transparent;"></a>二、Spark
 Streaming 的整体模块划分</h2>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
根据 Spark Streaming 解决这 4 个问题的不同 focus，可以将 Spark Streaming 划分为四个大的模块：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>模块 1：DAG 静态定义</li><li>模块 2：Job 动态生成</li><li>模块 3：数据产生与导入</li><li>模块 4：长时容错</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
其中每个模块涉及到的主要的类，示意如下：</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/040.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/040.png" alt="image" style="border:0px;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
这里先不用纠结每个类的具体用途，我们将在本文中简述，并在本系列的后续文章里对每个模块逐一详述。</p>
<h3 style="line-height:1.43;font-size:1.5em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t3" style="color:rgb(202,0,0);"></a><a id="user-content-21-模块-1dag-静态定义" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#21-%E6%A8%A1%E5%9D%97-1dag-%E9%9D%99%E6%80%81%E5%AE%9A%E4%B9%89" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>2.1
 模块 1：DAG 静态定义</h3>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
通过前面的描述我们知道，应该首先对计算逻辑描述为一个 RDD DAG 的“模板”，在后面 Job 动态生成的时候，针对每个 batch，Spark Streaming 都将根据这个“模板”生成一个 RDD DAG 的实例。</p>
<h4 style="line-height:1.4;font-size:1.25em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t4" style="color:rgb(202,0,0);"></a><a id="user-content-dstream-和-dstreamgraph" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#dstream-%E5%92%8C-dstreamgraph" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>DStream
 和 DStreamGraph</h4>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
其实在 Spark Streaming 里，这个 RDD “模板”对应的具体的类是 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code>，RDD DAG “模板”对应的具体类是<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code>。而 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 本身也有很多子类，几乎每个子类都有一个对应的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code>，如 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">UnionRDD</code> 的对应是<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">UnionDStream</code>。<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 通过 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">transformation</code> 连接成
 RDD DAG（但 RDD DAG 在 Spark Core 里没有对应的具体类），<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 也通过 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">transformation</code> 连接成 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code>。</p>
<pre style="overflow:auto;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;line-height:1.45;color:rgb(51,51,51);background-color:rgb(247,247,247);"><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;border:0px;display:inline;line-height:inherit;background:transparent;">DStream      的全限定名是：org.apache.spark.streaming.dstream.DStream
DStreamGraph 的全限定名是：org.apache.spark.streaming.DStreamGraph
</code></pre>
<h4 style="line-height:1.4;font-size:1.25em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t5" style="color:rgb(202,0,0);"></a><a id="user-content-dstream-和-rdd-的关系" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#dstream-%E5%92%8C-rdd-%E7%9A%84%E5%85%B3%E7%B3%BB" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>DStream
 和 RDD 的关系</h4>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
既然 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 是 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 的模板，而且 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 和 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 具有相同的 transformation 操作，比如
 map(), filter(), reduce() ……等等（正是这些相同的 transformation 使得 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 能够忠实记录 RDD DAG 的计算逻辑），那 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 和 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 有什么不一样吗？</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
还真不一样。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
比如，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 维护了对每个产出的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 实例的指针。比如下图里，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream
 A</code> 在 3 个 batch 里分别实例化了 3 个 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code>，分别是 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">a[1]</code>, <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">a[2]</code>, <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">a[3]</code>，那么 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream
 A</code> 就保留了一个 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">batch → 所产出的 RDD</code> 的哈希表，即包含 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">batch
 1 → a[1]</code>, <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">batch 2 → a[2]</code>, <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">batch
 3 → a[3]</code> 这 3 项。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/045.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/045.png" alt="image" style="border:0px;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
另外，能够进行流量控制的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 子类，如 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverInputDStream</code>，还会保存关于历次
 batch 的源头数据条数、历次 batch 计算花费的时间等数值，用来实时计算准确的流量控制信息，这些都是记在 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 里的，而 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD
 a[1]</code> 等则不会保存这些信息。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
我们在考虑的时候，可以认为，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 加上 batch 维度就是 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code>，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 去掉
 batch 维度就是 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> —— 就像 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD
 = DStream at batch T</code></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
不过这里需要特别说明的是，在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code>的图里，DStream（即数据）是顶点，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code>之间的
 transformation（即计算）是边，这与 Apache Storm 等是相反的。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
在 Apache Storm 的 topology 里，顶点是计算，边是 stream（连续的 tuple），即数据。这一点也是比较熟悉 Storm 的同学刚开始一下子不太理解 DStream 的原因--我们再重复一遍，DStream 在有向图里是顶点，是数据本身，而不是边。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/046.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/046.png" alt="image" style="border:0px;"></a></p>
<h3 style="line-height:1.43;font-size:1.5em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t6" style="color:rgb(202,0,0);"></a><a id="user-content-22-模块-2job-动态生成" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#22-%E6%A8%A1%E5%9D%97-2job-%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>2.2
 模块 2：Job 动态生成</h3>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
现在有了 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 和 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code>，也就是静态定义了的计算逻辑，下面我们来看
 Spark Streaming 是如何将其动态调度的。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
在 Spark Streaming 程序的入口，我们都会定义一个 batchDuration，就是需要每隔多长时间就比照静态的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 来动态生成一个 RDD DAG 实例。在 Spark Streaming 里，总体负责动态作业调度的具体类是 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobScheduler</code>，在
 Spark Streaming 程序开始运行的时候，会生成一个 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobScheduler</code> 的实例，并被 start() 运行起来。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobScheduler</code> 有两个非常重要的成员：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobGenerator</code> 和 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code>。<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobScheduler</code> 将每个
 batch 的 RDD DAG 具体生成工作委托给 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobGenerator</code>，而将源头输入数据的记录工作委托给 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code>。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/050.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/050.png" alt="image" style="border:0px;"></a></p>
<pre style="overflow:auto;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;line-height:1.45;color:rgb(51,51,51);background-color:rgb(247,247,247);"><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;border:0px;display:inline;line-height:inherit;background:transparent;">JobScheduler    的全限定名是：org.apache.spark.streaming.scheduler.JobScheduler
JobGenerator    的全限定名是：org.apache.spark.streaming.scheduler.JobGenerator
ReceiverTracker 的全限定名是：org.apache.spark.streaming.scheduler.ReceiverTracker
</code></pre>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobGenerator</code> 维护了一个定时器，周期就是我们刚刚提到的 batchDuration，定时为每个 batch 生成 RDD DAG 的实例。具体的，每次 RDD DAG 实际生成包含 5 个步骤：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>(1) 要求 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code> 将目前已收到的数据进行一次 allocate，即将上次 batch 切分后的数据切分到到本次新的 batch 里</li><li>(2) 要求 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 复制出一套新的 RDD DAG 的实例，具体过程是：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 将要求图里的尾 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 节点生成具体的
 RDD 实例，并递归的调用尾 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 的上游 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 节点……以此遍历整个 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code>，遍历结束也就正好生成了
 RDD DAG 的实例</li><li>(3) 获取第 1 步 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code> 分配到本 batch 的源头数据的 meta 信息</li><li>(4) 将第 2 步生成的本 batch 的 RDD DAG，和第 3 步获取到的 meta 信息，一同提交给 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobScheduler</code> 异步执行</li><li>(5) 只要提交结束（不管是否已开始异步执行），就马上对整个系统的当前运行状态做一个 checkpoint</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
上述 5 个步骤的调用关系图如下：</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/055.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/055.png" alt="image" style="border:0px;"></a></p>
<h3 style="line-height:1.43;font-size:1.5em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t7" style="color:rgb(202,0,0);"></a><a id="user-content-23-模块-3数据产生与导入" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#23-%E6%A8%A1%E5%9D%97-3%E6%95%B0%E6%8D%AE%E4%BA%A7%E7%94%9F%E4%B8%8E%E5%AF%BC%E5%85%A5" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>2.3
 模块 3：数据产生与导入</h3>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
下面我们看 Spark Streaming 解决第三个问题的模块分析，即数据的产生与导入。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 有一个重要而特殊的子类 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverInputDStream</code>：它除了需要像其它 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStream</code> 那样在某个
 batch 里实例化 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 以外，还需要额外的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 为这个 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 生产数据！</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
具体的，Spark Streaming 在程序刚开始运行时：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>
<p>
(1) 由 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 的总指挥 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code> 分发多个
 job（每个 job 有 1 个 task），到多个 executor 上分别启动<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverSupervisor</code> 实例；</p>
</li><li>
<p>
(2) 每个 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverSupervisor</code> 启动后将马上生成一个用户提供的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 实现的实例
 —— 该 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 实现可以持续产生或者持续接收系统外数据，比如 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">TwitterReceiver</code> 可以实时爬取
 twitter 数据 —— 并在 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 实例生成后调用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver.onStart()</code>。</p>
</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/060.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/060.png" alt="image" style="border:0px;"></a></p>
<pre style="overflow:auto;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;line-height:1.45;color:rgb(51,51,51);background-color:rgb(247,247,247);"><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;border:0px;display:inline;line-height:inherit;background:transparent;">ReceiverSupervisor 的全限定名是：org.apache.spark.streaming.receiver.ReceiverSupervisor
Receiver           的全限定名是：org.apache.spark.streaming.receiver.Receiver
</code></pre>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
(1)(2) 的过程由上图所示，这时 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 启动工作已运行完毕。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
接下来 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverSupervisor</code> 将在 executor 端作为的主要角色，并且：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>
<p>
(3) <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 在 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">onStart()</code> 启动后，就将持续不断地接收外界数据，并持续交给 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverSupervisor</code> 进行数据转储；</p>
</li><li>
<p>
(4) <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverSupervisor</code> 持续不断地接收到 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 转来的数据：</p>
<ul><li>如果数据很细小，就需要 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">BlockGenerator</code> 攒多条数据成一块(4a)、然后再成块存储(4b 或 4c)</li><li>
<p>
反之就不用攒，直接成块存储(4b 或 4c)</p>
</li><li>
<p>
这里 Spark Streaming 目前支持两种成块存储方式，一种是由 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">blockManagerskManagerBasedBlockHandler</code> 直接存到 executor 的内存或硬盘，另一种由 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">WriteAheadLogBasedBlockHandler</code> 是同时写
 WAL(4c) 和 executor 的内存或硬盘</p>
</li></ul></li><li>
<p>
(5) 每次成块在 executor 存储完毕后，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverSupervisor</code> 就会及时上报块数据的 meta 信息给 driver 端的<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code>；这里的
 meta 信息包括数据的标识 id，数据的位置，数据的条数，数据的大小等信息。</p>
</li><li>
<p>
(6) <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code> 再将收到的块数据 meta 信息直接转给自己的成员 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceivedBlockTracker</code>，由<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceivedBlockTracker</code> 专门管理收到的块数据
 meta 信息。</p>
</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/065.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/065.png" alt="image" style="border:0px;"></a></p>
<pre style="overflow:auto;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;line-height:1.45;color:rgb(51,51,51);background-color:rgb(247,247,247);"><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;border:0px;display:inline;line-height:inherit;background:transparent;">BlockGenerator                 的全限定名是：org.apache.spark.streaming.receiver.BlockGenerator
BlockManagerBasedBlockHandler  的全限定名是：org.apache.spark.streaming.receiver.BlockManagerBasedBlockHandler
WriteAheadLogBasedBlockHandler 的全限定名是：org.apache.spark.streaming.receiver.WriteAheadLogBasedBlockHandler
ReceivedBlockTracker           的全限定名是：org.apache.spark.streaming.scheduler.ReceivedBlockTracker
ReceiverInputDStream           的全限定名是：org.apache.spark.streaming.dstream.ReceiverInputDStream
</code></pre>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
这里 (3)(4)(5)(6) 的过程是一直持续不断地发生的，我们也将其在上图里标识出来。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
后续在 driver 端，就由 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverInputDStream</code> 在每个 batch 去检查 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverTracker</code> 收到的块数据
 meta 信息，界定哪些新数据需要在本 batch 内处理，然后生成相应的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">RDD</code> 实例去处理这些块数据，这个过程在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">模块
 1：DAG 静态定义</code> <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">模块2：Job 动态生成</code> 里描述过了。</p>
<h3 style="line-height:1.43;font-size:1.5em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t8" style="color:rgb(202,0,0);"></a><a id="user-content-24-模块-4长时容错" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#24-%E6%A8%A1%E5%9D%97-4%E9%95%BF%E6%97%B6%E5%AE%B9%E9%94%99" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>2.4
 模块 4：长时容错</h3>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
以上我们简述完成 Spark Streamimg 基于 Spark Core 所新增功能的 3 个模块，接下来我们看一看第 4 个模块将如何保障 Spark Streaming 的长时运行 —— 也就是，如何与前 3 个模块结合，保障前 3 个模块的长时运行。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
通过前 3 个模块的关键类的分析，我们可以知道，保障模块 1 和 2 需要在 driver 端完成，保障模块 3 需要在 executor 端和 driver 端完成。</p>
<h4 style="line-height:1.4;font-size:1.25em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t9" style="color:rgb(202,0,0);"></a><a id="user-content-executor-端长时容错" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#executor-%E7%AB%AF%E9%95%BF%E6%97%B6%E5%AE%B9%E9%94%99" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>executor
 端长时容错</h4>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
先看 executor 端。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
在 executor 端，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceiverSupervisor</code> 和 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Receiver</code> 失效后直接重启就
 OK 了，关联是保障收到的块数据的安全。保障了源头块数据，就能够保障 RDD DAG （Spark Core 的 lineage）重做。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
Spark Streaming 对源头块数据的保障，分为 4 个层次，全面、相互补充，又可根据不同场景灵活设置：</p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>(1) 热备：热备是指在存储块数据时，将其存储到本 executor、并同时 replicate 到另外一个 executor 上去。这样在一个 replica 失效后，可以立刻无感知切换到另一份 replica 进行计算。实现方式是，在实现自己的 Receiver 时，即指定一下<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">StorageLevel</code> 为 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">MEMORY_ONLY_2</code> 或 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">MEMORY_AND_DISK_2</code> 就可以了。</li></ul><blockquote style="color:rgb(119,119,119);border-left-width:4px;border-left-style:solid;border-left-color:rgb(221,221,221);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<p>
// 1.5.2 update 这已经是默认了。</p>
</blockquote>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>(2) 冷备：冷备是每次存储块数据前，先把块数据作为 log 写出到 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">WriteAheadLog</code> 里，再存储到本 executor。executor 失效时，就由另外的 executor 去读 WAL，再重做 log 来恢复块数据。WAL
 通常写到可靠存储如 HDFS 上，所以恢复时可能需要一段 recover time。</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/070.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/070.png" alt="image" style="border:0px;"></a></p>
<ul style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><li>
<p>
(3) 重放：如果上游支持重放，比如 Apache Kafka，那么就可以选择不用热备或者冷备来另外存储数据了，而是在失效时换一个 executor 进行数据重放即可。</p>
</li><li>
<p>
(4) 忽略：最后，如果应用的实时性需求大于准确性，那么一块数据丢失后我们也可以选择忽略、不恢复失效的源头数据。</p>
</li></ul><p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
我们用一个表格来总结一下：</p>
<table style="border-collapse:collapse;border-spacing:0px;display:block;overflow:auto;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;"><tbody><tr style="border-top-width:1px;border-top-style:solid;border-top-color:rgb(204,204,204);"><td style="border:1px solid rgb(221,221,221);"> </td>
<td style="border:1px solid rgb(221,221,221);">图示</td>
<td style="border:1px solid rgb(221,221,221);">优点</td>
<td style="border:1px solid rgb(221,221,221);">缺点</td>
</tr><tr style="border-top-width:1px;border-top-style:solid;border-top-color:rgb(204,204,204);background-color:rgb(248,248,248);"><td style="border:1px solid rgb(221,221,221);">(1) 热备</td>
<td style="border:1px solid rgb(221,221,221);"><a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075a.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075a.png" alt="" style="border:0px;background-color:rgb(255,255,255);"></a></td>
<td style="border:1px solid rgb(221,221,221);">无 recover time</td>
<td style="border:1px solid rgb(221,221,221);">需要占用双倍资源</td>
</tr><tr style="border-top-width:1px;border-top-style:solid;border-top-color:rgb(204,204,204);"><td style="border:1px solid rgb(221,221,221);">(2) 冷备</td>
<td style="border:1px solid rgb(221,221,221);"><a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075b.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075b.png" alt="" style="border:0px;"></a></td>
<td style="border:1px solid rgb(221,221,221);">十分可靠</td>
<td style="border:1px solid rgb(221,221,221);">存在 recover time</td>
</tr><tr style="border-top-width:1px;border-top-style:solid;border-top-color:rgb(204,204,204);background-color:rgb(248,248,248);"><td style="border:1px solid rgb(221,221,221);">(3) 重放</td>
<td style="border:1px solid rgb(221,221,221);"><a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075c.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075c.png" alt="" style="border:0px;background-color:rgb(255,255,255);"></a></td>
<td style="border:1px solid rgb(221,221,221);">不占用额外资源</td>
<td style="border:1px solid rgb(221,221,221);">存在 recover time</td>
</tr><tr style="border-top-width:1px;border-top-style:solid;border-top-color:rgb(204,204,204);"><td style="border:1px solid rgb(221,221,221);">(4) 忽略</td>
<td style="border:1px solid rgb(221,221,221);"><a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075d.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/075d.png" alt="" style="border:0px;"></a></td>
<td style="border:1px solid rgb(221,221,221);">无 recover time</td>
<td style="border:1px solid rgb(221,221,221);">准确性有损失</td>
</tr></tbody></table><h4 style="line-height:1.4;font-size:1.25em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t10" style="color:rgb(202,0,0);"></a><a id="user-content-driver-端长时容错" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#driver-%E7%AB%AF%E9%95%BF%E6%97%B6%E5%AE%B9%E9%94%99" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1.2;background-color:transparent;"></a>driver
 端长时容错</h4>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
前面我们讲过，块数据的 meta 信息上报到 ReceiverTracker，然后交给 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceivedBlockTracker</code> 做具体的管理。<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceivedBlockTracker</code> 也采用
 WAL 冷备方式进行备份，在 driver 失效后，由新的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">ReceivedBlockTracker</code> 读取 WAL 并恢复 block 的 meta 信息。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
另外，需要定时对 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 和 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">JobScheduler</code> 做 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Checkpoint</code>，来记录整个 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 的变化、和每个
 batch 的 job 的完成情况。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
注意到这里采用的是完整 checkpoint 的方式，和之前的 WAL 的方式都不一样。<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Checkpoint</code> 通常也是落地到可靠存储如 HDFS。<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Checkpoint</code> 发起的间隔默认的是和 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">batchDuration
 一致</code>；即每次 batch 发起、提交了需要运行的 job 后就做<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Checkpoint</code>，另外在 job 完成了更新任务状态的时候再次做一下 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">Checkpoint</code>。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
这样一来，在 driver 失效并恢复后，可以读取最近一次的 Checkpoint 来恢复作业的 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">DStreamGraph</code> 和 job 的运行及完成状态。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/img.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/img.png" alt="image" style="border:0px;"></a></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
总结一下本节内容为上述表格，可以看到，Spark Streaming 的长时容错特性，能够提供不重、不丢，exactly-once 的处理语义。</p>
<h2 style="line-height:1.225;font-size:1.75em;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(238,238,238);color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t11" style="color:rgb(202,0,0);"></a><a id="user-content-三入口streamingcontext" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#%E4%B8%89%E5%85%A5%E5%8F%A3streamingcontext" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1;background-color:transparent;"></a>三、入口：StreamingContext</h2>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
上面我们花了很多篇幅来介绍 Spark Streaming 的四大模块，我们在最后介绍一下 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">StreamingContext</code>。</p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
下面我们用这段仅 11 行的完整 <a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/http:/spark.apache.org/docs/latest/streaming-programming-guide.html#a-quick-example" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;">quick
 example</a>，来说明用户 code 是怎么通过 <code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">StreamingContext</code> 与前面几个模块进行交互的：</p>
<div class="highlight highlight-source-scala" style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<pre style="overflow:auto;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;line-height:1.45;background-color:rgb(247,247,247);"><span class="pl-k" style="color:rgb(167,29,93);">import</span> <span class="pl-v" style="color:rgb(237,106,67);">org.apache.spark.</span><span class="pl-v" style="color:rgb(237,106,67);">_</span>
<span class="pl-k" style="color:rgb(167,29,93);">import</span> <span class="pl-v" style="color:rgb(237,106,67);">org.apache.spark.streaming.</span><span class="pl-v" style="color:rgb(237,106,67);">_</span>

<span class="pl-c" style="color:rgb(150,152,150);">// 首先配置一下本 quick example 将跑在本机，app name 是 NetworkWordCount</span>
<span class="pl-k" style="color:rgb(167,29,93);">val</span> <span class="pl-en" style="color:rgb(121,93,163);">conf</span> <span class="pl-k" style="color:rgb(167,29,93);">=</span> <span class="pl-k" style="color:rgb(167,29,93);">new</span> <span class="pl-en" style="color:rgb(121,93,163);">SparkConf</span>().setMaster(<span class="pl-s" style="color:rgb(24,54,145);"><span class="pl-pds">"</span>local[2]<span class="pl-pds">"</span></span>).setAppName(<span class="pl-s" style="color:rgb(24,54,145);"><span class="pl-pds">"</span>NetworkWordCount<span class="pl-pds">"</span></span>)
<span class="pl-c" style="color:rgb(150,152,150);">// batchDuration 设置为 1 秒，然后创建一个 streaming 入口</span>
<span class="pl-k" style="color:rgb(167,29,93);">val</span> <span class="pl-en" style="color:rgb(121,93,163);">ssc</span> <span class="pl-k" style="color:rgb(167,29,93);">=</span> <span class="pl-k" style="color:rgb(167,29,93);">new</span> <span class="pl-en" style="color:rgb(121,93,163);">StreamingContext</span>(conf, <span class="pl-en" style="color:rgb(121,93,163);">Seconds</span>(<span class="pl-c1" style="color:rgb(0,134,179);">1</span>))

<span class="pl-c" style="color:rgb(150,152,150);">// ssc.socketTextStream() 将创建一个 SocketInputDStream；这个 InputDStream 的 SocketReceiver 将监听本机 9999 端口</span>
<span class="pl-k" style="color:rgb(167,29,93);">val</span> <span class="pl-en" style="color:rgb(121,93,163);">lines</span> <span class="pl-k" style="color:rgb(167,29,93);">=</span> ssc.socketTextStream(<span class="pl-s" style="color:rgb(24,54,145);"><span class="pl-pds">"</span>localhost<span class="pl-pds">"</span></span>, <span class="pl-c1" style="color:rgb(0,134,179);">9999</span>)

<span class="pl-k" style="color:rgb(167,29,93);">val</span> <span class="pl-en" style="color:rgb(121,93,163);">words</span> <span class="pl-k" style="color:rgb(167,29,93);">=</span> lines.flatMap(_.split(<span class="pl-s" style="color:rgb(24,54,145);"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>))      <span class="pl-c" style="color:rgb(150,152,150);">// DStream transformation</span>
<span class="pl-k" style="color:rgb(167,29,93);">val</span> <span class="pl-en" style="color:rgb(121,93,163);">pairs</span> <span class="pl-k" style="color:rgb(167,29,93);">=</span> words.map(word <span class="pl-k" style="color:rgb(167,29,93);">=&gt;</span> (word, <span class="pl-c1" style="color:rgb(0,134,179);">1</span>))     <span class="pl-c" style="color:rgb(150,152,150);">// DStream transformation</span>
<span class="pl-k" style="color:rgb(167,29,93);">val</span> <span class="pl-en" style="color:rgb(121,93,163);">wordCounts</span> <span class="pl-k" style="color:rgb(167,29,93);">=</span> pairs.reduceByKey(_ <span class="pl-k" style="color:rgb(167,29,93);">+</span> _)    <span class="pl-c" style="color:rgb(150,152,150);">// DStream transformation</span>
wordCounts.print()                           <span class="pl-c" style="color:rgb(150,152,150);">// DStream transformation</span>
<span class="pl-c" style="color:rgb(150,152,150);">// 上面 4 行利用 DStream transformation 构造出了 lines -&gt; words -&gt; pairs -&gt; wordCounts -&gt; .print() 这样一个 DStreamGraph</span>
<span class="pl-c" style="color:rgb(150,152,150);">// 但注意，到目前是定义好了产生数据的 SocketReceiver，以及一个 DStreamGraph，这些都是静态的</span>

<span class="pl-c" style="color:rgb(150,152,150);">// 下面这行 start() 将在幕后启动 JobScheduler, 进而启动 JobGenerator 和 ReceiverTracker</span>
<span class="pl-c" style="color:rgb(150,152,150);">// ssc.start()</span>
<span class="pl-c" style="color:rgb(150,152,150);">//    -&gt; JobScheduler.start()</span>
<span class="pl-c" style="color:rgb(150,152,150);">//        -&gt; JobGenerator.start();    开始不断生成一个一个 batch</span>
<span class="pl-c" style="color:rgb(150,152,150);">//        -&gt; ReceiverTracker.start(); 开始往 executor 上分布 ReceiverSupervisor 了，也会进一步创建和启动 Receiver</span>
ssc.start()

<span class="pl-c" style="color:rgb(150,152,150);">// 然后用户 code 主线程就 block 在下面这行代码了</span>
<span class="pl-c" style="color:rgb(150,152,150);">// block 的后果就是，后台的 JobScheduler 线程周而复始的产生一个一个 batch 而不停息</span>
<span class="pl-c" style="color:rgb(150,152,150);">// 也就是在这里，我们前面静态定义的 DStreamGraph 的 print()，才一次一次被在 RDD 实例上调用，一次一次打印出当前 batch 的结果</span>
ssc.awaitTermination()</pre>
</div>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
所以我们看到，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;">StreamingContext</code> 是 Spark Streaming 提供给用户 code 的、与前述 4 个模块交互的一个简单和统一的入口。</p>
<h2 style="line-height:1.225;font-size:1.75em;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(238,238,238);color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';">
<a name="t12" style="color:rgb(202,0,0);"></a><a id="user-content-四总结与回顾" class="anchor" href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.1%20Spark%20Streaming%20%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E4%B8%8E%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0.md#%E5%9B%9B%E6%80%BB%E7%BB%93%E4%B8%8E%E5%9B%9E%E9%A1%BE" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;display:inline-block;margin-left:-18px;line-height:1;background-color:transparent;"></a>四、总结与回顾</h2>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
在最后我们再把 <a href="http://spark.apache.org/docs/latest/streaming-programming-guide.html#a-quick-example" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;">Sark Streaming 官方 Programming Guide</a> 的部分内容放在这里，作为本文的一个回顾和总结。请大家看一看，如果看懂了本文的内容，是不是读下面这些比较
 high-level 的介绍会清晰化很多 :-)</p>
<blockquote style="color:rgb(119,119,119);border-left-width:4px;border-left-style:solid;border-left-color:rgb(221,221,221);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<p>
Spark Streaming is an extension of the core Spark API that enables scalable, high-throughput, fault-tolerant stream processing of live data streams. Data can be ingested from many sources like Kafka, Flume, Twitter, ZeroMQ, Kinesis, or TCP sockets, and can
 be processed using complex algorithms expressed with high-level functions like map, reduce, join and window. Finally, processed data can be pushed out to filesystems, databases, and live dashboards. In fact, you can apply Spark’s machine learning and graph
 processing algorithms on data streams.</p>
<p>
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/streaming-arch.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/streaming-arch.png" alt="" style="border:0px;"></a></p>
<p>
Internally, it works as follows. Spark Streaming receives live input data streams and divides the data into batches, which are then processed by the Spark engine to generate the final stream of results in batches.</p>
<p>
<a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/streaming-flow.png" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;"><img src="https://github.com/proflin/CoolplaySpark/raw/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/0.imgs/streaming-flow.png" alt="" style="border:0px;"></a></p>
<p>
Spark Streaming provides a high-level abstraction called discretized stream or DStream, which represents a continuous stream of data. DStreams can be created either from input data streams from sources such as Kafka, Flume, and Kinesis, or by applying high-level
 operations on other DStreams. Internally, a DStream is represented as a sequence of RDDs.</p>
<p>
...</p>
</blockquote>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
<br><br></p>
<p style="color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';font-size:16px;line-height:25.6px;">
（本文完，参与本文的讨论请 <a href="https://github.com/proflin/CoolplaySpark/issues/1" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;">猛戳这里</a>，返回目录请 <a href="https://github.com/proflin/CoolplaySpark/blob/master/Spark%20Streaming%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97/readme.md" rel="nofollow" style="color:rgb(64,120,192);text-decoration:none;background-color:transparent;">猛戳这里</a>）</p>
<br>            </div>
                </div>
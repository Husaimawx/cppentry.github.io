---
layout:     post
title:      flume_简介及使用
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <p align="justify">一、简介</p><p>Flume <span style="font-family:'宋体';">是 </span><span style="font-family:Calibri;">Cloudera </span><span style="font-family:'宋体';">提供的一个高可用的，高可靠的，分布式的海量日志采集、聚合</span></p><p><span style="font-family:'宋体';">和传输的系统，</span>Flume <span style="font-family:'宋体';">支持在日志系统中定制各类数据发送方，用于收集数据；同时，</span></p><p>Flume <span style="font-family:'宋体';">提供对数据进行简单处理，并写到各种数据接受方（可定制）的能力。</span></p><p> </p><p align="justify">二、Flume<span style="font-family:'宋体';">体系结构</span></p><p><img src="https://img-blog.csdn.net/20180511111920749" alt=""></p><p> </p><p><span style="font-family:'宋体';">在</span>flume<span style="font-family:'宋体';">官网</span><span style="font-family:Calibri;">http://flume.apache.org/</span></p><p>首页就有体系结构图：</p><p> <img src="https://img-blog.csdn.net/20180511111944949" alt=""></p><p> Flume<span style="font-family:'宋体';">核心：</span><span style="font-family:Calibri;">agent = source+channel+sink</span><span style="font-family:'宋体';">：</span></p><p>Source<span style="font-family:'宋体';">组件：用于采集各种不同源的日志</span></p><p>Channel<span style="font-family:'宋体';">组件：数据缓冲区、通道</span></p><p>Sink<span style="font-family:'宋体';">组件：用于将日志写到不同的目的地。</span></p><p> </p><p><span style="font-family:'宋体';">如果要使用</span>flume<span style="font-family:'宋体';">，最重要的就是在配置文件中配置</span><span style="font-family:Calibri;">agent</span></p><p> </p><p> </p><p align="justify">三、Source<span style="font-family:'宋体';">组件</span></p><p><span style="font-family:'宋体';">在官网找到帮助文档，左侧的</span>documentaion<span style="font-family:'宋体';">，如下：</span></p><p> <img src="https://img-blog.csdn.net/20180511112013919" alt=""></p><p><span style="font-family:'宋体';">在</span>flume source<span style="font-family:'宋体';">章节，可以看到有很多</span><span style="font-family:Calibri;">source</span><span style="font-family:'宋体';">，如最常用的几个：监控目录，</span><span style="font-family:Calibri;">kafka</span><span style="font-family:'宋体';">，</span><span style="font-family:Calibri;">http</span><span style="font-family:'宋体';">，自定义等</span></p><p> <img src="https://img-blog.csdn.net/20180511112039770" alt=""><img src="https://img-blog.csdn.net/20180511112047670" alt=""></p><p> </p><p align="justify">四、Channel<span style="font-family:'宋体';">组件</span></p><p>数据缓冲区，通道。</p><p><span style="font-family:'宋体';">最常用的是放到内存中：</span>memory channel</p><p> <img src="https://img-blog.csdn.net/20180511112108301" alt=""></p><p> </p><p align="justify">五、Sink<span style="font-family:'宋体';">组件</span></p><p> <img src="https://img-blog.csdn.net/20180511112126191" alt=""></p><p>  </p><p align="justify">六、使用</p><p><span style="font-family:'宋体';">解压</span>flume<span style="font-family:'宋体';">包，如：</span><span style="font-family:Calibri;">/opt/flume/apache-flume-1.7.0-bin</span></p><p> </p><p><span style="font-family:'宋体';">例子：监控一个目录中的日志文件，通过内存进行缓冲，最后写到</span>hdfs<span style="font-family:'宋体';">中</span></p><p>1. <span style="font-family:'宋体';">创建</span>agent<span style="font-family:'宋体';">的配置文件，如：</span><span style="font-family:Calibri;">/opt/myagent/a4.conf</span></p><p>内容如下：</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">定义 </span><span style="font-family:Calibri;">agent </span><span style="font-family:'宋体';">名， </span><span style="font-family:Calibri;">source</span><span style="font-family:'宋体';">、</span><span style="font-family:Calibri;">channel</span><span style="font-family:'宋体';">、</span><span style="font-family:Calibri;">sink </span><span style="font-family:'宋体';">的名称</span></span></p><p>a4.sources = r1</p><p>a4.channels = c1</p><p>a4.sinks = k1</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">具体定义 </span><span style="font-family:Calibri;">source</span></span><span style="color:rgb(0,128,0);">（</span><span style="color:rgb(0,128,0);">监控目录）</span></p><p>a4.sources.r1.type = spooldir</p><p>a4.sources.r1.spoolDir = /root/training/logs</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">具体定义 </span><span style="font-family:Calibri;">channel</span></span><span style="color:rgb(0,128,0);">（</span><span style="color:rgb(0,128,0);">内存缓冲）</span></p><p>a4.channels.c1.type = memory</p><p>a4.channels.c1.capacity = 10000</p><p>a4.channels.c1.transactionCapacity = 100</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">定义拦截器，为消息添加时间戳</span></span></p><p>a4.sources.r1.interceptors = i1</p><p>a4.sources.r1.interceptors.i1.type =</p><p>org.apache.flume.interceptor.TimestampInterceptor$Builder</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">具体定义 </span><span style="font-family:Calibri;">sink</span></span><span style="color:rgb(0,128,0);">（</span><span style="color:rgb(0,128,0);"><span style="font-family:'宋体';">写到</span>hdfs<span style="font-family:'宋体';">中）</span></span></p><p>a4.sinks.k1.type = hdfs</p><p>a4.sinks.k1.hdfs.path = hdfs://192.168.56.111:9000/flume/%Y%m%d</p><p>a4.sinks.k1.hdfs.filePrefix = events-</p><p>a4.sinks.k1.hdfs.fileType = DataStream</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">不按照条数生成文件</span></span></p><p>a4.sinks.k1.hdfs.rollCount = 0</p><p><span style="color:rgb(0,128,0);">#HDFS <span style="font-family:'宋体';">上的文件达到 </span><span style="font-family:Calibri;">128M </span><span style="font-family:'宋体';">时生成一个文件</span></span></p><p>a4.sinks.k1.hdfs.rollSize = 134217728</p><p><span style="color:rgb(0,128,0);">#HDFS <span style="font-family:'宋体';">上的文件达到 </span><span style="font-family:Calibri;">60 </span><span style="font-family:'宋体';">秒生成一个文件</span></span></p><p>a4.sinks.k1.hdfs.rollInterval = 60</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">组装 </span><span style="font-family:Calibri;">source</span><span style="font-family:'宋体';">、</span><span style="font-family:Calibri;">channel</span><span style="font-family:'宋体';">、</span><span style="font-family:Calibri;">sink</span></span></p><p>a4.sources.r1.channels = c1</p><p>a4.sinks.k1.channel = c1</p><p> </p><p>2. 执行命令</p><p>cd /opt/flume/apache-flume-1.7.0-bin</p><p>bin/flume-ng <span style="color:rgb(0,0,153);">agent </span>-n a4 -f /opt/myagent/a4.conf -c conf -Dflume.root.logger=INFO,console</p><p><span style="font-family:'宋体';">执行</span>flume-ng<span style="font-family:'宋体';">命令，后面指定</span><span style="font-family:Calibri;">agent</span><span style="font-family:'宋体';">，</span></p><p>-n<span style="font-family:'宋体';">指定</span><span style="font-family:Calibri;">agent</span><span style="font-family:'宋体';">的名字，必须和配置文件中那个</span><span style="font-family:Calibri;">a4</span><span style="font-family:'宋体';">同名；</span></p><p>-f<span style="font-family:'宋体';">指定配置文件</span></p><p>-c <span style="font-family:'宋体';">使用配置，即安装目录下的</span><span style="font-family:Calibri;">conf</span><span style="font-family:'宋体';">路径</span></p><p>-D<span style="font-family:'宋体';">参数，指定当前日志级别，输出到工作台</span></p><p> </p><p><span style="font-family:'宋体';">执行上面的命令，启动</span>flume<span style="font-family:'宋体';">。</span></p><p>然后给监控的目录/root/training/logs中添加文件，模拟生成日志。</p><p><span style="font-family:'宋体';">这时在</span>hdfs<span style="font-family:'宋体';">中</span>/flume<span style="font-family:'宋体';">下会按日期产生一个新目录，目录下有一个</span>tmp<span style="font-family:'宋体';">文件，因为上面配置了</span><span style="font-family:Calibri;">128M</span><span style="font-family:'宋体';">或者</span><span style="font-family:Calibri;">60</span><span style="font-family:'宋体';">秒才会写真正的文件，因此暂时为</span><span style="font-family:Calibri;">tmp</span><span style="font-family:'宋体';">文件，触发后不再是</span><span style="font-family:Calibri;">tmp</span><span style="font-family:'宋体';">。</span></p><p> </p><p>其他用例：</p><p><span style="font-family:'宋体';">如</span>netcat<span style="font-family:'宋体';">监控</span><span style="font-family:Calibri;">8080</span><span style="font-family:'宋体';">端口的请求数据</span></p><p>a1.sources.r1.type = netcat</p><p>a1.sources.r1.bind = localhost</p><p>a1.sources.r1.port = 8080</p><p> </p><p><span style="font-family:'宋体';">监控一直在追加的日志数据，通过</span>exec<span style="font-family:'宋体';">命令的方式：</span></p><p>a2.sources.r1.type = exec</p><p>a2.sources.r1.command = tail -f /home/hadoop/a.log</p><p><span style="color:rgb(0,128,0);">#<span style="font-family:'宋体';">只输出到控制台</span></span></p><p>a2.sinks.k1.type = logger</p><p> </p><p>其他内容可以参考官网上的例子</p>            </div>
                </div>
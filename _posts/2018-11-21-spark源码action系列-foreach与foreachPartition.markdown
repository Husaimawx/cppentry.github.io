---
layout:     post
title:      spark源码action系列-foreach与foreachPartition
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								<div class="article-copyright">
					版权声明：本文为博主原创文章，未经博主允许不得转载。					https://blog.csdn.net/u014393917/article/details/50607437				</div>
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                
<h3>RDD.foreachPartition/foreach<span style="font-family:SimSun;">的操作</span></h3>
<p>在这个<span style="font-family:'Times New Roman';">action</span><span style="font-family:SimSun;">的操作中</span><span style="font-family:'Times New Roman';">:</span></p>
<p>这两个<span style="font-family:'Times New Roman';">action</span><span style="font-family:SimSun;">主要用于对每个</span><span style="font-family:'Times New Roman';">partition</span><span style="font-family:SimSun;">中的</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">时行迭代的处理</span><span style="font-family:'Times New Roman';">.</span><span style="font-family:SimSun;">通过用户传入的</span><span style="font-family:'Times New Roman';">function</span><span style="font-family:SimSun;">对</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">进行内容的处理</span><span style="font-family:'Times New Roman';">.</span></p>
<p><span>首先我们先看看<span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">的操作</span></span>:</p>
<p>在<span style="font-family:'Times New Roman';">fureach</span><span style="font-family:SimSun;">中</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">传入一个</span><span style="font-family:'Times New Roman';">function,</span><span style="font-family:SimSun;">这个函数的传入参数就是每个</span><span style="font-family:'Times New Roman';">partition</span><span style="font-family:SimSun;">中</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">每次的</span><span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">得到的一个</span><span style="font-family:'Times New Roman';">rdd</span><span style="font-family:SimSun;">的</span><span style="font-family:'Times New Roman';">kv</span><span style="font-family:SimSun;">实例</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">也就是具体的内容</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">这种处理你并不知道这个</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">的</span><span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">什么时候结果</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">只能是</span><span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">的过程中</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">你得到一条数据</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">就处理一条数据</span><span style="font-family:'Times New Roman';">.</span></p>
<p>由下面的红色部分可以看出<span style="font-family:'Times New Roman';">,foreach</span><span style="font-family:SimSun;">操作是直接调用了</span><span style="font-family:'Times New Roman';">partition</span><span style="font-family:SimSun;">中数据的</span><span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">操作</span><span style="font-family:'Times New Roman';">.</span></p>
<p style="background:rgb(255,255,255);"><span style="background:rgb(228,228,255);">def</span><span style="background:rgb(255,255,255);"> </span><span style="color:#000000;background:rgb(255,255,255);">foreach(f: </span><span style="color:#20999d;background:rgb(255,255,255);">T </span><span style="color:#000000;background:rgb(255,255,255);">=&gt; </span><span style="color:#cc7832;background:rgb(255,255,255);">Unit</span><span style="color:#000000;background:rgb(255,255,255);">): </span><span style="color:#cc7832;background:rgb(255,255,255);">Unit </span><span style="color:#000000;background:rgb(255,255,255);">= </span><span style="color:#000000;background:rgb(228,228,255);">withScope {</span><span style="color:#000000;background:rgb(228,228,255);"><br></span><span style="color:#000000;background:rgb(228,228,255);">  </span><span style="background:rgb(228,228,255);">val </span><span style="color:#000000;background:rgb(228,228,255);">cleanF = sc.clean(f)</span><span style="color:#000000;background:rgb(228,228,255);"><br></span><span style="color:#000000;background:rgb(228,228,255);">  sc.runJob(</span><span style="background:rgb(228,228,255);">this</span><span style="color:#cc7832;background:rgb(228,228,255);">, </span><span style="color:#FF0000;background:rgb(228,228,255);">(</span><span style="color:#FF0000;background:rgb(228,228,255);">iter: Iterator[T]) =&gt; iter.foreach(cleanF)</span><span style="color:#000000;background:rgb(228,228,255);">)</span><span style="color:#000000;background:rgb(228,228,255);"><br></span><span style="color:#000000;background:rgb(228,228,255);">}</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">示例说明:</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">val list = new ArrayBuffer()</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">Rdd.foreach(record =&gt; {</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">  list += record</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">  If (list.size &gt;= 10000) {</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">    list.flush....</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">  }</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">})</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">上面这段示例代码中,如果这么使用就会存在一个问题,</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">迭代的最后,list的结果可能还没有达到10000条,这个时候,你在内部的处理的flush部分就不会执行,也就是迭代的最后如果没有达到10000的数据就会丢失.</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">所以在foreach中,一般就是拿到一条数据进行下处理Rdd.foreach(record =&gt; {record._1 == a return})</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);"> </span></p>
<p><span>然后接下来看看<span style="font-family:'Times New Roman';">foreachPartition</span></span>:</p>
<p>这个函数也是根据传入的<span style="font-family:'Times New Roman';">function</span><span style="font-family:SimSun;">进行处理</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">但不同处在于</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">这里</span><span style="font-family:'Times New Roman';">function</span><span style="font-family:SimSun;">的传入参数是一个</span><span style="font-family:'Times New Roman';">partition</span><span style="font-family:SimSun;">对应数据的</span><span style="font-family:'Times New Roman';">iterator.</span><span style="font-family:SimSun;">而不是直接使用</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">的</span><span style="font-family:'Times New Roman';">foreach,</span></p>
<p>这种情况下<span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">如果是上面</span><span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">的示例代码中</span><span style="font-family:'Times New Roman';">list</span><span style="font-family:SimSun;">这个片段在这个</span><span style="font-family:'Times New Roman';">action</span><span style="font-family:SimSun;">中就能够正常的去处理</span><span style="font-family:'Times New Roman';">.</span></p>
<p style="background:rgb(255,255,255);"><span style="background:rgb(228,228,255);">def</span><span style="background:rgb(255,255,255);"> </span><span style="color:#000000;background:rgb(255,255,255);">foreachPartition(f: </span><span style="color:#20999d;background:rgb(255,255,255);">Iterator</span><span style="color:#000000;background:rgb(255,255,255);">[</span><span style="color:#20999d;background:rgb(255,255,255);">T</span><span style="color:#000000;background:rgb(255,255,255);">] =&gt; </span><span style="color:#cc7832;background:rgb(255,255,255);">Unit</span><span style="color:#000000;background:rgb(255,255,255);">): </span><span style="color:#cc7832;background:rgb(255,255,255);">Unit </span><span style="color:#000000;background:rgb(255,255,255);">= </span><span style="color:#000000;background:rgb(228,228,255);">withScope {</span><span style="color:#000000;background:rgb(228,228,255);"><br></span><span style="color:#000000;background:rgb(228,228,255);">  </span><span style="background:rgb(228,228,255);">val </span><span style="color:#000000;background:rgb(228,228,255);">cleanF = sc.clean(f)</span><span style="color:#000000;background:rgb(228,228,255);"><br></span><span style="color:#000000;background:rgb(228,228,255);">  sc.runJob(</span><span style="background:rgb(228,228,255);">this</span><span style="color:#cc7832;background:rgb(228,228,255);">,<span style="color:#FF0000;"> </span></span><span style="color:#FF0000;background:rgb(228,228,255);">(iter: Iterator[T]) =&gt; cleanF(iter)</span><span style="color:#000000;background:rgb(228,228,255);">)</span><span style="color:#000000;background:rgb(228,228,255);"><br></span><span style="color:#000000;background:rgb(228,228,255);">}</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);"> </span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">示例代码:</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">Val list = new ArrayBuffer</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">rdd.foreachPartition(it =&gt; {</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">  It.foreach(r =&gt; {</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">List += r</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">If (list.size &gt; 10000) flush</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">  })</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">  If (list.size &gt; 0) flush</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);">})</span></p>
<p style="background:rgb(255,255,255);"><span style="color:#000000;background:rgb(228,228,255);"> </span></p>
<p><span>最后说下这两个<span style="font-family:'Times New Roman';">action</span><span style="font-family:SimSun;">的区别</span></span>:</p>
<p>Foreach<span style="font-family:SimSun;">与</span><span style="font-family:'Times New Roman';">foreachPartition</span><span style="font-family:SimSun;">都是在每个</span><span style="font-family:'Times New Roman';">partition</span><span style="font-family:SimSun;">中对</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">进行操作</span><span style="font-family:'Times New Roman';">,</span></p>
<p>不同的是<span style="font-family:'Times New Roman';">,foreach</span><span style="font-family:SimSun;">是直接在每个</span><span style="font-family:'Times New Roman';">partition</span><span style="font-family:SimSun;">中直接对</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">执行</span><span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">操作</span><span style="font-family:'Times New Roman';">,</span><span style="font-family:SimSun;">而传入的</span><span style="font-family:'Times New Roman';">function</span><span style="font-family:SimSun;">只是在</span><span style="font-family:'Times New Roman';">foreach</span><span style="font-family:SimSun;">内部使用</span><span style="font-family:'Times New Roman';">,</span></p>
<p>而<span style="font-family:'Times New Roman';">foreachPartition</span><span style="font-family:SimSun;">是在每个</span><span style="font-family:'Times New Roman';">partition</span><span style="font-family:SimSun;">中把</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">给传入的</span><span style="font-family:'Times New Roman';">function,</span><span style="font-family:SimSun;">让</span><span style="font-family:'Times New Roman';">function</span><span style="font-family:SimSun;">自己对</span><span style="font-family:'Times New Roman';">iterator</span><span style="font-family:SimSun;">进行处理</span><span style="font-family:'Times New Roman';">.</span></p>
            </div>
                </div>
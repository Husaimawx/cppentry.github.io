---
layout:     post
title:      在 Spark DataFrame 中使用Time Window
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								<div class="article-copyright">
					版权声明：本文为博主原创文章，未经博主允许不得转载。					https://blog.csdn.net/wangpei1949/article/details/83855223				</div>
								            <div id="content_views" class="markdown_views prism-dracula">
							<!-- flowchart 箭头图标 勿删 -->
							<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path></svg>
							<p>从Spark 2.0.0开始，Spark Sql包内置和Spark Streaming类似的Time Window，方便我们通过时间来理解数据。</p>
<h3><a id="Spark_SqlWindow_API_3"></a>Spark Sql包中的Window API</h3>
<h5><a id="Tumbling_Window_5"></a>Tumbling Window</h5>
<pre><code class="prism language-java"><span class="token function">window</span><span class="token punctuation">(</span>timeColumn<span class="token operator">:</span> Column<span class="token punctuation">,</span> windowDuration<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Column
</code></pre>
<h5><a id="Slide_Window_9"></a>Slide Window</h5>
<pre><code class="prism language-java"><span class="token function">window</span><span class="token punctuation">(</span>timeColumn<span class="token operator">:</span> Column<span class="token punctuation">,</span> windowDuration<span class="token operator">:</span> String<span class="token punctuation">,</span> slideDuration<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Column
<span class="token function">window</span><span class="token punctuation">(</span>timeColumn<span class="token operator">:</span> Column<span class="token punctuation">,</span>windowDuration<span class="token operator">:</span> String<span class="token punctuation">,</span>slideDuration<span class="token operator">:</span> String<span class="token punctuation">,</span>startTime<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Column
</code></pre>
<h5><a id="_14"></a>注意</h5>
<ol>
<li>
<p><code>timeColumn</code> 时间列的<code>schema</code>必须是<code>timestamp</code>类型。</p>
</li>
<li>
<p>窗口间隔(<code>windowDuration</code>、<code>slideDuration</code>)是字符串类型。如 <code>0 years</code>、<code>0 months</code> 、<code>1 week</code>、<code>0 days</code>、 <code>0 hours</code>、<code>0 minute</code>、 <code>0 seconds</code>、 <code>1 milliseconds</code>、 <code>0 microseconds</code>。</p>
</li>
<li>
<p><code>startTime</code> 开始的位置。如从每小时第15分钟开始，<code>startTime</code>为<code>15 minutes</code>。</p>
</li>
</ol>
<h3><a id="_22"></a>测试数据</h3>
<pre><code class="prism language-java">data<span class="token operator">/</span>cpu_memory_disk_monitor<span class="token punctuation">.</span>csv，每行是每隔<span class="token number">5</span>分钟对CPU、内存、磁盘的监控。如下：

eventTime<span class="token punctuation">,</span>cpu<span class="token punctuation">,</span>memory<span class="token punctuation">,</span>disk
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span><span class="token number">2.87</span><span class="token punctuation">,</span><span class="token number">28.23</span><span class="token punctuation">,</span><span class="token number">58</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">01</span><span class="token punctuation">,</span><span class="token number">4.32</span><span class="token punctuation">,</span><span class="token number">28.47</span><span class="token punctuation">,</span><span class="token number">58</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">02</span><span class="token punctuation">,</span><span class="token number">3.15</span><span class="token punctuation">,</span><span class="token number">28.72</span><span class="token punctuation">,</span><span class="token number">58</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">02</span><span class="token punctuation">,</span><span class="token number">3.62</span><span class="token punctuation">,</span><span class="token number">28.65</span><span class="token punctuation">,</span><span class="token number">58</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">02</span><span class="token punctuation">,</span><span class="token number">3.25</span><span class="token punctuation">,</span><span class="token number">28.70</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">02</span><span class="token punctuation">,</span><span class="token number">3.63</span><span class="token punctuation">,</span><span class="token number">28.85</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">2.76</span><span class="token punctuation">,</span><span class="token number">28.96</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">3.44</span><span class="token punctuation">,</span><span class="token number">29.07</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">6.14</span><span class="token punctuation">,</span><span class="token number">41.54</span><span class="token punctuation">,</span><span class="token number">60</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">14.84</span><span class="token punctuation">,</span><span class="token number">35.44</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span><span class="token number">20.68</span><span class="token punctuation">,</span><span class="token number">39.99</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">04</span><span class="token punctuation">,</span><span class="token number">7.53</span><span class="token punctuation">,</span><span class="token number">33.55</span><span class="token punctuation">,</span><span class="token number">61</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">9.27</span><span class="token punctuation">,</span><span class="token number">36.83</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">4.78</span><span class="token punctuation">,</span><span class="token number">35.79</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">12.02</span><span class="token punctuation">,</span><span class="token number">36.55</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span><span class="token number">2.23</span><span class="token punctuation">,</span><span class="token number">34.89</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span><span class="token number">4.44</span><span class="token punctuation">,</span><span class="token number">35.29</span><span class="token punctuation">,</span><span class="token number">59</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">06</span><span class="token punctuation">,</span><span class="token number">3.76</span><span class="token punctuation">,</span><span class="token number">62.45</span><span class="token punctuation">,</span><span class="token number">59</span>
</code></pre>
<h3><a id="Spark_DataFrame_Time_Window_48"></a>在Spark DataFrame 中使用Time Window</h3>
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigData<span class="token punctuation">.</span>spark

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span><span class="token punctuation">{</span>Level<span class="token punctuation">,</span> Logger<span class="token punctuation">}</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span><span class="token punctuation">{</span>SparkSession<span class="token punctuation">,</span> functions<span class="token punctuation">}</span>

<span class="token comment">/**
  * Author: Wang Pei
  * License: Copyright(c) Pei.Wang
  * Summary:
  *
  * spark 2.2.2
  *
  */</span>
object SparkDataFrameTimeWindow <span class="token punctuation">{</span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置日志等级</span>
    Logger<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">"org"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLevel</span><span class="token punctuation">(</span>Level<span class="token punctuation">.</span>WARN<span class="token punctuation">)</span>

    <span class="token comment">//spark环境</span>
    val spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">master</span><span class="token punctuation">(</span><span class="token string">"local[3]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"$"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span>_

    <span class="token comment">//读取时序数据</span>
    val data <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"header"</span><span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"inferSchema"</span><span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csv</span><span class="token punctuation">(</span><span class="token string">"data/cpu_memory_disk_monitor.csv"</span><span class="token punctuation">)</span>
    <span class="token comment">//data.printSchema()</span>

    <span class="token comment">/** 1) Tumbling window */</span>
    <span class="token comment">/** 计算: 每10分钟的平均CPU、平均内存、平均磁盘，并保留两位小数 */</span>
    data
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">year</span><span class="token punctuation">(</span>$<span class="token string">"eventTime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token number">2017</span><span class="token punctuation">,</span><span class="token number">2018</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>$<span class="token string">"eventTime"</span><span class="token punctuation">,</span><span class="token string">"10 minute"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//Time Window</span>
      <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>$<span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"avgCpu"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>functions<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>$<span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"avgMemory"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>functions<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>$<span class="token string">"disk"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"avgDisk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>$<span class="token string">"window.start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token string">"window.start"</span><span class="token punctuation">,</span>$<span class="token string">"window.end"</span><span class="token punctuation">,</span>$<span class="token string">"avgCpu"</span><span class="token punctuation">,</span>$<span class="token string">"avgMemory"</span><span class="token punctuation">,</span>$<span class="token string">"avgDisk"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>


    <span class="token comment">/** 2) Slide window */</span>
    <span class="token comment">/** 计算：从第3分钟开始，每5分钟计算最近10分钟内的平均CPU、平均内存、平均磁盘，并保留两位小数 */</span>
    data
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">year</span><span class="token punctuation">(</span>$<span class="token string">"eventTime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token number">2017</span><span class="token punctuation">,</span><span class="token number">2018</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>$<span class="token string">"eventTime"</span><span class="token punctuation">,</span><span class="token string">"10 minute"</span><span class="token punctuation">,</span><span class="token string">"5 minute"</span><span class="token punctuation">,</span><span class="token string">"3 minute"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//Time Window</span>
      <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>$<span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"avgCpu"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>functions<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>$<span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"avgMemory"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>functions<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>functions<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>$<span class="token string">"disk"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"avgDisk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>$<span class="token string">"window.start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token string">"window.start"</span><span class="token punctuation">,</span>$<span class="token string">"window.end"</span><span class="token punctuation">,</span>$<span class="token string">"avgCpu"</span><span class="token punctuation">,</span>$<span class="token string">"avgMemory"</span><span class="token punctuation">,</span>$<span class="token string">"avgDisk"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p><img src="https://github.com/wangpei1949/photos/raw/master/bigDataNut/sparkDataFrame_useWindow.png" alt="sparkDataFrame_useWindow.png"></p>

            </div>
						<link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-9e5741c4b9.css" rel="stylesheet">
                </div>
---
layout:     post
title:      hive查询语法
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <h1 style="margin-left:0cm;"><strong>Hive中的查询语句</strong></h1>

<p style="margin-left:0cm;"><span style="color:#0000FF;">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select</span></p>

<table border="1" cellspacing="0" style="margin-left:5.4pt;"><tbody><tr><td style="vertical-align:top;width:411.1pt;">
			<p style="margin-left:0cm;"><span style="color:#333333;">[WITH CommonTableExpression (, CommonTableExpression)*] (Note: Only available starting with Hive 0.13.0)<br>
			SELECT [ALL | DISTINCT] select_expr, select_expr, ...<br>
			 FROM table_reference<br>
			 [WHERE where_condition]<br>
			 [GROUP BY col_list]<br>
			 [ORDER BY col_list]<br>
			 [CLUSTER BY col_list<br>
			   | [DISTRIBUTE BY col_list] [SORT BY col_list]<br>
			 ]<br>
			 [LIMIT number]</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"> </p>

<h2 style="margin-left:0cm;"><strong>基本查询（Select…From）</strong></h2>

<h3 style="margin-left:0cm;"><strong>全表和特定列查询</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）全表查询</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）选择特定列查询</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select empno, ename from emp;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">注意：</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）</span><span style="color:#000000;">SQL </span><span style="color:#000000;">语言</span><span style="color:#FF0000;">大小写不敏感</span><span style="color:#000000;">。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）</span><span style="color:#000000;">SQL </span><span style="color:#000000;">可以写在一行或者多行</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）</span><span style="color:#FF0000;">关键词不能被缩写也不能分行</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">4</span><span style="color:#000000;">）各子句一般要分行写。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">5</span><span style="color:#000000;">）使用缩进提高语句的可读性。</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>列别名</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）重命名一个列。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）便于计算。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">3</span><span style="color:#000000;">）紧跟列名，</span> <span style="color:#FF0000;">也可以在列名和别名之间加入关键字</span><span style="color:#FF0000;">‘AS’</span><span style="color:#FF0000;">。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">4</span><span style="color:#000000;">）案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">查询名称和部门</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select ename </span><span style="color:#FF0000;">AS </span><span style="color:#7030a0;">name, deptno dn from emp;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>算术运算符</strong></h3>

<table align="center" border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:114.6pt;">
			<p style="margin-left:0cm;"><strong><span style="color:#000000;">运算符</span></strong></p>
			</td>
			<td style="vertical-align:top;width:163.9pt;">
			<p style="margin-left:0cm;"><strong><span style="color:#000000;">描述</span></strong></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:114.6pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A+B</span></p>
			</td>
			<td style="vertical-align:top;width:163.9pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">和B相加</span></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:114.6pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A-B</span></p>
			</td>
			<td style="vertical-align:top;width:163.9pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">减去B</span></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:114.6pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A*B</span></p>
			</td>
			<td style="vertical-align:top;width:163.9pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A </span><span style="color:#000000;">和B相乘</span></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:114.6pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A/B</span></p>
			</td>
			<td style="vertical-align:top;width:163.9pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">除以B</span></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:114.6pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A%B</span></p>
			</td>
			<td style="vertical-align:top;width:163.9pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">对B取余</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">示例语句</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select sal +1 from emp;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>聚合函数</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）求总行数（</span><span style="color:#000000;">count</span><span style="color:#000000;">）</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select count(*) cnt from emp;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）求工资的最大值（</span><span style="color:#000000;">max</span><span style="color:#000000;">）</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select max(sal) max_sal from emp;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">3</span><span style="color:#000000;">）求工资的最小值（</span><span style="color:#000000;">min</span><span style="color:#000000;">）</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select min(sal) min_sal from emp;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">4</span><span style="color:#000000;">）求工资的总和（</span><span style="color:#000000;">sum</span><span style="color:#000000;">）</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select sum(sal) sum_sal from emp;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">5</span><span style="color:#000000;">）求工资的平均值（</span><span style="color:#000000;">avg</span><span style="color:#000000;">）</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select avg(sal) avg_sal from emp;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>Limit子句</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">典型的查询会返回多行数据。</span><span style="color:#000000;"> LIMIT </span><span style="color:#000000;">子句用于限制返回的行数。</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp limit 5;</span></p>

<p style="margin-left:0cm;"> </p>

<h2 style="margin-left:0cm;"><strong>条件子句(Where)</strong></h2>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）使用</span><span style="color:#000000;"> WHERE </span><span style="color:#000000;">子句，将不满足条件的行过滤掉。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）</span><span style="color:#000000;">WHERE </span><span style="color:#000000;">子句紧随</span><span style="color:#000000;"> FROM </span><span style="color:#000000;">子句。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">3</span><span style="color:#000000;">）示例语句</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">查询出薪水大于</span><span style="color:#000000;"> 1000 </span><span style="color:#000000;">的所有员工</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp </span><span style="color:#FF0000;">where </span><span style="color:#7030a0;">sal &gt;1000;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>比较运算符（Between/In/ Is Null）在Where子句中的应用</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）下面表中描述了谓词操作符，这些操作符同样可以用于</span><span style="color:#000000;">JOIN…ON</span><span style="color:#000000;">和</span><span style="color:#000000;">HAVING</span><span style="color:#000000;">语句中。</span></p>

<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:97.55pt;">
			<p style="margin-left:0cm;"><strong><span style="color:#000000;">操作符</span></strong></p>
			</td>
			<td style="vertical-align:top;width:3cm;">
			<p style="margin-left:0cm;"><strong><span style="color:#000000;">支持的数据类型</span></strong></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><strong><span style="color:#000000;">描述</span></strong></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A=B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">如果A等于B则返回TRUE，反之返回FALSE</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A&lt;=&gt;B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">如果A和B都为 NULL，则返回TRUE，其他的和等号（=）操作符的结果一致，如果任一为NULL则结果为NULL</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A&lt;&gt;B, A!=B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">或B为NULL则返回NULL；如果A不等于B，则返回TRUE，反之返回FALSE</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A&lt;B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"> </p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A&lt;=B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">或者B为NULL，则返回NULL；如果A小于等于B，则返回TRUE，反之返回FALSE</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A&gt;B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">或者B为NULL，则返回NULL；如果A大于B，则返回TRUE，反之返回FALSE</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A&gt;=B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A</span><span style="color:#000000;">或者B为NULL，则返回NULL；如果A大于等于B，则返回TRUE，反之返回FALSE</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A [NOT] BETWEEN</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">B AND C</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">基本数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">如果A，B或者C任一为NULL，则结果NULL。如果A的值大于等于B而且小于或等于C，则结果为TRUE，反之为FALSE。如果使用NOT关键字则可达到相反的效果。</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A IS NULL</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">所有数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">如果A等于NULL，则返回TRUE，反之返回FALSE</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A IS NOT NULL</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">所有数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">如果A不等于NULL，则返回TRUE，反之返回FALSE</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">IN(</span><span style="color:#000000;">数值1, 数值2) 所有数据类型使用IN运算显示列表中的值</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">IN (</span><span style="color:#000000;">数值1, 数值2)</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">所有数据类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">使用IN运算显示列表中的值</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A [NOT] LIKE B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">STRING</span><span style="color:#000000;">类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">B</span><span style="color:#000000;">是一个SQL下的简单正则表达式，如果A与其匹配的话，则返回TRUE；反之返回FALSE。B的表达式说明如下：</span><span style="color:#000000;">‘x%’</span><span style="color:#000000;">表示A必须以字母</span><span style="color:#000000;">‘x’</span><span style="color:#000000;">开头，</span><span style="color:#000000;">‘%x’</span><span style="color:#000000;">表示A必须以字母</span><span style="color:#000000;">’x’</span><span style="color:#000000;">结尾，而</span><span style="color:#000000;">‘%x%’</span><span style="color:#000000;">表示A包含有字母</span><span style="color:#000000;">’x’,</span><span style="color:#000000;">可以位于开头，结尾或者字符串中间。如果使用NO关键字则可达到相反的效果。</span></p>
			</td>
		</tr><tr><td style="width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">A RLIKE B,</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">A REGEXP B</span></p>
			</td>
			<td style="width:3cm;">
			<p style="margin-left:0cm;"><span style="color:#000000;">STRING</span><span style="color:#000000;">类型</span></p>
			</td>
			<td style="vertical-align:top;width:243.5pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">B</span><span style="color:#000000;">是一个正则表达式，如果A与其匹配，则返回TRUE；反之返回FALSE。匹配使用的是JDK中的正则表达式接口实现的，因为正则也依据其中的规则。例如：正则表达式必须和整个字符串A相匹配，而不是只需与其字符串匹配。</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"> </p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）查询出薪水等于</span><span style="color:#000000;"> 5000 </span><span style="color:#000000;">的所有员工</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp </span><span style="color:#FF0000;">where </span><span style="color:#7030a0;">sal </span><span style="color:#FF0000;">=</span><span style="color:#7030a0;">5000;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）查询工资在</span><span style="color:#000000;"> 500 </span><span style="color:#000000;">到</span><span style="color:#000000;"> 1000 </span><span style="color:#000000;">的员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where sal </span><span style="color:#FF0000;">between </span><span style="color:#7030a0;">500 </span><span style="color:#FF0000;">and </span><span style="color:#7030a0;">1000;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）查询</span><span style="color:#000000;"> comm </span><span style="color:#000000;">为空的所有员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where comm </span><span style="color:#FF0000;">is null</span><span style="color:#7030a0;">;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">4</span><span style="color:#000000;">）查询工资是</span><span style="color:#000000;">1500</span><span style="color:#000000;">和</span><span style="color:#000000;">5000</span><span style="color:#000000;">的员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where sal </span><span style="color:#FF0000;">IN (1500, 5000)</span><span style="color:#7030a0;">;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>Like和Rlike在Where子句中的应用</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）使用</span><span style="color:#000000;">LIKE</span><span style="color:#000000;">运算选择类似的值</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）选择条件可以包含字符或数字</span><span style="color:#000000;">:</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">% </span><span style="color:#FF0000;">代表零个或多个字符</span><span style="color:#FF0000;">(</span><span style="color:#FF0000;">任意个字符</span><span style="color:#FF0000;">)</span><span style="color:#FF0000;">。</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">_ </span><span style="color:#FF0000;">代表一个字符。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">3</span><span style="color:#000000;">）</span><span style="color:#000000;">RLIKE </span><span style="color:#000000;">子句是</span><span style="color:#000000;"> Hive </span><span style="color:#000000;">中这个功能的一个扩展，其可以通过</span><span style="color:#000000;">Java</span><span style="color:#000000;">的正则表达式这个更强大的语言来指定匹配条件。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">4</span><span style="color:#000000;">）案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）查找以</span><span style="color:#000000;">2</span><span style="color:#000000;">开头薪水的员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where sal </span><span style="color:#FF0000;">LIKE '2%';</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）查找第二个数值为</span><span style="color:#000000;">2</span><span style="color:#000000;">的薪水的员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where sal </span><span style="color:#FF0000;">LIKE '_2%';</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）查找薪水中含有</span><span style="color:#000000;">2</span><span style="color:#000000;">的员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where sal </span><span style="color:#FF0000;">RLIKE '[2]';</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>逻辑运算符（And/Or/Not）在Where子句中的应用</strong></h3>

<table align="center" border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:97.55pt;">
			<p style="margin-left:0cm;"><strong><span style="color:#000000;">操作符</span></strong></p>
			</td>
			<td style="vertical-align:top;width:112.15pt;">
			<p style="margin-left:0cm;"><strong><span style="color:#000000;">含义</span></strong></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">AND</span></p>
			</td>
			<td style="vertical-align:top;width:112.15pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">逻辑并</span></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">OR</span></p>
			</td>
			<td style="vertical-align:top;width:112.15pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">逻辑或</span></p>
			</td>
		</tr><tr><td style="vertical-align:top;width:97.55pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">NOT</span></p>
			</td>
			<td style="vertical-align:top;width:112.15pt;">
			<p style="margin-left:0cm;"><span style="color:#000000;">逻辑非</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"> </p>

<p style="margin-left:0cm;"><span style="color:#000000;">案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）查询薪水大于</span><span style="color:#000000;"> 1000</span><span style="color:#000000;">，部门是</span><span style="color:#000000;"> 30</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where sal&gt;1000 </span><span style="color:#FF0000;">and </span><span style="color:#7030a0;">deptno=30;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）查询薪水大于</span><span style="color:#000000;"> 1000</span><span style="color:#000000;">，或者部门是</span><span style="color:#000000;"> 30</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where sal&gt;1000 </span><span style="color:#FF0000;">or </span><span style="color:#7030a0;">deptno=30;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）查询除了</span><span style="color:#000000;"> 20 </span><span style="color:#000000;">部门和</span><span style="color:#000000;"> 30 </span><span style="color:#000000;">部门以外的员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp where deptno </span><span style="color:#FF0000;">not </span><span style="color:#7030a0;">IN(30, 20);</span></p>

<p style="margin-left:0cm;"> </p>

<h2 style="margin-left:0cm;"><strong>分组查询(Group by)</strong></h2>

<h3 style="margin-left:0cm;"><strong>Group By子句</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">GROUP BY </span><span style="color:#000000;">语句通常会和聚合函数一起使用，按照一个或者多个列队结果进行分组，然后对每个组执行聚合操作。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">案例实操：</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）计算</span><span style="color:#000000;"> emp </span><span style="color:#000000;">表每个部门的平均工资</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select t.deptno, avg(t.sal) avg_sal from emp t </span><span style="color:#FF0000;">group by </span><span style="color:#7030a0;">t.deptno;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）计算</span><span style="color:#000000;"> emp </span><span style="color:#000000;">每个部门中每个岗位的最高薪水</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select t.deptno, t.job, max(t.sal) max_sal from emp t </span><span style="color:#FF0000;">group by </span><span style="color:#7030a0;">t.deptno,t.job;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>Having 子句</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）</span><span style="color:#000000;"> having</span><span style="color:#000000;">与</span><span style="color:#000000;">where</span><span style="color:#000000;">不同点</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）</span><span style="color:#000000;"> where </span><span style="color:#000000;">针对表中的列发挥作用，查询数据；</span><span style="color:#000000;"> having </span><span style="color:#000000;">针对查询结果中的列发挥作用，筛选数据。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）</span><span style="color:#000000;"> where </span><span style="color:#000000;">后面不能写分组函数，而</span><span style="color:#000000;"> having </span><span style="color:#000000;">后面可以使用分组函数。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）</span><span style="color:#000000;"> having </span><span style="color:#000000;">只用于</span><span style="color:#000000;"> group by </span><span style="color:#000000;">分组统计语句。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）案例实操：</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）求每个部门的平均薪水大于</span><span style="color:#000000;"> 2000 </span><span style="color:#000000;">的部门</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">求每个部门的平均工资</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select deptno, avg(sal) from emp </span><span style="color:#FF0000;">group by </span><span style="color:#7030a0;">deptno;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">求每个部门的平均薪水大于</span><span style="color:#000000;"> 2000 </span><span style="color:#000000;">的部门</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select deptno, avg(sal) avg_sal from emp </span><span style="color:#FF0000;">group by </span><span style="color:#7030a0;">deptno </span><span style="color:#FF0000;">having </span><span style="color:#7030a0;">avg_sal &gt;2000;</span></p>

<p style="margin-left:0cm;"> </p>

<h2 style="margin-left:0cm;"><strong>连接查询(Join…on)</strong></h2>

<h3 style="margin-left:0cm;"><strong>等值 Join</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">Hive </span><span style="color:#000000;">支持通常的</span><span style="color:#000000;"> SQL JOIN </span><span style="color:#000000;">语句，但是</span><span style="color:#FF0000;">只支持等值连接，不支持非等值连接</span><span style="color:#000000;">。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）根据员工表和部门表中的部门编号相等，查询员工编号、员工名称和部门编号；</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select e.empno, e.ename, d.deptno, d.dname from emp e </span><span style="color:#FF0000;">join </span><span style="color:#7030a0;">dept d </span><span style="color:#FF0000;">on </span><span style="color:#7030a0;">e.deptno </span><span style="color:#FF0000;">= </span><span style="color:#7030a0;">d.deptno;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>表的别名</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）好处</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）使用别名可以简化查询。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）使用表名前缀可以提高执行效率。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">合并员工表和部门表</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select </span><span style="color:#FF0000;">e</span><span style="color:#7030a0;">.empno, </span><span style="color:#FF0000;">e</span><span style="color:#7030a0;">.ename, </span><span style="color:#FF0000;">d</span><span style="color:#7030a0;">.deptno from emp </span><span style="color:#FF0000;">e </span><span style="color:#7030a0;">join dept </span><span style="color:#FF0000;">d </span><span style="color:#7030a0;">on e.deptno = d.deptno;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>内连接</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">内连接：只有进行连接的两个表中都存在与连接条件相匹配的数据才会被保留下来。</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select e.empno, e.ename, d.deptno from emp e </span><span style="color:#FF0000;">join </span><span style="color:#7030a0;">dept d </span><span style="color:#FF0000;">on </span><span style="color:#7030a0;">e.deptno </span><span style="color:#FF0000;">= </span><span style="color:#7030a0;">d.deptno;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>左外连接</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">左外连接：</span><span style="color:#000000;"> JOIN </span><span style="color:#000000;">操作符左边表中符合</span><span style="color:#000000;"> WHERE </span><span style="color:#000000;">子句的所有记录将会被返回。</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select e.empno, e.ename, d.deptno from emp e </span><span style="color:#FF0000;">left join </span><span style="color:#7030a0;">dept d </span><span style="color:#FF0000;">on </span><span style="color:#7030a0;">e.deptno </span><span style="color:#FF0000;">= </span><span style="color:#7030a0;">d.deptno;</span></p>

<h3 style="margin-left:0cm;"><strong>右外连接</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">右外连接：</span><span style="color:#000000;"> JOIN </span><span style="color:#000000;">操作符右边表中符合</span><span style="color:#000000;"> WHERE </span><span style="color:#000000;">子句的所有记录将会被返回。</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select e.empno, e.ename, d.deptno from emp e </span><span style="color:#FF0000;">right join </span><span style="color:#7030a0;">dept d </span><span style="color:#FF0000;">on </span><span style="color:#7030a0;">e.deptno </span><span style="color:#FF0000;">= </span><span style="color:#7030a0;">d.deptno;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>满外连接</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">满外连接：将会返回所有表中符合</span><span style="color:#000000;"> WHERE </span><span style="color:#000000;">语句条件的所有记录。如果任一表的指定字段没有符合条件的值的话，那么就使用</span><span style="color:#000000;"> NULL </span><span style="color:#000000;">值替代。</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select e.empno, e.ename, d.deptno from emp e </span><span style="color:#FF0000;">full join </span><span style="color:#7030a0;">dept d </span><span style="color:#FF0000;">on </span><span style="color:#7030a0;">e.deptno </span><span style="color:#FF0000;">= </span><span style="color:#7030a0;">d.deptno;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>多表连接</strong></h3>

<p style="margin-left:0cm;"><span style="color:#FF0000;">注意：连接</span><span style="color:#FF0000;"> n </span><span style="color:#FF0000;">个表，至少需要</span><span style="color:#FF0000;"> n-1 </span><span style="color:#FF0000;">个连接条件。例如：连接三个表，至少需要两个连接条件。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">0</span><span style="color:#000000;">）数据准备</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;"></span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）创建位置表</span></p>

<table border="1" cellspacing="0" style="margin-left:5.4pt;"><tbody><tr><td style="vertical-align:top;width:411.1pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">create table if not exists default.location(</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">loc int,</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">loc_name string</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">)</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">row format delimited fields terminated by '\t';</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）导入数据</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; load data local inpath '/opt/module/datas/location.txt' into table</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">default.location;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">3</span><span style="color:#000000;">）多表连接查询</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt;SELECT e.ename, d.deptno, l. loc_name</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">FROM emp e</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">JOIN </span><span style="color:#7030a0;">dept d</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">ON </span><span style="color:#7030a0;">d.deptno = e.deptno</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">JOIN </span><span style="color:#7030a0;">location l</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">ON </span><span style="color:#7030a0;">d.loc = l.loc;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">大多数情况下，</span><span style="color:#000000;"> Hive </span><span style="color:#000000;">会对每对</span><span style="color:#000000;"> JOIN </span><span style="color:#000000;">连接对象启动一个</span><span style="color:#000000;"> MapReduce </span><span style="color:#000000;">任务。本例中会首先启动一个</span><span style="color:#000000;"> MapReduce job </span><span style="color:#000000;">对表</span><span style="color:#000000;"> e </span><span style="color:#000000;">和表</span><span style="color:#000000;"> d </span><span style="color:#000000;">进行连接操作，然后会再启动一个</span><span style="color:#000000;"> MapReduce job</span><span style="color:#000000;">将第一个</span><span style="color:#000000;"> MapReduce job </span><span style="color:#000000;">的输出和表</span><span style="color:#000000;"> l;</span><span style="color:#000000;">进行连接操作。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">注意：为什么不是表</span><span style="color:#000000;"> d </span><span style="color:#000000;">和表</span><span style="color:#000000;"> l </span><span style="color:#000000;">先进行连接操作呢？这是因为</span><span style="color:#000000;"> Hive </span><span style="color:#000000;">总是按照从左到右的顺序执行的。</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>笛卡尔积</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）笛卡尔集会在下面条件下产生</span><span style="color:#000000;">:</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）省略连接条件</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）连接条件无效</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）所有表中的所有行互相连接</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select empno, deptno from emp, dept;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">FAILED: SemanticException Column deptno Found in more than One Tables/Subqueries</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>连接谓词中不支持or</strong></h3>

<p style="margin-left:0cm;">       在连接语句中，on子句中不允许使用or连接词；如下示例就是一个错误示例</p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select e.empno, e.ename, d.deptno from emp e </span><span style="color:#FF0000;">join </span><span style="color:#7030a0;">dept d </span><span style="color:#FF0000;">on </span><span style="color:#7030a0;">e.deptno</span><span style="color:#FF0000;">=</span><span style="color:#7030a0;">d.deptno </span><span style="color:#FF0000;">or </span><span style="color:#7030a0;">e.ename=d.ename; </span><span style="color:#FF0000;">错误的</span></p>

<p style="margin-left:0cm;"> </p>

<h2 style="margin-left:0cm;"><strong>查询结果排序(Order By)</strong></h2>

<h3 style="margin-left:0cm;"><strong>全局排序（Order By）</strong></h3>

<p style="margin-left:0cm;"><span style="color:#FF0000;">Order By</span><span style="color:#FF0000;">：全局排序，一个</span><span style="color:#FF0000;"> MapReduce</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）使用</span><span style="color:#000000;"> ORDER BY </span><span style="color:#000000;">子句排序</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">ASC</span><span style="color:#FF0000;">（</span><span style="color:#FF0000;">ascend</span><span style="color:#FF0000;">）</span><span style="color:#FF0000;">: </span><span style="color:#FF0000;">升序（默认）</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">DESC</span><span style="color:#FF0000;">（</span><span style="color:#FF0000;">descend</span><span style="color:#FF0000;">）</span><span style="color:#FF0000;">: </span><span style="color:#FF0000;">降序</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）</span><span style="color:#000000;"> ORDER BY </span><span style="color:#000000;">子句在</span><span style="color:#000000;"> SELECT </span><span style="color:#000000;">语句的结尾。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">3</span><span style="color:#000000;">）案例实操</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）查询员工信息按工资升序排列</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp </span><span style="color:#FF0000;">order by </span><span style="color:#7030a0;">sal;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）查询员工信息按工资降序排列</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp </span><span style="color:#FF0000;">order by </span><span style="color:#7030a0;">sal </span><span style="color:#FF0000;">desc</span><span style="color:#7030a0;">;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>按照别名排序</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">按照员工薪水的</span><span style="color:#000000;"> 2 </span><span style="color:#000000;">倍排序</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select ename, sal*2 </span><span style="color:#FF0000;">twosal </span><span style="color:#7030a0;">from emp </span><span style="color:#FF0000;">order by twosal</span><span style="color:#7030a0;">;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>多个列排序</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">按照部门和工资升序排序</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select ename, deptno, sal from emp </span><span style="color:#FF0000;">order by deptno, sal </span><span style="color:#7030a0;">;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>每个MapReduce内部排序（Sort By）</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">Sort By</span><span style="color:#000000;">：每个</span><span style="color:#000000;"> MapReduce </span><span style="color:#000000;">内部进行排序，对全局结果集来说不是排序。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）设置</span><span style="color:#000000;"> reduce </span><span style="color:#000000;">个数</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; set mapreduce.job.reduces=3;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）查看设置</span><span style="color:#000000;"> reduce </span><span style="color:#000000;">个数</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; set mapreduce.job.reduces;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">3</span><span style="color:#000000;">）根据部门编号降序查看员工信息</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from emp </span><span style="color:#FF0000;">sort by </span><span style="color:#7030a0;">empno desc;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">4</span><span style="color:#000000;">）将查询结果导入到文件中（按照部门编号降序排序）</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; insert overwrite local directory '/opt/module/datas/sortby-result' select * from emp </span><span style="color:#FF0000;">sort by </span><span style="color:#7030a0;">deptno desc;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>分区排序（Distribute By）</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">Distribute By</span><span style="color:#000000;">：类似</span><span style="color:#000000;"> MR </span><span style="color:#000000;">中</span><span style="color:#000000;"> partition</span><span style="color:#000000;">，进行分区，结合</span><span style="color:#000000;"> sort by </span><span style="color:#000000;">使用。</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">注意：</span><span style="color:#FF0000;">Hive </span><span style="color:#FF0000;">要求</span><span style="color:#FF0000;"> DISTRIBUTE BY </span><span style="color:#FF0000;">语句要写在</span><span style="color:#FF0000;"> SORT BY </span><span style="color:#FF0000;">语句之前。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">对于</span><span style="color:#000000;"> distribute by </span><span style="color:#000000;">进行测试，一定要分配多</span><span style="color:#000000;">reduce</span><span style="color:#000000;">进行处理，否则无法看到</span><span style="color:#000000;">distribute by</span><span style="color:#000000;">的效果。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">案例实操：</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）先按照部门编号分区，再按照员工编号降序排序。</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; set mapreduce.job.reduces=3;</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; insert overwrite local directory '/opt/module/datas/distribute-result' select * from emp </span><span style="color:#FF0000;">distribute by </span><span style="color:#7030a0;">deptno </span><span style="color:#FF0000;">sort by </span><span style="color:#7030a0;">empno desc;</span></p>

<p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>Cluster By</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">当</span><span style="color:#000000;"> distribute by </span><span style="color:#000000;">和</span><span style="color:#000000;"> sorts by </span><span style="color:#000000;">字段相同时，可以使用</span><span style="color:#000000;"> cluster by </span><span style="color:#000000;">方式。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">cluster by </span><span style="color:#000000;">除了具有</span><span style="color:#000000;"> distribute by </span><span style="color:#000000;">的功能外还兼具</span><span style="color:#000000;"> sort by </span><span style="color:#000000;">的功能。但是</span><span style="color:#FF0000;">排序只能是倒序排序</span><span style="color:#000000;">，不能指定排序规则为</span><span style="color:#000000;"> ASC </span><span style="color:#000000;">或者</span><span style="color:#000000;"> DESC</span><span style="color:#000000;">。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）以下两种写法等价</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">select * from emp </span><span style="color:#FF0000;">cluster by </span><span style="color:#7030a0;">deptno;</span></p>

<p style="margin-left:0cm;"><span style="color:#7030a0;">select * from emp </span><span style="color:#FF0000;">distribute by </span><span style="color:#7030a0;">deptno </span><span style="color:#FF0000;">sort by </span><span style="color:#7030a0;">deptno;</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">注意：按照部门编号分区，不一定就是固定死的数值，可以是</span><span style="color:#000000;"> 20 </span><span style="color:#000000;">号和</span><span style="color:#000000;"> 30 </span><span style="color:#000000;">号部门分到一个分区里面去。</span></p>

<p style="margin-left:0cm;"> </p>

<h2 style="margin-left:0cm;"><strong>分桶及抽样查询</strong></h2>

<h3 style="margin-left:0cm;"><strong>分桶表数据存储</strong></h3>

<p style="margin-left:0cm;"><span style="color:#FF0000;">分区针对的是数据的存储路径；分桶针对的是数据文件。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区，特别是之前所提到过的要确定合适的划分大小这个疑虑。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">分桶是将数据集分解成更容易管理的若干部分的另一个技术。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">1</span><span style="color:#000000;">）先创建分桶表，通过直接导入数据文件的方式</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">0</span><span style="color:#000000;">）数据准备</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;"></span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）创建分桶表</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">create table stu_buck(id int, name string)</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">clustered by(id)</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">into 4 buckets</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">row format delimited fields terminated by '\t';</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）查看表结构</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; desc formatted stu_buck;</span></p>

			<p style="margin-left:0cm;"><span style="color:#FF0000;">Num Buckets: 4</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）导入数据到分桶表中</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; load data local inpath '/opt/module/datas/student.txt' into table stu_buck;</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">4</span><span style="color:#000000;">）查看创建的分桶表中是否分成</span><span style="color:#000000;"> 4 </span><span style="color:#000000;">个桶发现并没有分成</span><span style="color:#000000;"> 4 </span><span style="color:#000000;">个桶。是什么原因呢？</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;"></span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">2</span><span style="color:#000000;">）创建分桶表时，数据通过子查询的方式导入</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">1</span><span style="color:#000000;">）先建一个普通的</span><span style="color:#000000;"> stu </span><span style="color:#000000;">表</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">create table stu(id int, name string)</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">row format delimited fields terminated by '\t';</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">2</span><span style="color:#000000;">）向普通的</span><span style="color:#000000;"> stu </span><span style="color:#000000;">表中导入数据</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">load data local inpath '/opt/module/datas/student.txt' into table stu;</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">3</span><span style="color:#000000;">）清空</span><span style="color:#000000;"> stu_buck </span><span style="color:#000000;">表中数据</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">truncate table stu_buck;</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">select * from stu_buck;</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">4</span><span style="color:#000000;">）导入数据到分桶表，通过子查询的方式</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">insert into table stu_buck</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">select id, name from stu cluster by(id);</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">5</span><span style="color:#000000;">）发现还是只有一个分桶</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;"></span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">6</span><span style="color:#000000;">）需要设置一个属性</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt;</span><span style="color:#FF0000;">set hive.enforce.bucketing=true;</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; set mapreduce.job.reduces=</span><span style="color:#FF0000;">-1</span><span style="color:#7030a0;">;</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt;insert into table stu_buck</span></p>

			<p style="margin-left:0cm;"><span style="color:#7030a0;">select id, name from stu cluster by(id);</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#000000;"></span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">（</span><span style="color:#000000;">7</span><span style="color:#000000;">）查询分桶的数据</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from stu_buck;</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">OK</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">stu_buck.id  stu_buck.name</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1001       testdata1</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1005       testdata5</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1009       testdata9</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1012       testdata12</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1016       testdata16</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">1002       testdata2</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">1006       testdata6</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">1013       testdata13</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1003       testdata3</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1007       testdata7</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1010       testdata10</span></p>

			<p style="margin-left:0cm;"><span style="color:#2e74b5;">1014       testdata14</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">1004       testdata4</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">1008       testdata8</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">1011       testdata11</span></p>

			<p style="margin-left:0cm;"><span style="color:#000000;">1015       testdata15</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"> </p>

<h3 style="margin-left:0cm;"><strong>分桶抽样查询</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">对于非常大的数据集，有时用户需要使用的是一个具有代表性的查询结果而不是全部结果。</span><span style="color:#000000;"> Hive </span><span style="color:#000000;">可以通过对表进行抽样来满足这个需求。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">查询表</span><span style="color:#000000;"> stu_buck </span><span style="color:#000000;">中的数据。</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from stu_buck </span><span style="color:#FF0000;">tablesample</span><span style="color:#7030a0;">(bucket 1 out of 4 on id);</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#FF0000;">注：</span><span style="color:#FF0000;">tablesample </span><span style="color:#FF0000;">是抽样语句，语法：</span><span style="color:#FF0000;">TABLESAMPLE(BUCKET x OUT OF y) </span><span style="color:#FF0000;">。</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">y</span><span style="color:#000000;">必须是</span><span style="color:#000000;">table</span><span style="color:#000000;">总</span><span style="color:#000000;">bucket</span><span style="color:#000000;">数的倍数或者因子。</span><span style="color:#000000;"> hive</span><span style="color:#000000;">根据</span><span style="color:#000000;">y</span><span style="color:#000000;">的大小，决定抽样的比例。例如，</span><span style="color:#000000;">table</span><span style="color:#000000;">总共分了</span><span style="color:#000000;">4</span><span style="color:#000000;">份，当</span><span style="color:#000000;">y=2</span><span style="color:#000000;">时，抽取</span><span style="color:#000000;">(4/2=)2</span><span style="color:#000000;">个</span><span style="color:#000000;">bucket</span><span style="color:#000000;">的数据，当</span><span style="color:#000000;">y=8</span><span style="color:#000000;">时，抽取</span><span style="color:#000000;">(4/8=)1/2</span><span style="color:#000000;">个</span><span style="color:#000000;">bucket</span><span style="color:#000000;">的数据。</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">x </span><span style="color:#FF0000;">表示从哪个</span><span style="color:#FF0000;">bucket</span><span style="color:#FF0000;">开始抽取</span><span style="color:#000000;">。例如，</span><span style="color:#000000;">table</span><span style="color:#000000;">总</span><span style="color:#000000;">bucket</span><span style="color:#000000;">数为</span><span style="color:#000000;">4</span><span style="color:#000000;">，</span><span style="color:#000000;">tablesample(bucket 4 out of </span><span style="color:#000000;">4)</span><span style="color:#000000;">，表示总共抽取（4/4=）1个 bucket 的数据，抽取第4个bucket的数据。</span></p>

<p style="margin-left:0cm;"><span style="color:#FF0000;">注意：x的值必须小于等于y的值，否则</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">FAILED: SemanticException [Error 10061]: Numerator should not be bigger than</span></p>

<p style="margin-left:0cm;"><span style="color:#000000;">denominator in sample clause for table stu_buck</span></p>

<h3 style="margin-left:0cm;"><strong>数据块抽样</strong></h3>

<p style="margin-left:0cm;"><span style="color:#000000;">Hive </span><span style="color:#000000;">提供了另外一种按照百分比进行抽样的方式，这种是基于行数的，按照输入路径下的数据块百分比进行的抽样。</span></p>

<table border="1" cellspacing="0" style="margin-left:33.75pt;"><tbody><tr><td style="vertical-align:top;width:382.75pt;">
			<p style="margin-left:0cm;"><span style="color:#7030a0;">hive (default)&gt; select * from stu </span><span style="color:#FF0000;">tablesample</span><span style="color:#7030a0;">(0.1 percent) ;</span></p>
			</td>
		</tr></tbody></table><p style="margin-left:0cm;"><span style="color:#FF0000;">提示：这种抽样方式不一定适用于所有的文件格式。另外，这种抽样的最小抽样单元是一个</span><span style="color:#FF0000;"> HDFS </span><span style="color:#FF0000;">数据块。因此，如果表的数据大小小于普通的块大小</span><span style="color:#FF0000;"> 128M </span><span style="color:#FF0000;">的话，那么将会返回所有行。</span><br>
 </p>            </div>
                </div>
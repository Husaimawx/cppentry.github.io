---
layout:     post
title:      Flume的安装与使用详解
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								<div class="article-copyright">
					版权声明：本文为博主原创文章，未经博主允许不得转载。					https://blog.csdn.net/qq_37334135/article/details/78335032				</div>
								            <div id="content_views" class="markdown_views prism-atom-one-dark">
							<!-- flowchart 箭头图标 勿删 -->
							<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path></svg>
							<p><strong>Flume的简单介绍</strong> <br>
Flume是一个分布式、可靠、和高可用的海量日志采集、聚合和传输的系统。 <br>
Flume可以采集文件，socket数据包等各种形式源数据，又可以将采集到的数据输出到HDFS、hbase、hive、kafka等众多外部存储系统中 <br>
Flume的运行机制 <br>
1、Flume分布式系统中最核心的角色是agent，flume采集系统就是由一个个agent所连接起来形成 <br>
2、每一个agent相当于一个数据传递员Source 到 Channel 到 Sink之间传递数据的形式是Event事件；Event事件是一个数据流单元。</p>

<p>内部有三个组件： <br>
a)Source：采集源，用于跟数据源对接，以获取数据 <br>
b)Sink：下沉地，采集数据的传送目的，用于往下一级agent传递数据或者往最终存储系统传递数据 <br>
c)Channel：angent内部的数据传输通道，用于从source将数据传递到sink <br>
单个agent采集数据 <br>
<img src="https://img-blog.csdn.net/20171024192657240?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzczMzQxMzU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""> <br>
多个agent直接串联采集数据 <br>
<img src="https://img-blog.csdn.net/20171024192801269?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzczMzQxMzU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p>

<p><strong>Flume的安装与使用</strong> <br>
安装Flume之前确保安装了hadoop，假设是安装了hadoop的前提下，介绍Flume的安装，其实解压下就行了。 <br>
我这里使用的是apache-flume-1.6.0-bin.tar.gz，上传到linux，解压到指定包即可，我这里解压到了apps这个包，里面放了我解压的hadoo、hive和zookeeper，安装就完了。 <br>
注：其实在conf目录里面需要配置JAVA_HOME,但是我没配置使用也没问题的。如果出现问题了再配置看。</p>

<p><strong>Flume的使用（一）</strong> <br>
这里打算做的是，接收网络传输的数据。也就是flume（安装在mini1）的作用是，然后在mini2这台机器上，发送数据，mini1上能采集到，可以下沉到hdfs（为了方便，这里暂时打印在控制台） <br>
注：为了方便我这里就在mini1这条机器打开两个窗口来进行发送和采集数据了。 <br>
进入到flume的conf目录下，创建文件，进行配置</p>

<pre class="prettyprint"><code class=" hljs avrasm">[root@mini1 ~]<span class="hljs-preprocessor"># cd apps/apache-flume-1.6.0-bin/conf/</span>
[root@mini1 conf]<span class="hljs-preprocessor"># ll</span>
总用量 <span class="hljs-number">28</span>
-rw-r--r--. <span class="hljs-number">1</span>  <span class="hljs-number">501</span> games <span class="hljs-number">1661</span> <span class="hljs-number">5</span>月   <span class="hljs-number">9</span> <span class="hljs-number">2015</span> flume-conf<span class="hljs-preprocessor">.properties</span><span class="hljs-preprocessor">.template</span>
-rw-r--r--. <span class="hljs-number">1</span>  <span class="hljs-number">501</span> games <span class="hljs-number">1110</span> <span class="hljs-number">5</span>月   <span class="hljs-number">9</span> <span class="hljs-number">2015</span> flume-env<span class="hljs-preprocessor">.ps</span>1<span class="hljs-preprocessor">.template</span>
-rw-r--r--. <span class="hljs-number">1</span>  <span class="hljs-number">501</span> games <span class="hljs-number">1214</span> <span class="hljs-number">5</span>月   <span class="hljs-number">9</span> <span class="hljs-number">2015</span> flume-env<span class="hljs-preprocessor">.sh</span><span class="hljs-preprocessor">.template</span>
-rw-r--r--. <span class="hljs-number">1</span>  <span class="hljs-number">501</span> games <span class="hljs-number">3107</span> <span class="hljs-number">5</span>月   <span class="hljs-number">9</span> <span class="hljs-number">2015</span> log4j<span class="hljs-preprocessor">.properties</span>
-rw-r--r--. <span class="hljs-number">1</span> root root   <span class="hljs-number">487</span> <span class="hljs-number">10</span>月 <span class="hljs-number">19</span> <span class="hljs-number">14</span>:<span class="hljs-number">34</span> netcat-logger<span class="hljs-preprocessor">.conf</span>
-rw-r--r--. <span class="hljs-number">1</span> root root   <span class="hljs-number">507</span> <span class="hljs-number">10</span>月 <span class="hljs-number">19</span> <span class="hljs-number">01</span>:<span class="hljs-number">57</span> spool-logger<span class="hljs-preprocessor">.conf</span>
-rw-r--r--. <span class="hljs-number">1</span> root root  <span class="hljs-number">1271</span> <span class="hljs-number">10</span>月 <span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">11</span> tail-hdfs<span class="hljs-preprocessor">.conf</span>
[root@mini1 conf]<span class="hljs-preprocessor"># vi netcat-logger.conf </span>
<span class="hljs-preprocessor"># example.conf: A single-node Flume configuration</span>

<span class="hljs-preprocessor"># Name the components on this agent</span>
<span class="hljs-preprocessor">#给那三个组件取个名字</span>
a1<span class="hljs-preprocessor">.sources</span> = <span class="hljs-built_in">r1</span>
a1<span class="hljs-preprocessor">.sinks</span> = k1
a1<span class="hljs-preprocessor">.channels</span> = c1

<span class="hljs-preprocessor"># Describe/configure the source</span>
<span class="hljs-preprocessor">#类型, 从网络端口接收数据,本机mini1, type=spoolDir采集目录源,目录里有就采</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.type</span> = netcat
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.bind</span> = mini1
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.port</span> = <span class="hljs-number">44444</span>

<span class="hljs-preprocessor"># Describe the sink 日志下沉到log4j,打印在屏幕上</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.type</span> = logger

<span class="hljs-preprocessor"># Use a channel which buffers events in memory</span>
<span class="hljs-preprocessor">#下沉的时候是一批一批的, 下沉的时候是一个个event</span>
Channel参数解释：
<span class="hljs-preprocessor">#capacity：默认该通道中最大的可以存储的event数量 1000条数据(1000个event,source拿到的数据是封装成event事件的)</span>
<span class="hljs-preprocessor">#trasactionCapacity：每次最大可以从source中拿到或者送到sink中的event数量</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.type</span> = memory
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.capacity</span> = <span class="hljs-number">1000</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.transactionCapacity</span> = <span class="hljs-number">100</span>

<span class="hljs-preprocessor"># Bind the source and sink to the channel</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.channels</span> = c1
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.channel</span> = c1</code></pre>

<p>配置好了就可以启动了</p>



<pre class="prettyprint"><code class=" hljs avrasm">[root@mini1 apache-flume-<span class="hljs-number">1.6</span><span class="hljs-number">.0</span>-bin]<span class="hljs-preprocessor"># bin/flume-ng agent --conf conf --conf-file conf/netcat-logger.conf --name a1 -Dflume.root.logger=INFO,console</span>
<span class="hljs-label">Warning:</span> JAVA_HOME is not <span class="hljs-keyword">set</span>!
...
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">00</span>:<span class="hljs-number">13</span>,<span class="hljs-number">317</span> (conf-file-poller-<span class="hljs-number">0</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.node</span><span class="hljs-preprocessor">.Application</span><span class="hljs-preprocessor">.startAllComponents</span>(Application<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">173</span>)] Starting Sink k1
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">00</span>:<span class="hljs-number">13</span>,<span class="hljs-number">318</span> (conf-file-poller-<span class="hljs-number">0</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.node</span><span class="hljs-preprocessor">.Application</span><span class="hljs-preprocessor">.startAllComponents</span>(Application<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">184</span>)] Starting Source <span class="hljs-built_in">r1</span>
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">00</span>:<span class="hljs-number">13</span>,<span class="hljs-number">320</span> (lifecycleSupervisor-<span class="hljs-number">1</span>-<span class="hljs-number">3</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.source</span><span class="hljs-preprocessor">.NetcatSource</span><span class="hljs-preprocessor">.start</span>(NetcatSource<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">150</span>)] Source starting
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">00</span>:<span class="hljs-number">13</span>,<span class="hljs-number">350</span> (lifecycleSupervisor-<span class="hljs-number">1</span>-<span class="hljs-number">3</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.source</span><span class="hljs-preprocessor">.NetcatSource</span><span class="hljs-preprocessor">.start</span>(NetcatSource<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">164</span>)] Created serverSocket:sun<span class="hljs-preprocessor">.nio</span><span class="hljs-preprocessor">.ch</span><span class="hljs-preprocessor">.ServerSocketChannelImpl</span>[/<span class="hljs-number">192.168</span><span class="hljs-number">.25</span><span class="hljs-number">.127</span>:<span class="hljs-number">44444</span>]
</code></pre>

<p>在mini1上重开一个窗口（或者其它机器），发送数据进行测试</p>



<pre class="prettyprint"><code class=" hljs r">[root@mini1 ~]<span class="hljs-comment"># telnet mini1 44444</span>
Trying <span class="hljs-number">192.168</span><span class="hljs-number">.25</span><span class="hljs-number">.127</span><span class="hljs-keyword">...</span>
Connected to mini1.
Escape character is <span class="hljs-string">'^]'</span>.
jinbingmin
OK
haha
OK
oyasumi
OK</code></pre>

<p>发送了三句话。 <br>
注：如果没有telnet命令，做法如下</p>



<pre class="prettyprint"><code class=" hljs lasso">rpm <span class="hljs-attribute">-qa</span> telnet<span class="hljs-attribute">-server</span> 查看有没有安装，没有输出的话，那么执行
yum install telnet<span class="hljs-attribute">-server</span> 　
rpm <span class="hljs-attribute">-qa</span> telnet 来查看telnet<span class="hljs-attribute">-server</span> 安装包有没有安装，如果没有输出，那么执行安装
yum install telnet
退出的话使用ctrl<span class="hljs-subst">+</span><span class="hljs-preprocessor">]</span><span class="hljs-markup">,接着quit</span></code></pre>

<p>再次查看服务端有没有采集到</p>

<pre class="prettyprint"><code class=" hljs css">2017<span class="hljs-tag">-10-20</span> 05<span class="hljs-pseudo">:00</span><span class="hljs-pseudo">:59</span>,699 (<span class="hljs-tag">SinkRunner-PollingRunner-DefaultSinkProcessor</span>) <span class="hljs-attr_selector">[INFO - org.apache.flume.sink.LoggerSink.process(LoggerSink.java:94)]</span> <span class="hljs-tag">Event</span>: <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">headers</span>:<span class="hljs-value">{</span></span></span>} <span class="hljs-tag">body</span>: 6<span class="hljs-tag">A</span> 69 6<span class="hljs-tag">E</span> 62 69 6<span class="hljs-tag">E</span> 67 6<span class="hljs-tag">D</span> 69 6<span class="hljs-tag">E</span> 0<span class="hljs-tag">D</span>                <span class="hljs-tag">jinbingmin</span>. }
2017<span class="hljs-tag">-10-20</span> 05<span class="hljs-pseudo">:01</span><span class="hljs-pseudo">:14</span>,704 (<span class="hljs-tag">SinkRunner-PollingRunner-DefaultSinkProcessor</span>) <span class="hljs-attr_selector">[INFO - org.apache.flume.sink.LoggerSink.process(LoggerSink.java:94)]</span> <span class="hljs-tag">Event</span>: <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">headers</span>:<span class="hljs-value">{</span></span></span>} <span class="hljs-tag">body</span>: 68 61 68 61 0<span class="hljs-tag">D</span>                                  <span class="hljs-tag">haha</span>. }
2017<span class="hljs-tag">-10-20</span> 05<span class="hljs-pseudo">:01</span><span class="hljs-pseudo">:19</span>,421 (<span class="hljs-tag">SinkRunner-PollingRunner-DefaultSinkProcessor</span>) <span class="hljs-attr_selector">[INFO - org.apache.flume.sink.LoggerSink.process(LoggerSink.java:94)]</span> <span class="hljs-tag">Event</span>: <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">headers</span>:<span class="hljs-value">{</span></span></span>} <span class="hljs-tag">body</span>: 6<span class="hljs-tag">F</span> 79 61 73 75 6<span class="hljs-tag">D</span> 69 0<span class="hljs-tag">D</span>      <span class="hljs-tag">oyasumi</span>. }
</code></pre>

<p>发现已经采集到了打印到了控制台</p>

<p><strong>Flume的使用（二）</strong> <br>
这次要做的是监听目录，往目录里面放文件看能否被监听到 <br>
步骤基本跟上面一样，注意是配置文件修改了（主要是改采集源配置），测试方法不一样。 <br>
conf下添加配置文件spooldir-hdfs.conf</p>



<pre class="prettyprint"><code class=" hljs avrasm">[root@mini1 conf]<span class="hljs-preprocessor"># vi spool-logger.conf </span>
<span class="hljs-preprocessor">#Name the components on this agent</span>
a1<span class="hljs-preprocessor">.sources</span> = <span class="hljs-built_in">r1</span>
a1<span class="hljs-preprocessor">.sinks</span> = k1
a1<span class="hljs-preprocessor">.channels</span> = c1
<span class="hljs-preprocessor"># Describe/configure the source</span>
<span class="hljs-preprocessor">#监听目录,spoolDir指定目录, fileHeader要不要给文件加前缀名</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.type</span> = spooldir
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.spoolDir</span> = /root/flumespool
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.fileHeader</span> = true
<span class="hljs-preprocessor"># Describe the sink</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.type</span> = logger
<span class="hljs-preprocessor"># Use a channel which buffers events in memory</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.type</span> = memory
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.capacity</span> = <span class="hljs-number">1000</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.transactionCapacity</span> = <span class="hljs-number">100</span>
<span class="hljs-preprocessor"># Bind the source and sink to the channel</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.channels</span> = c1
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.channel</span> = c1
</code></pre>

<p>启动服务</p>



<pre class="prettyprint"><code class=" hljs avrasm">[root@mini1 apache-flume-<span class="hljs-number">1.6</span><span class="hljs-number">.0</span>-bin]<span class="hljs-preprocessor"># bin/flume-ng agent -c ./conf -f ./conf/spool-logger.conf -n a1 -Dflume.root.logger=INFO,console</span>
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">59</span>,<span class="hljs-number">572</span> (conf-file-poller-<span class="hljs-number">0</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.node</span><span class="hljs-preprocessor">.Application</span><span class="hljs-preprocessor">.startAllComponents</span>(Application<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">173</span>)] Starting Sink k1
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">59</span>,<span class="hljs-number">572</span> (conf-file-poller-<span class="hljs-number">0</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.node</span><span class="hljs-preprocessor">.Application</span><span class="hljs-preprocessor">.startAllComponents</span>(Application<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">184</span>)] Starting Source <span class="hljs-built_in">r1</span>
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">59</span>,<span class="hljs-number">573</span> (lifecycleSupervisor-<span class="hljs-number">1</span>-<span class="hljs-number">3</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.source</span><span class="hljs-preprocessor">.SpoolDirectorySource</span><span class="hljs-preprocessor">.start</span>(SpoolDirectorySource<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">78</span>)] SpoolDirectorySource source starting with directory: /root/flumespool
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">59</span>,<span class="hljs-number">619</span> (lifecycleSupervisor-<span class="hljs-number">1</span>-<span class="hljs-number">3</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.instrumentation</span><span class="hljs-preprocessor">.MonitoredCounterGroup</span><span class="hljs-preprocessor">.register</span>(MonitoredCounterGroup<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">120</span>)] Monitored counter group for type: SOURCE, name: <span class="hljs-built_in">r1</span>: Successfully registered new MBean.
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">23</span>:<span class="hljs-number">59</span>,<span class="hljs-number">619</span> (lifecycleSupervisor-<span class="hljs-number">1</span>-<span class="hljs-number">3</span>) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.instrumentation</span><span class="hljs-preprocessor">.MonitoredCounterGroup</span><span class="hljs-preprocessor">.start</span>(MonitoredCounterGroup<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">96</span>)] Component type: SOURCE, name: <span class="hljs-built_in">r1</span> started
</code></pre>

<p>测试，mini机器上，创建目录/root/flumepool。 <br>
一定文件到该目录下，再查看服务端</p>



<pre class="prettyprint"><code class=" hljs ruby">[root<span class="hljs-variable">@mini1</span> ~]<span class="hljs-comment">#mkdir flumepool</span>
[root<span class="hljs-variable">@mini1</span> ~]<span class="hljs-comment">#vi a.txt </span>
<span class="hljs-number">1</span>,a
<span class="hljs-number">2</span>,b
<span class="hljs-number">3</span>,c
<span class="hljs-number">4</span>,d
<span class="hljs-number">7</span>,y
<span class="hljs-number">8</span>,u
[root<span class="hljs-variable">@mini1</span> ~]<span class="hljs-comment">#mv a.txt flumepool</span></code></pre>

<p>服务端查看输出日志，文件中每行数据这里会输出一行</p>

<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">24</span>:<span class="hljs-number">53</span>,<span class="hljs-number">616</span> (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.sink</span><span class="hljs-preprocessor">.LoggerSink</span><span class="hljs-preprocessor">.process</span>(LoggerSink<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">94</span>)] Event: { headers:{file=/root/flumespool/a<span class="hljs-preprocessor">.txt</span>} body: <span class="hljs-number">31</span> <span class="hljs-number">2</span>C <span class="hljs-number">61</span>                                        <span class="hljs-number">1</span>,a }
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">24</span>:<span class="hljs-number">53</span>,<span class="hljs-number">618</span> (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.sink</span><span class="hljs-preprocessor">.LoggerSink</span><span class="hljs-preprocessor">.process</span>(LoggerSink<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">94</span>)] Event: { headers:{file=/root/flumespool/a<span class="hljs-preprocessor">.txt</span>} body: <span class="hljs-number">32</span> <span class="hljs-number">2</span>C <span class="hljs-number">62</span>                                        <span class="hljs-number">2</span>,b }
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">24</span>:<span class="hljs-number">53</span>,<span class="hljs-number">619</span> (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.sink</span><span class="hljs-preprocessor">.LoggerSink</span><span class="hljs-preprocessor">.process</span>(LoggerSink<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">94</span>)] Event: { headers:{file=/root/flumespool/a<span class="hljs-preprocessor">.txt</span>} body: <span class="hljs-number">33</span> <span class="hljs-number">2</span>C <span class="hljs-number">63</span>                                        <span class="hljs-number">3</span>,c }
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">24</span>:<span class="hljs-number">53</span>,<span class="hljs-number">620</span> (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.sink</span><span class="hljs-preprocessor">.LoggerSink</span><span class="hljs-preprocessor">.process</span>(LoggerSink<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">94</span>)] Event: { headers:{file=/root/flumespool/a<span class="hljs-preprocessor">.txt</span>} body: <span class="hljs-number">34</span> <span class="hljs-number">2</span>C <span class="hljs-number">64</span>                                        <span class="hljs-number">4</span>,d }
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">24</span>:<span class="hljs-number">53</span>,<span class="hljs-number">624</span> (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.sink</span><span class="hljs-preprocessor">.LoggerSink</span><span class="hljs-preprocessor">.process</span>(LoggerSink<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">94</span>)] Event: { headers:{file=/root/flumespool/a<span class="hljs-preprocessor">.txt</span>} body: <span class="hljs-number">37</span> <span class="hljs-number">2</span>C <span class="hljs-number">79</span>                                        <span class="hljs-number">7</span>,<span class="hljs-built_in">y</span> }
<span class="hljs-number">2017</span>-<span class="hljs-number">10</span>-<span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">24</span>:<span class="hljs-number">53</span>,<span class="hljs-number">626</span> (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.flume</span><span class="hljs-preprocessor">.sink</span><span class="hljs-preprocessor">.LoggerSink</span><span class="hljs-preprocessor">.process</span>(LoggerSink<span class="hljs-preprocessor">.java</span>:<span class="hljs-number">94</span>)] Event: { headers:{file=/root/flumespool/a<span class="hljs-preprocessor">.txt</span>} body: <span class="hljs-number">38</span> <span class="hljs-number">2</span>C <span class="hljs-number">75</span>                                        <span class="hljs-number">8</span>,u }
</code></pre>

<p>查看文件名成 了a.txt.COMPLETED</p>

<pre class="prettyprint"><code class=" hljs avrasm">[root@mini1 flumespool]<span class="hljs-preprocessor"># ll</span>
总用量 <span class="hljs-number">8</span>
-rw-r--r--. <span class="hljs-number">1</span> root root <span class="hljs-number">24</span> <span class="hljs-number">10</span>月 <span class="hljs-number">20</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span> a<span class="hljs-preprocessor">.txt</span><span class="hljs-preprocessor">.COMPLETED</span>
</code></pre>

<p><strong>Flume的使用（三）</strong> <br>
采集数据到hdfs</p>

<p>这里要添加的配置文件里面的采集源和下沉地就都有变化了。</p>



<pre class="prettyprint"><code class=" hljs avrasm">[root@mini1 conf]<span class="hljs-preprocessor"># vi tail-hdfs.conf </span>
<span class="hljs-preprocessor"># Name the components on this agent</span>
a1<span class="hljs-preprocessor">.sources</span> = <span class="hljs-built_in">r1</span>
a1<span class="hljs-preprocessor">.sinks</span> = k1
a1<span class="hljs-preprocessor">.channels</span> = c1
<span class="hljs-preprocessor">#exec 指的是命令</span>
<span class="hljs-preprocessor"># Describe/configure the source</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.type</span> = exec
<span class="hljs-preprocessor">#F根据文件名追中, f根据文件的nodeid追中</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.command</span> = tail -F /root/log/test<span class="hljs-preprocessor">.log</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.channels</span> = c1
<span class="hljs-preprocessor"># Describe the sink</span>
<span class="hljs-preprocessor">#下沉目标</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.type</span> = hdfs
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.channel</span> = c1
<span class="hljs-preprocessor">#指定目录, flum帮做目的替换</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.path</span> = /flume/events/%<span class="hljs-built_in">y</span>-%m-%d/%H%M/
<span class="hljs-preprocessor">#文件的命名, 前缀</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.filePrefix</span> = events-
<span class="hljs-preprocessor">#10 分钟就改目录</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.round</span> = true
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.roundValue</span> = <span class="hljs-number">10</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.roundUnit</span> = minute
<span class="hljs-preprocessor">#文件滚动之前的等待时间</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.rollInterval</span> = <span class="hljs-number">3</span>
<span class="hljs-preprocessor">#文件滚动的大小限制(bytes)</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.rollSize</span> = <span class="hljs-number">500</span>
<span class="hljs-preprocessor">#写入多少个event数据后滚动文件(事件个数)</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.rollCount</span> = <span class="hljs-number">20</span>
<span class="hljs-preprocessor">#5个事件就往里面写入</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.batchSize</span> = <span class="hljs-number">5</span>
<span class="hljs-preprocessor">#用本地时间格式化目录</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.useLocalTimeStamp</span> = true
<span class="hljs-preprocessor">#下沉后, 生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hdfs</span><span class="hljs-preprocessor">.fileType</span> = DataStream
<span class="hljs-preprocessor"># Use a channel which buffers events in memory</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.type</span> = memory
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.capacity</span> = <span class="hljs-number">1000</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.transactionCapacity</span> = <span class="hljs-number">100</span>
<span class="hljs-preprocessor"># Bind the source and sink to the channel</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.channels</span> = c1
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.channel</span> = c1
</code></pre>

<p>现在就创建目录/root/log <br>
往文件test.log里面不断写数据，去页面查看是不是输出到了hdfs。</p>



<pre class="prettyprint"><code class=" hljs mel">[root<span class="hljs-variable">@mini1</span> ~]# mkdir <span class="hljs-keyword">log</span>
[root<span class="hljs-variable">@mini1</span> ~]# <span class="hljs-keyword">while</span> true
&gt; <span class="hljs-keyword">do</span>
&gt; echo <span class="hljs-number">1111111111111</span> &gt;&gt; /root/<span class="hljs-keyword">log</span>/test.<span class="hljs-keyword">log</span>
&gt; sleep <span class="hljs-number">0.5</span>
&gt; done

换个窗口
[root<span class="hljs-variable">@mini1</span> ~]# cd <span class="hljs-keyword">log</span>/
[root<span class="hljs-variable">@mini1</span> <span class="hljs-keyword">log</span>]# ll
总用量 <span class="hljs-number">4</span>
-rw-r--r--. <span class="hljs-number">1</span> root root <span class="hljs-number">938</span> <span class="hljs-number">10</span>月 <span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">13</span> test.<span class="hljs-keyword">log</span>
[root<span class="hljs-variable">@mini1</span> <span class="hljs-keyword">log</span>]# tail -F test.<span class="hljs-keyword">log</span> 
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
不断增加</code></pre>

<p>启动服务</p>



<pre class="prettyprint"><code class=" hljs ruby">[root<span class="hljs-variable">@mini1</span> apache-flume-<span class="hljs-number">1.6</span>.<span class="hljs-number">0</span>-bin]<span class="hljs-comment"># bin/flume-ng agent -c conf -f conf/tail-hdfs.conf -n a1;</span></code></pre>

<p>去页面查看 <br>
<img src="https://img-blog.csdn.net/20171024205557226?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzczMzQxMzU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""> <br>
创建的目录格式就是我们指定的，该目录下会不断创建文件（每三秒），文件名前缀也是我们指定的。另外每个10分钟会重新创建个文件夹比如1530。</p>

<p><strong>Flume的使用（四）</strong> <br>
多个agent连接。这里就用两个为例 <br>
两台机器上都要安装flume，由于mini1安装了，那么只需要在mini2上安装flume了。 <br>
就是两个agent，其中一个的下沉地下沉的数据就被另一个的采集源所采集，然后这里为了简便就打印在控制台。 <br>
mini1机器，进入flume的conf目录 <br>
编辑文件</p>



<pre class="prettyprint"><code class=" hljs avrasm">[root@mini1 apache-flume-<span class="hljs-number">1.6</span><span class="hljs-number">.0</span>-bin]<span class="hljs-preprocessor"># vi avro-logger.conf</span>
<span class="hljs-preprocessor"># Name the components on this agent</span>
a1<span class="hljs-preprocessor">.sources</span> = <span class="hljs-built_in">r1</span>
a1<span class="hljs-preprocessor">.sinks</span> = k1
a1<span class="hljs-preprocessor">.channels</span> = c1

<span class="hljs-preprocessor"># Describe/configure the source</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.type</span> = exec
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.command</span> = tail -F /root/log/test<span class="hljs-preprocessor">.log</span>

<span class="hljs-preprocessor"># Describe the sink</span>
<span class="hljs-preprocessor">#绑定的不是本机, 是另外一台机器的服务地址, sink端的avro是一个发送端</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.type</span> = avro
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.hostname</span> = mini2
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.port</span> = <span class="hljs-number">4141</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.batch</span>-size = <span class="hljs-number">2</span>

<span class="hljs-preprocessor"># Use a channel which buffers events in memory</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.type</span> = memory
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.capacity</span> = <span class="hljs-number">1000</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.transactionCapacity</span> = <span class="hljs-number">100</span>

<span class="hljs-preprocessor"># Bind the source and sink to the channel</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.channels</span> = c1
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.channel</span> = c1</code></pre>

<p>在mini2上，进入flume的conf目录下</p>

<pre class="prettyprint"><code class=" hljs avrasm">[root@mini2 apache-flume-<span class="hljs-number">1.6</span><span class="hljs-number">.0</span>-bin]<span class="hljs-preprocessor">## vi tail-avro.conf</span>
<span class="hljs-preprocessor"># Name the components on this agent</span>
a1<span class="hljs-preprocessor">.sources</span> = <span class="hljs-built_in">r1</span>
a1<span class="hljs-preprocessor">.sinks</span> = k1
a1<span class="hljs-preprocessor">.channels</span> = c1

<span class="hljs-preprocessor"># Describe/configure the source</span>
<span class="hljs-preprocessor">#source中的avro组件是接收者服务, 绑定本机</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.type</span> = avro
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.channels</span> = c1
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.bind</span> = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.port</span> = <span class="hljs-number">4141</span>

<span class="hljs-preprocessor"># Describe the sink</span>
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.type</span> = logger

<span class="hljs-preprocessor"># Use a channel which buffers events in memory</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.type</span> = memory
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.capacity</span> = <span class="hljs-number">1000</span>
a1<span class="hljs-preprocessor">.channels</span><span class="hljs-preprocessor">.c</span>1<span class="hljs-preprocessor">.transactionCapacity</span> = <span class="hljs-number">100</span>

<span class="hljs-preprocessor"># Bind the source and sink to the channel</span>
a1<span class="hljs-preprocessor">.sources</span><span class="hljs-preprocessor">.r</span>1<span class="hljs-preprocessor">.channels</span> = c1
a1<span class="hljs-preprocessor">.sinks</span><span class="hljs-preprocessor">.k</span>1<span class="hljs-preprocessor">.channel</span> = c1</code></pre>

<p>启动mini2</p>

<pre class="prettyprint"><code class=" hljs ruby">[root<span class="hljs-variable">@mini2</span> apache-flume-<span class="hljs-number">1.6</span>.<span class="hljs-number">0</span>-bin]<span class="hljs-comment">#bin/flume-ng agent -c conf -f conf/avro-logger.conf -n al -Dflume.root.logger=INFO,console</span>
</code></pre>

<p>mini1上发送数据</p>



<pre class="prettyprint"><code class=" hljs perl">[root<span class="hljs-variable">@mini1</span> ~]<span class="hljs-comment"># cd log/</span>
[root<span class="hljs-variable">@mini1</span> <span class="hljs-keyword">log</span>]<span class="hljs-comment"># ll</span>
总用量 <span class="hljs-number">4</span>
-rw-r--r--. <span class="hljs-number">1</span> root root <span class="hljs-number">938</span> <span class="hljs-number">10</span>月 <span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">13</span> test.<span class="hljs-keyword">log</span>
[root<span class="hljs-variable">@mini1</span> <span class="hljs-keyword">log</span>]<span class="hljs-comment"># tail -F test.log </span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span>
<span class="hljs-number">1111111111111</span></code></pre>

<p>启动mini1</p>

<pre class="prettyprint"><code class=" hljs lasso"><span class="hljs-preprocessor">[</span>root@mini1 apache<span class="hljs-attribute">-flume</span><span class="hljs-subst">-</span><span class="hljs-number">1.6</span><span class="hljs-number">.0</span><span class="hljs-attribute">-bin</span><span class="hljs-preprocessor">]</span><span class="hljs-markup">bin/flume-ng agent -c conf -f conf/tail-avro.conf -n al </span></code></pre>

<p>接着能看到mini2上显示连接而且一直打印数据”11111111”</p>

<p>这些配置在官网是先的很清楚的，很多种采集源和下沉地这里就只列这几个。</p>            </div>
						<link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-9e5741c4b9.css" rel="stylesheet">
                </div>
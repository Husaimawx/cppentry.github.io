---
layout:     post
title:      Kafka 使用
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								<div class="article-copyright">
					版权声明：本文为博主原创文章，未经博主允许不得转载。					https://blog.csdn.net/anklean/article/details/80629296				</div>
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;font-size:16px;">Kafka </span><span style="font-family:SimSun, STSong;font-size:16px;">需要搭配</span><span style="font-family:Calibri;font-size:16px;">zookeeper</span><span style="font-family:SimSun, STSong;font-size:16px;">使用。</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;font-size:16px;">下载</span><span style="font-family:SimSun, STSong;font-size:16px;">kafka </span><a href="http://mirror.bit.edu.cn/apache/kafka/1.1.0/kafka_2.11-1.1.0.tgz" rel="nofollow"><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;">http://mirror.bit.edu.cn/apache/kafka/1.1.0/kafka_2.11-1.1.0.tgz</span></a></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;font-size:16px;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;font-size:16px;">下载</span><span style="font-family:SimSun, STSong;font-size:16px;">zookeeper</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><a href="http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz" rel="nofollow"><span style="font-family:SimSun, STSong;text-decoration:underline;">http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz</span></a></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">环境</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">Linuxmint 64bit</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">1. </span><span style="font-family:SimSun, STSong;">搭建</span><span style="font-family:SimSun, STSong;">zookeeper</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">1.1</span><span style="font-family:SimSun, STSong;">上传</span><span style="font-family:Calibri;">zookeeper</span><span style="font-family:SimSun, STSong;">到服务器目录</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">1.2 </span><span style="font-family:SimSun, STSong;">解压缩 </span><span style="font-family:Calibri;">tar -xvf </span><span style="font-family:SimSun, STSong;text-decoration:underline;">zookeeper-3.4.10.tar.gz</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;text-decoration:underline;">1.3 </span><span style="font-family:SimSun, STSong;text-decoration:underline;">进入目录 </span><span style="text-decoration:underline;">cd zookeeper-3.4.10</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;text-decoration:underline;">1.4 </span><span style="font-family:SimSun, STSong;text-decoration:underline;">进入</span><span style="text-decoration:underline;">conf</span><span style="font-family:SimSun, STSong;text-decoration:underline;">目录，复制 </span><span style="text-decoration:underline;">conf-sample.cfg </span><span style="font-family:SimSun, STSong;text-decoration:underline;">为</span><span style="text-decoration:underline;">conf.cfg  cp conf-sample.cfg conf.cfg</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;text-decoration:underline;">1.5 </span><span style="font-family:SimSun, STSong;text-decoration:underline;">启动</span><span style="text-decoration:underline;">zookeeper ../bin/zkServer.sh start &amp;</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">2. </span><span style="font-family:SimSun, STSong;">搭建</span><span style="font-family:SimSun, STSong;">kafka</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">2.1 <span style="font-family:SimSun, STSong;">上传</span><span style="font-family:SimSun, STSong;">kafka</span><span style="font-family:SimSun, STSong;">到服务器目录</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">2.2 <span style="font-family:SimSun, STSong;">解压缩</span><span style="font-family:SimSun, STSong;"> tar -xvf </span><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;">kafka_2.11-1.1.0.tgz</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">2.3 <span style="font-family:SimSun, STSong;">进入目录</span><span style="font-family:SimSun, STSong;"> cd </span><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;">kafka_2.11-1.1.0</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="text-decoration:underline;">2.4 </span><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;">修改</span><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;">config/server.properties</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">broker.id=0</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">listeners=PLAINTEXT://:9092</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">log.dirs=$HOME/kafka-server/log</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">zookeeper.connect=XXX.XXX.XXX.xxx:2181,XXX.XXX.XXX.xxx:2181</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="text-decoration:underline;">2.5 </span><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;"> </span><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;">启动</span><span style="font-family:SimSun, STSong;font-size:16px;text-decoration:underline;">kafka ./bin/kafka-server-start.sh config/server.properties &amp;</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">3. kafka</span><span style="font-family:SimSun, STSong;">的使用</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">3.1 <span style="font-family:SimSun, STSong;">创建</span><span style="font-family:SimSun, STSong;">Topic</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">bin/kafka-topics.sh --zookeeper ZOOKEEPER_SERVER:2181 --create --topic TOPIC_NAME --partitions 1 --replication-factor 2</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">3.2 <span style="font-family:SimSun, STSong;">查看</span><span style="font-family:SimSun, STSong;">Topic</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> bin/kafka-topics.sh --list --zookeeper ZOOKEEPER_SERVER1:2181, ZOOKEEPER_SERVER2:2181</span></div><div style="text-align:left;float:none;"></div><br><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">3.3 <span style="font-family:SimSun, STSong;">查看</span><span style="font-family:SimSun, STSong;">Topic</span><span style="font-family:SimSun, STSong;">属性</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">bin/kafka-topics.sh --zookeeper ZOOKEEPER_SERVER1:2181,ZOOKEEPER_SERVER2:2181 --describe --topic TOPIC_NAME</span></div><br><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">3.4 <span style="font-family:SimSun, STSong;">创建一个消费者</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">bin/kafka-console-consumer.sh --bootstrap-server KAFKA_SERVER1:9092 --topic TOPIC_NAME</span>--from-beginning</div><br><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;">3.5 <span style="font-family:SimSun, STSong;">创建一个生成者</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">另起一个终端，执行</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">bin/kafka-console-producer.sh --broker-list  KAFKA_SERVER1:9092 --topic TOPIC_NAME</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><br></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">输入，在消费者终端中查看结果</span></div><div style="text-align:left;float:none;"></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-indent:28px;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">4. </span><span style="font-family:SimSun, STSong;">出现的问题和解决方式</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">4.1</span><span style="font-family:SimSun, STSong;">启动</span><span style="font-family:Calibri;">kafka</span><span style="font-family:SimSun, STSong;">时出现错误：</span></div><div style="text-align:left;float:none;"></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">在连接的</span><span style="font-family:SimSun, STSong;">zookeeper</span><span style="font-family:SimSun, STSong;">上，已经在运行一个</span><span style="font-family:Calibri;">brokerids=2</span><span style="font-family:SimSun, STSong;">的</span><span style="font-family:Calibri;">kafka</span><span style="font-family:SimSun, STSong;">服务进程了。需要修改</span><span style="font-family:Calibri;">brokerids</span><span style="font-family:SimSun, STSong;">为其他的数字。</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">修改的时候后，需要注意同时修改</span><span style="font-family:SimSun, STSong;"> $(log.dirs)/meta.properties</span><span style="font-family:SimSun, STSong;">中的</span><span style="font-family:Calibri;">borkerids</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">查看哪个运行了</span><span style="font-family:SimSun, STSong;">bokerids=2</span><span style="font-family:SimSun, STSong;">，使用命令</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;font-size:16px;">bin/zookeeper-shell.sh localhost:2181 &lt;&lt;&lt; "get /brokers/ids/2"</span></div><div style="text-align:left;float:none;"></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">4.2</span><span style="font-family:SimSun, STSong;">启动</span><span style="font-family:Calibri;">kafka</span><span style="font-family:SimSun, STSong;">时出现错误：</span><span style="font-family:SimSun, STSong;text-decoration:line-through;">【未解决】</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">zookeper和kafka的版本不匹配，会出现这样的问题。尽量用kafka带的哪个zookeeper，就不会这样了</span></div><div style="text-align:left;float:none;"></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">[2018-05-29 16:08:19,010] ERROR Closing socket for 10.124.142.169:9093-10.124.142.169:15480 because of error (kafka.network.Processor)</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">org.apache.kafka.common.errors.InvalidRequestException: Error getting request for apiKey: 6 and apiVersion: 4</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">Caused by: java.lang.IllegalArgumentException: Invalid version for API key UPDATE_METADATA_KEY: 4</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">4.3</span><span style="font-family:SimSun, STSong;">启动</span><span style="font-family:Calibri;">kafka</span><span style="font-family:SimSun, STSong;">时出现错误：</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">[2018-05-29 15:35:37,274] ERROR Processor got uncaught exception. (kafka.network.Processor)</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">java.lang.ArrayIndexOutOfBoundsException: 18</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">        at org.apache.kafka.common.protocol.ApiKeys.forId(ApiKeys.java:68)</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">[2018-05-29 15:46:59,599] ERROR Closing socket for 10.124.142.169:9093-10.124.142.169:61197 because of error (kafka.network.Processor)</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">org.apache.kafka.common.errors.InvalidRequestException: Error getting request for apiKey: 6 and apiVersion: 4</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">Caused by: java.lang.IllegalArgumentException: Invalid version for API key 6: 4</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">4.4</span><span style="font-family:SimSun, STSong;">查看</span><span style="font-family:Calibri;">Topic</span><span style="font-family:SimSun, STSong;">时</span><span style="font-family:Calibri;">,Leader</span><span style="font-family:SimSun, STSong;">错误：</span><span style="font-family:SimSun, STSong;text-decoration:line-through;">【不知道怎么解决的，自己好了】</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">leader为-1，说明对应的kafka或者zookeeper服务死掉了，这个时候需要去重新启动zookeeper或者kafka服务。</span></div><div style="text-align:left;float:none;"></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">Topic:34_53     PartitionCount:1        ReplicationFactor:2     Configs:</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">        Topic: 34_53    Partition: 0    </span><span style="font-family:SimSun, STSong;">Leader: -1 </span><span style="font-family:SimSun, STSong;">      Replicas: 2,0   Isr: 2,0</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">Topic:34_53     PartitionCount:1        ReplicationFactor:2     Configs:</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">        Topic: 34_53    Partition: 0   </span><span style="font-family:SimSun, STSong;"> Leader: none </span><span style="font-family:SimSun, STSong;">      Replicas: 2,0   Isr:</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;"> </span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">为避免在注销或者屏保的时候，脚本停止运行，需要使用nohup运行脚本程序；单纯的加&amp;只是让程序后台运行，在注销或者屏保的时候，脚本仍然会停止：</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">nohup bin/zookeeper-server-start.sh  config/zookeeper.properties &gt; zookeeper-server.out 2&gt;&amp;1 &amp;</span></div><div style="white-space:pre-wrap;text-align:left;line-height:1.75;font-size:14px;"><span style="font-family:SimSun, STSong;">nohup bin/kafka-server-start.sh config/server.properties &gt; kafka-server.out 2&gt;&amp;1 &amp;</span></div>            </div>
                </div>
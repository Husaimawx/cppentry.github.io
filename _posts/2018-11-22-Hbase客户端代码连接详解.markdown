---
layout:     post
title:      Hbase客户端代码连接详解
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <p>很多人在使用客户端api进行hbase连接的时候，会提出hbase是否有连接池，怎么实现hbase的连接池的问题，更有甚者，许多初学者在开发hbase代码的时候，经常出现hbase连接数的限制等连接问题，归根结底还是对hbase的连接对象Connection不甚了解，下面我们来详细剖析一下hbase的连接对象：</p><p></p><p style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);">常见的使用Connection的错误方法有：<br>（1）自己实现一个Connection对象的资源池，每次使用都从资源池中取出一个Connection对象；<br>（2）每个线程一个Connection对象。<br>（3）每次访问HBase的时候临时创建一个Connection对象，使用完之后调用close关闭连接。<br>从这些做法来看，这些用户显然是把Connection对象当成了单机数据库里面的连接对象来用了。然而，作为一个分布式数据库，HBase客户端需要和多个服务器中的不同服务角色建立连接，所以HBase客户端中的Connection对象并不是简单对应一个socket连接。HBase的API文档当中对Connection的定义是：<br>A cluster connection encapsulating lower level individual connections to actual servers and a connection to zookeeper.</p><p style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);">我们知道，HBase客户端要连接三个不同的服务角色：<br>（1）Zookeeper：主要用于获得meta-region位置，集群Id、master等信息。<br>（2）HBase Master：主要用于执行HBaseAdmin接口的一些操作，例如建表等。<br></p><p>（3）HBase RegionServer：用于读、写数据。</p><p><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);">下图简单示意了客户端与服务器交互的步骤：</span><br></p><p><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/2018050714355684?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzM4MDAzMTcx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></p><p><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);">HBase客户端的Connection包含了对以上三种socket连接的封装。Connection对象和实际的socket连接之间的对应关系如下图：</span><br></span></p><p><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/20180507143649867?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzM4MDAzMTcx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></span></p><p><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">在HBase客户端代码中，真正对应socket连接的是RpcConnection对象。HBase使用PoolMap这种数据结构来存储客户端到HBase服务器之间的连接。PoolMap封装了ConcurrentHashMap&gt;的结构，key是ConnectionId（封装了服务器地址和用户ticket）,value是一个RpcConnection对象的资源池。当HBase需要连接一个服务器时，首先会根据ConnectionId找到对应的连接池，然后从连接池中取出一个连接对象。</span><br style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);"></span></span></p><p><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">HBase中提供了三种资源池的实现，分别是Reusable，RoundRobin和ThreadLocal。具体实现可以通过hbase.client.ipc.pool.type配置项指定，默认为Reusable。连接池的大小也可以通过hbase.client.ipc.pool.size配置项指定，默认为1。</span></span></span></p><p><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;line-height:32px;background-color:rgb(255,255,255);"><span style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);"></span></span></span></p><p style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">从以上分析不难得出，在HBase中Connection类已经实现了对连接的管理功能，所以我们不需要自己在Connection之上再做额外的管理。另外，Connection是线程安全的，而Table和Admin则不是线程安全的，因此正确的做法是一个进程共用一个Connection对象，而在不同的线程中使用单独的Table和Admin对象。</p><pre style="font-family:'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;padding-top:16px;padding-bottom:16px;margin-bottom:16px;line-height:1.45;color:rgb(248,248,242);background-color:rgb(51,51,51);border:1px solid rgb(204,204,204);"><code class="hljs cs" style="font-family:'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;color:rgb(248,248,242);background-color:transparent;margin:0px;border:0px;line-height:inherit;"><span class="hljs-comment" style="color:rgb(117,113,94);"><span class="hljs-doctag">///</span>所有进程共用一个connection对象</span>
connection = ConnectionFactory.createConnection(config);
...
<span class="hljs-comment" style="color:rgb(117,113,94);"><span class="hljs-doctag">///</span>每个线程使用单独的table对象</span>
           Table table = connection.getTable(TableName.valueOf(<span class="hljs-string" style="color:rgb(230,219,116);">"test"</span>));
           <span class="hljs-keyword" style="color:rgb(249,38,114);">try</span> {
                ...
           } <span class="hljs-keyword" style="color:rgb(249,38,114);">finally</span> {
               table.close();
           }</code></pre><p style="color:rgb(36,41,46);font-family:'-apple-system', BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">HBase客户端默认的是连接池大小是1，也就是每个RegionServer 1个连接。如果应用需要使用更大的连接池或指定其他的资源池类型，也可以通过修改配置实现：</p><pre style="font-family:'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;padding-top:16px;padding-bottom:16px;line-height:1.45;color:rgb(248,248,242);background-color:rgb(51,51,51);border:1px solid rgb(204,204,204);margin-bottom:0px;"><code class="hljs cpp" style="font-family:'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:13.6px;color:rgb(248,248,242);background-color:transparent;margin:0px;border:0px;line-height:inherit;">config.<span class="hljs-built_in" style="color:rgb(230,219,116);">set</span>(<span class="hljs-string" style="color:rgb(230,219,116);">"hbase.client.ipc.pool.type"</span>,...);
config.<span class="hljs-built_in" style="color:rgb(230,219,116);">set</span>(<span class="hljs-string" style="color:rgb(230,219,116);">"hbase.client.ipc.pool.size"</span>,...);
connection = ConnectionFactory.createConnection(config);
...</code></pre><br><br>            </div>
                </div>
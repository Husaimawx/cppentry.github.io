---
layout:     post
title:      [hbase案例]从冷备份的hdfs数据中恢复到原来的hbase表
---
<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
								<div class="article-copyright">
					版权声明：欢迎给我留言，多提意见。互相交流、共同进步！					https://blog.csdn.net/qq_31598113/article/details/79565957				</div>
								            <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css">
						<div class="htmledit_views" id="content_views">
                <p><span style="font-size:16px;"><span style="font-family:'宋体';">【</span>hadoop<span style="font-family:'宋体';">版本：</span><span style="font-family:Arial;">2.7.1</span> <span style="font-family:'宋体';">；</span>hbase<span style="font-family:'宋体';">版本：</span><span style="font-family:Arial;">1.1.2</span><span style="font-family:'宋体';">】</span></span></p><p align="justify"><span style="font-family:'微软雅黑';">之前我已经在<span style="font-family:'微软雅黑';">关闭整个</span>hbase<span style="font-family:'微软雅黑';">集群时，通过hadoop distcp对本机群的hbase数据做了个全量冷备份，那么这次要</span></span><span style="font-family:'微软雅黑';">从已有的全量备份文件</span><span style="font-family:'微软雅黑';">中恢复</span><span style="font-family:'DejaVu Sans Mono';">hbase</span><span style="font-family:'微软雅黑';">数据，</span><span style="font-family:'微软雅黑';">需要三步：</span></p><p align="justify"><span style="font-size:16px;"><strong>Step 1. </strong><span style="font-family:'微软雅黑';">使用</span><span style="font-family:'DejaVu Sans Mono';">distcp</span><span style="font-family:'微软雅黑';">命令将所备份的文件拷贝回原来所在</span><span style="font-family:'DejaVu Sans Mono';">HBase</span><span style="font-family:'微软雅黑';">目录就可以</span></span></p><p align="justify"><span style="font-size:16px;"><strong>Step 2. </strong><span style="font-family:'微软雅黑';">确保权限正确，例如有关的</span><span style="font-family:'DejaVu Sans Mono';">HBase</span><span style="font-family:'微软雅黑';">目录和文件的所有者是</span><span style="font-family:'DejaVu Sans Mono';">hbase</span><span style="font-family:'微软雅黑';">用户</span></span></p><p align="justify"><span style="font-size:16px;"><strong>Step 3. </strong>开启hbase集群后，<span style="font-family:'微软雅黑';">修复元数据、分配表数据到有关的</span><span style="font-family:'DejaVu Sans Mono';">region server</span></span></p><p align="justify"><span style="font-size:16px;"><span style="font-family:'DejaVu Sans Mono';"><br></span></span></p><p align="justify"><span style="font-size:16px;"># <span style="font-family:'微软雅黑';">之前冷备份的数据存放在本地</span><span style="font-family:'DejaVu Sans Mono';">hdfs</span><span style="font-family:'微软雅黑';">集群的</span><span style="font-family:'DejaVu Sans Mono';">/backup/bk_20180122</span><span style="font-family:'微软雅黑';">目录下</span></span></p><p align="justify"><span style="font-size:14px;">[hbase@goodMaster-1 ~]$ hdfs dfs -ls /backup/bk_20180122</span></p><p align="justify"><span style="font-size:14px;">Found 1 items</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 21:14 /backup/bk_20180122/data</span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ hdfs dfs -ls /backup/bk_20180122/data/hbase_data/all_info</span></p><p align="justify"><span style="font-size:14px;">Found 11 items</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/chenshan1_test</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/export_import_table_test</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/urls_30</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/urls_7</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/test_1</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/test_2</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/monthly_statistics</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/high_class_users</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/week_jobs_data</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/ios_users</span></p><p align="justify"><span style="font-size:14px;">drwxr-xr-x   - hdfs hdfs          0 2018-01-22 22:12 /backup/bk_20180122/data/hbase_data/all_info/users_info</span></p><p align="justify"><span style="font-size:14px;"> </span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ hdfs dfs -ls /backup/bk_20180122/data/hbase_data/all_info/users_info | wc -l</span></p><p align="justify"><span style="font-size:14px;">25</span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ hdfs dfs -du -h /backup/bk_20180122/data/hbase_data/all_info/ | grep --color users_info</span></p><p align="justify"><span style="font-size:14px;">9.8 G    /backup/bk_20180122/data/hbase_data/all_info/users_info</span></p><p align="justify"><span style="font-size:14px;"><br></span></p><p align="justify"><span style="font-size:16px;"><strong>Step 1.</strong></span><br></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ <span style="color:rgb(255,0,0);">hadoop distcp hdfs://hdfs-ha/backup/bk_20180122/data/hbase_data/all_info/users_info hdfs://hdfs-ha/apps/hbase/data/hbase_data/all_info &gt; ~/distcprecover.log 2&gt;&amp;1 &amp;</span></span></p><p align="justify"><span style="font-size:14px;">[1] 6928</span></p><p align="justify"><span style="font-size:14px;"><br></span></p><p align="justify"><span style="font-size:16px;"><strong>Step 2.</strong></span><br></p><p align="justify"><span style="font-size:16px;"># <span style="font-family:'微软雅黑';">检查权限，必须保证此目录下的文件</span><span style="font-family:'DejaVu Sans Mono';">owner</span><span style="font-family:'微软雅黑';">都是</span><span style="color:rgb(255,0,0);">hbase</span><span style="font-family:'微软雅黑';">用户。若不是则</span>hadoop fs -chown -R hbase:hdfs /apps/hbase</span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ hdfs dfs -ls /apps/hbase | awk '{print $3,$4}' | grep hbase | head -n 2</span></p><p align="justify"><span style="font-size:14px;"><span style="color:rgb(255,0,0);">hbase </span>hdfs</span></p><p align="justify"><span style="font-size:14px;"><span style="color:rgb(255,0,0);">hbase </span>hdfs</span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ hdfs dfs -ls /apps/hbase | awk '{print $3}' | grep hdfs    # 说明owner都是hbase用户而不是hdfs用户</span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ less ~/fix_log</span></p><p align="justify"><span style="font-size:14px;"><br></span></p><p align="justify"><span style="font-size:16px;"><strong>Step 3.</strong></span><br></p><p align="justify"><span style="font-size:16px;"># <span style="font-family:'微软雅黑';">确认权限没问题就在Active Hmaster上修复元数据，还要把表数据重新分配到相关区域</span><span style="font-family:'DejaVu Sans Mono';">(</span><span style="font-family:'微软雅黑';">按照</span><span style="font-family:'DejaVu Sans Mono';">hbase</span><span style="font-family:'微软雅黑';">的相关机制进行分配，具体如何分配的请上网搜</span><span style="font-family:'DejaVu Sans Mono';">)</span></span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ <span style="color:#ff0000;">hbase hbck -fixMeta -fixAssignments "all_info:users_info" &gt; ~/fix_log 2&gt;&amp;1 &amp;</span></span></p><p align="justify"><span style="font-size:14px;">[1] 11747</span></p><p align="justify"><span style="font-size:14px;">[hbase@k<span style="font-size:14px;">goodMaster-1</span> ~]$ jobs</span></p><p align="justify"><span style="font-size:14px;">[1]+  <strong><span style="color:rgb(0,176,80);">Running                 </span></strong>hbase hbck -fixMeta -fixAssignments "all_info:users_info" &gt; ~/fix_log 2&gt;&amp;1 &amp;</span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ jobs</span></p><p align="justify"><span style="font-size:14px;">[1]+  <strong><span style="color:rgb(0,176,80);">Done                    </span></strong>hbase hbck -fixMeta -fixAssignments "all_info:users_info" &gt; ~/fix_log 2&gt;&amp;1</span></p><p align="justify"><span style="font-size:14px;">[hbase@<span style="font-size:14px;">goodMaster-1</span> ~]$ less ~/fix_log    <span style="color:#009900;"># 当出现Deployed on [your_region_server] 相关字样时，说明该表已成功部署到区域服务器</span></span></p><p align="justify"> </p><p align="justify"><span style="font-size:16px;"># <span style="font-family:'微软雅黑';">去</span><span style="font-family:'DejaVu Sans Mono';">hbase shell</span><span style="font-family:'微软雅黑';">验证一下</span></span></p><p align="justify"><span style="font-size:14px;"><span style="color:#ff0000;">hbase(main):003:0&gt; scan "all_info:users_info" , LIMIT =&gt; 3</span></span></p><p align="justify"><span style="font-size:14px;">ROW                                                                  COLUMN+CELL                                                                                                                                                                                              </span></p><p align="justify"><span style="font-size:14px;"> 0                                                                   column=cf:confidence, timestamp=1502878819524, value=1.0                                                                                                                                                 </span></p><p align="justify"><span style="font-size:14px;"> 0                                                                   column=cf:label, timestamp=1502878819524, value=\xE4\xB8\xAD\xE5\x9B\xBD,\xE6\xB1\x9F\xE8\x8B\x8F,\xE6\xB7\xAE\xE5\xAE\x89,,\xE7\x94\xB5\xE4\xBF\xA1                                                     </span></p><p align="justify"><span style="font-size:14px;"> 00000000000000000000000000000000                                    column=cf:confidence, timestamp=10000, value=0.5                                                                                                                                                         </span></p><p align="justify"><span style="font-size:14px;"> 00000000000000000000000000000000                                    column=cf:label, timestamp=10000, value=\xE4\xB8\xAD\xE5\x9B\xBD,\xE5\xB9\xBF\xE4\xB8\x9C,\xE4\xBD\x9B\xE5\xB1\xB1,,\xE7\x94\xB5\xE4\xBF\xA1                                                             </span></p><p align="justify"><span style="font-size:14px;"> 00000051992B3C6B48DF65CFCD00F570                                    column=cf:confidence, timestamp=1502895476079, value=1.0                                                                                                                                                 </span></p><p align="justify"><span style="font-size:14px;"> 00000051992B3C6B48DF65CFCD00F570                                    column=cf:label, timestamp=1502895476079, value=\xE4\xB8\xAD\xE5\x9B\xBD,\xE5\xB9\xBF\xE4\xB8\x9C,\xE7\x8F\xA0\xE6\xB5\xB7,,\xE7\x94\xB5\xE4\xBF\xA1                                                     </span></p><p align="justify"><span style="font-size:14px;">3 row(s) in 0.1810 seconds</span></p><p align="justify"><span style="font-size:14px;"><span style="color:#ff0000;">hbase(main):009:0&gt; count "all_info:users_info", INTERVAL =&gt; 5000000</span></span></p><p align="justify"><span style="font-size:14px;">Current count: 5000000, row: 12CB6A9E9CCD42674CAEBF68CB59B644                                                                                                                                                                                                                 </span></p><p align="justify"><span style="font-size:14px;">Current count: 10000000, row: 2597BB29A9B94ED48D86287575917903                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 15000000, row: 38615F1F568A52017E65EDA1639CFF55                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 20000000, row: 4B2C059D1DA69C5BA780E431F7A88F22                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 25000000, row: 5DF4FAD9697292B6DED164C14D6D19A3                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 30000000, row: 70BBDC41E4C5757FB8D26618F22698F2                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 35000000, row: 8385DC4053D07A1910B815B2D445F6E1                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 40000000, row: 964C61B9B42B41FEDCE8F5073638B483                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 45000000, row: A9126076D2B29BDF5BE335A4B884FA69                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 50000000, row: BBDBF49A21E278D46DB774490C3EABCE                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 55000000, row: CEA6C8772DFA13881224E11D6DDA07F1                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 60000000, row: E16D047C49F58BB525B7AC1128A97009                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">Current count: 65000000, row: F439793A78273DA2D5CC721D9511478D                                                                                                                                                                                                                </span></p><p align="justify"><span style="font-size:14px;">68137879 row(s) in 3468.1140 seconds</span></p><p align="justify"><span style="font-size:14px;"> </span></p><p align="justify"><span style="font-size:14px;">=&gt; 68137879</span></p><p align="justify"><span style="color:rgb(0,176,80);"><span style="font-size:16px;">完成，<span style="font-family:'微软雅黑';">成功恢复</span><span style="font-family:'DejaVu Sans Mono';">hbase</span><span style="font-family:'微软雅黑';">数据</span><span style="font-family:'DejaVu Sans Mono';">。</span></span></span></p>            </div>
                </div>